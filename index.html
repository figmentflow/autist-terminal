<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AUTIST TERMINAL</title>
    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
            background: #0a0a0a;
            color: #e0e0e0;
            line-height: 1.5;
            font-size: 13px;
            letter-spacing: 0.02em;
        }

        /* ========== AUTH PAGE ========== */
        .auth-page {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: #000;
            z-index: 6000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .auth-page.hidden { display: none; }
        .auth-box {
            background: #0a0a0a;
            border: 1px solid #1a1a1a;
            padding: 40px;
            width: 100%;
            max-width: 360px;
        }
        .auth-title {
            font-size: 11px;
            letter-spacing: 0.3em;
            color: #fff;
            margin-bottom: 30px;
            text-align: center;
        }
        .auth-subtitle {
            font-size: 9px;
            color: #444;
            text-align: center;
            margin-bottom: 25px;
            letter-spacing: 0.1em;
        }
        .auth-input {
            width: 100%;
            background: #050505;
            border: 1px solid #1a1a1a;
            color: #e0e0e0;
            padding: 12px 15px;
            font-family: inherit;
            font-size: 11px;
            margin-bottom: 12px;
        }
        .auth-input:focus { outline: none; border-color: #e65c00; }
        .auth-input::placeholder { color: #333; }
        .auth-btn {
            width: 100%;
            background: #e65c00;
            color: #000;
            border: none;
            padding: 12px;
            font-family: inherit;
            font-size: 10px;
            font-weight: 500;
            letter-spacing: 0.15em;
            cursor: pointer;
            margin-top: 8px;
        }
        .auth-btn:hover { background: #ff6b00; }
        .auth-btn:disabled { background: #333; color: #666; cursor: not-allowed; }
        .auth-switch {
            margin-top: 20px;
            text-align: center;
            font-size: 9px;
            color: #444;
        }
        .auth-switch span { color: #e65c00; cursor: pointer; }
        .auth-switch span:hover { text-decoration: underline; }
        .auth-error {
            background: rgba(230, 92, 0, 0.1);
            border: 1px solid #e65c00;
            color: #e65c00;
            padding: 10px;
            font-size: 9px;
            margin-bottom: 15px;
            display: none;
        }
        .user-email {
            font-size: 9px;
            color: #666;
            cursor: pointer;
            padding: 5px 10px;
        }
        .user-email:hover { color: #e65c00; }

        /* ========== EXCHANGE SETTINGS ========== */
        .exchange-settings-modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.95);
            z-index: 7000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        .exchange-settings-modal.active { display: flex; }
        .exchange-settings-box {
            background: #0a0a0a;
            border: 1px solid #1a1a1a;
            padding: 25px;
            width: 100%;
            max-width: 380px;
        }
        .exchange-settings-title {
            font-size: 10px;
            letter-spacing: 0.2em;
            color: #fff;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .exchange-list { display: flex; flex-direction: column; gap: 2px; }
        .exchange-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: #050505;
            border: 1px solid #1a1a1a;
            cursor: pointer;
            transition: all 0.2s;
        }
        .exchange-item:hover { border-color: #333; }
        .exchange-item.active { border-color: #e65c00; background: #0a0a0a; }
        .exchange-item.connected { border-left: 2px solid #e65c00; }
        .exchange-config {
            display: none;
            padding: 15px;
            background: #050505;
            border: 1px solid #1a1a1a;
            border-top: none;
            margin-bottom: 2px;
        }
        .exchange-config.active { display: block; }
        .exchange-actions { display: flex; gap: 8px; margin-top: 10px; }
        .exchange-name {
            font-size: 10px;
            letter-spacing: 0.15em;
            color: #e0e0e0;
        }
        .exchange-status {
            font-size: 8px;
            padding: 2px 6px;
            border-radius: 2px;
        }
        .exchange-status.connected { background: rgba(230,92,0,0.2); color: #e65c00; }
        .exchange-status.disconnected { background: rgba(68,68,68,0.2); color: #555; }
        .exchange-input {
            width: 100%;
            background: #0a0a0a;
            border: 1px solid #1a1a1a;
            color: #e0e0e0;
            padding: 10px 12px;
            font-family: inherit;
            font-size: 10px;
            margin-bottom: 8px;
        }
        .exchange-input:focus { outline: none; border-color: #333; }
        .exchange-input::placeholder { color: #333; }
        .exchange-btn {
            background: #1a1a1a;
            color: #888;
            border: none;
            padding: 8px 12px;
            font-family: inherit;
            font-size: 9px;
            letter-spacing: 0.1em;
            cursor: pointer;
        }
        .exchange-btn:hover { background: #222; color: #e0e0e0; }
        .exchange-btn.primary { background: #e65c00; color: #000; }
        .exchange-btn.primary:hover { background: #ff6b00; }
        .exchange-btn.danger { background: #300; color: #f55; }
        .exchange-btn.danger:hover { background: #400; }
        .exchange-info { font-size: 9px; color: #444; line-height: 1.5; }
        .sync-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 9px;
            color: #666;
            margin-top: 10px;
        }
        .sync-indicator {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #333;
        }
        .sync-indicator.active { background: #e65c00; animation: pulse 1.5s infinite; }
        .sync-indicator.syncing { background: #ff0; animation: pulse 0.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .live-stats-bar {
            background: #050505;
            border: 1px solid #1a1a1a;
            padding: 10px 15px;
            margin-bottom: 15px;
            display: none;
        }
        .live-stats-bar.active { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        .live-stat { display: flex; flex-direction: column; gap: 2px; }
        .live-stat-label { font-size: 8px; color: #444; letter-spacing: 0.1em; }
        .live-stat-value { font-size: 12px; color: #e0e0e0; }
        .live-stat-value.positive { color: #e65c00; }
        .live-stat-value.negative { color: #555; }
        /* Stat breakdown modal */
        .stat-breakdown-modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.95);
            z-index: 7500;
            display: none;
            align-items: center;
            justify-content: center;
        }
        .stat-breakdown-modal.active { display: flex; }
        .stat-breakdown-box {
            background: #0a0a0a;
            border: 1px solid #1a1a1a;
            padding: 25px;
            width: 100%;
            max-width: 500px;
            max-height: 70vh;
            overflow-y: auto;
        }
        .stat-breakdown-title {
            font-size: 11px;
            letter-spacing: 0.2em;
            color: #fff;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .breakdown-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #1a1a1a;
            font-size: 11px;
        }
        .breakdown-label { color: #666; }
        .breakdown-value { color: #e0e0e0; }
        /* Analysis icon for weekly outlook */
        .analysis-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .analysis-icon.correct { background: rgba(230,92,0,0.2); color: #e65c00; border: 1px solid #e65c00; }
        .analysis-icon.incorrect { background: rgba(85,85,85,0.2); color: #555; border: 1px solid #555; }
        .analysis-icon.pending { background: rgba(102,102,102,0.2); color: #666; border: 1px solid #666; }
        .analysis-icon:hover { transform: scale(1.1); }

        /* ========== LANDING PAGE ========== */
        .landing-page {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: #000;
            z-index: 5000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        .landing-page.hidden { display: none; }
        .landing-curve {
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        .landing-title {
            font-size: 12px;
            letter-spacing: 0.3em;
            color: #fff;
            margin-bottom: 50px;
            font-weight: 400;
        }
        .landing-nav {
            display: flex;
            flex-direction: column;
            gap: 6px;
            z-index: 1;
        }
        .landing-nav-item {
            color: #666;
            font-size: 11px;
            letter-spacing: 0.15em;
            padding: 10px 35px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            border: 1px solid transparent;
        }
        .landing-nav-item:hover {
            color: #e65c00;
            border-color: #e65c00;
        }
        .landing-footer {
            position: absolute;
            bottom: 40px;
            color: #333;
            font-size: 10px;
            letter-spacing: 0.2em;
        }

        /* ========== MAIN APP (hidden until nav click) ========== */
        .app-container { display: none; }
        .app-container.active { display: block; }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; }
        input[type="date"] { color: #e0e0e0; width: 140px !important; }
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(0.8); cursor: pointer; }

        .header {
            position: fixed; top: 0; left: 0; right: 0; height: 40px;
            background: #0a0a0a; border-bottom: 1px solid #1a1a1a;
            display: flex; align-items: center; padding: 0 15px; z-index: 1000;
        }
        .menu-icon {
            width: 16px; height: 12px; cursor: pointer;
            display: flex; flex-direction: column; justify-content: space-between;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        .menu-icon:hover { opacity: 1; }
        .menu-icon span { display: block; height: 1px; background: #e65c00; }
        .header-title {
            margin-left: 15px;
            font-size: 10px;
            letter-spacing: 0.2em;
            color: #666;
        }
        .sidebar {
            position: fixed; top: 40px; left: -180px; width: 180px;
            height: calc(100vh - 40px); background: #0a0a0a; border-right: 1px solid #1a1a1a;
            transition: left 0.3s; z-index: 999;
        }
        .sidebar.open { left: 0; }
        .nav-item {
            padding: 12px 15px; cursor: pointer;
            border-bottom: 1px solid #111; color: #555;
            font-size: 10px; letter-spacing: 0.15em;
            transition: all 0.2s;
        }
        .nav-item:hover { background: #111; color: #e65c00; }
        .nav-item.active { color: #e65c00; border-left: 2px solid #e65c00; }
        .main { margin-top: 40px; padding: 15px; max-width: 1400px; margin-left: auto; margin-right: auto; }
        .page { display: none; }
        .page.active { display: block; }

        /* ========== FILTERS & BUTTONS ========== */
        .time-filter { display: flex; gap: 8px; margin-bottom: 20px; justify-content: flex-end; }
        .filter-btn {
            background: transparent; color: #555; border: 1px solid #222;
            padding: 8px 20px; cursor: pointer; font-family: inherit; font-size: 10px;
            letter-spacing: 0.1em; transition: all 0.2s;
        }
        .filter-btn:hover { border-color: #e65c00; color: #e65c00; }
        .filter-btn.active { background: #e65c00; color: #000; border-color: #e65c00; }

        /* ========== STATS GRID ========== */
        .stats-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 1px;
            margin-bottom: 15px; background: #1a1a1a;
        }
        .stat-box { background: #0a0a0a; padding: 10px 8px; text-align: center; transition: background 0.2s; }
        .stat-box:hover { background: #111; }
        .stat-box.clickable { cursor: pointer; }
        .stat-box.clickable:hover { background: #151515; border-color: #e65c00; }
        .stat-label { color: #444; font-size: 7px; margin-bottom: 4px; letter-spacing: 0.12em; }
        .stat-value { color: #e0e0e0; font-size: 15px; font-weight: 500; }
        .stat-value.positive { color: #e65c00; }
        .stat-value.negative { color: #666; }
        .stat-meta { font-size: 7px; color: #333; margin-top: 4px; }

        /* ========== CHART BOX ========== */
        .chart-box { background: #0a0a0a; border: 1px solid #1a1a1a; padding: 15px; margin-bottom: 12px; }
        .chart-title { color: #444; font-size: 9px; margin-bottom: 10px; letter-spacing: 0.15em; }

        /* ========== FORMS ========== */
        .form-box { background: #0a0a0a; border: 1px solid #1a1a1a; padding: 15px; margin-bottom: 12px; }
        .form-section { margin-bottom: 15px; padding-bottom: 12px; border-bottom: 1px solid #111; }
        .section-title {
            color: #e65c00; font-size: 9px; font-weight: 500; margin-bottom: 10px;
            letter-spacing: 0.15em;
        }
        .form-row { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 8px; }
        .form-field { flex: 0 0 auto; }
        .form-field.small { width: 120px; }
        .form-field.medium { width: 180px; }
        .form-field.full { width: 100%; }
        label { display: block; font-size: 8px; color: #444; margin-bottom: 4px; letter-spacing: 0.1em; }
        input, select, textarea {
            width: 100%; background: #050505; border: 1px solid #1a1a1a; color: #e0e0e0;
            padding: 7px 10px; font-family: inherit; font-size: 11px;
            transition: border-color 0.2s;
        }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #e65c00; }
        textarea { resize: vertical; min-height: 60px; }

        button {
            background: #e65c00; color: #000; border: none; padding: 7px 16px;
            cursor: pointer; font-family: inherit; font-size: 10px; font-weight: 500;
            letter-spacing: 0.1em; transition: all 0.2s;
        }
        button:hover { background: #ff6b00; }
        .btn-secondary { background: transparent; color: #666; border: 1px solid #222; }
        .btn-secondary:hover { border-color: #e65c00; color: #e65c00; background: transparent; }
        .btn-draft { background: #1a1a1a; color: #666; border: 1px solid #222; }
        .btn-danger { background: transparent; color: #e65c00; border: 1px solid #e65c00; }
        .btn-danger:hover { background: #e65c00; color: #000; }

        /* ========== TRADE CARDS ========== */
        #tradeList { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 10px; }
        .period-header { grid-column: 1 / -1; }
        .trade-card {
            background: #0a0a0a; border: 1px solid #1a1a1a; padding: 12px;
            cursor: pointer; position: relative; max-width: 380px;
            transition: all 0.2s;
        }
        .trade-card:hover { border-color: #333; }
        .trade-card.win { border-left: 2px solid #e65c00; }
        .trade-card.loss { border-left: 2px solid #333; }
        .trade-card.breakeven { border-left: 2px solid #222; }
        .trade-card.draft { border-left: 2px solid #444; opacity: 0.7; }
        .trade-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .trade-ticker { font-size: 13px; font-weight: 500; color: #e0e0e0; }
        .trade-meta { display: flex; gap: 10px; font-size: 10px; color: #444; flex-wrap: wrap; }
        .trade-details { display: none; margin-top: 10px; padding-top: 10px; border-top: 1px solid #1a1a1a; font-size: 10px; }
        .trade-card.expanded .trade-details { display: block; }
        .trade-card.expanded { grid-column: 1 / -1; max-width: 100%; }
        .detail-row { margin-bottom: 5px; }
        .detail-label { color: #444; }
        .detail-value { color: #999; }

        /* ========== TAGS ========== */
        .tags { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px; }
        .tag {
            background: transparent; border: 1px solid #222; padding: 4px 10px;
            font-size: 8px; cursor: pointer; letter-spacing: 0.1em;
            color: #555; transition: all 0.2s;
        }
        .tag:hover { border-color: #e65c00; color: #e65c00; }
        .tag.selected { background: #e65c00; color: #000; border-color: #e65c00; }

        /* ========== MODALS ========== */
        .modal {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.95); z-index: 2000; padding: 30px; overflow-y: auto;
        }
        .modal.active { display: block; }
        .modal-content { max-width: 800px; margin: 0 auto; background: #0a0a0a; border: 1px solid #1a1a1a; padding: 20px; }
        .modal-header { display: flex; justify-content: space-between; margin-bottom: 15px; border-bottom: 1px solid #1a1a1a; padding-bottom: 10px; }
        .modal-header h2 { font-size: 11px; letter-spacing: 0.2em; font-weight: 500; color: #e65c00; }

        input[type="range"] { -webkit-appearance: none; width: 100%; height: 4px; background: #1a1a1a; margin: 12px 0; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; background: #e65c00; border-radius: 50%; cursor: pointer; }
        .range-display { text-align: center; font-size: 16px; font-weight: 500; color: #e65c00; }

        /* ========== TICKER GRID ========== */
        .ticker-grid { display: flex; flex-wrap: wrap; gap: 8px; }
        .ticker-box {
            background: #0a0a0a; border: 1px solid #1a1a1a; padding: 10px 14px;
            cursor: pointer; font-weight: 500; min-width: 80px; text-align: center;
            transition: all 0.2s; color: #e0e0e0; font-size: 11px;
        }
        .ticker-box.positive { border-color: #e65c00; color: #e65c00; }
        .ticker-box.negative { border-color: #333; color: #555; }
        .ticker-box .ticker-details {
            display: none; margin-top: 8px; padding-top: 8px;
            border-top: 1px solid #1a1a1a; font-size: 9px; text-align: left;
            font-weight: normal; color: #666;
        }
        .ticker-box.expanded .ticker-details { display: block; }
        .ticker-box.expanded { min-width: 140px; }

        .insight { background: #0a0a0a; border-left: 2px solid #e65c00; padding: 10px; margin-bottom: 8px; }
        .insight-title { font-weight: 500; margin-bottom: 5px; font-size: 10px; color: #e0e0e0; }
        .insight-text { font-size: 10px; color: #555; }

        .ratio-ring { width: 50px; height: 50px; position: relative; margin: 0 auto; }
        .ratio-ring svg { transform: rotate(-90deg); }
        .ratio-ring-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 10px; font-weight: 500; white-space: nowrap; }

        .stat-box.clickable { cursor: pointer; }
        .stat-box.clickable:hover { background: #111; }

        #chartContainer { width: 100%; height: 220px; position: relative; }
        canvas { display: block; }
        .chart-tooltip {
            position: absolute; background: #0a0a0a; border: 1px solid #e65c00;
            padding: 10px; font-size: 11px; pointer-events: none; display: none; z-index: 100;
        }

        /* ========== WEEKLY JOURNAL ========== */
        .week-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .delete-week-btn { background: transparent; color: #e65c00; border: 1px solid #e65c00; padding: 5px 10px; cursor: pointer; font-size: 9px; }
        .day-toggle { border: 1px solid #1a1a1a; margin-bottom: 5px; }
        .day-header {
            padding: 10px 14px; cursor: pointer; background: #0f0f0f;
            font-weight: 500; font-size: 10px; letter-spacing: 0.1em;
            transition: background 0.2s;
        }
        .day-header:hover { background: #151515; }
        .day-content { display: none; padding: 10px 14px; background: #0a0a0a; }
        .day-toggle.open .day-content { display: block; }
        .period-header { background: #0f0f0f; padding: 8px 12px; margin: 12px 0 8px 0; font-weight: 500; font-size: 10px; letter-spacing: 0.1em; color: #e65c00; }

        /* ========== BIAS TRACKER ========== */
        .bias-tracker { background: #0f0f0f; border: 1px solid #1a1a1a; padding: 12px; margin-top: 12px; }
        .bias-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .bias-fields { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px; }
        .bias-field { flex: 0 0 auto; }
        .bias-field.small { width: 100px; }
        .bias-field.medium { width: 160px; }
        .bias-field.full { width: 100%; }
        .bias-result { padding: 12px; margin-top: 10px; border: 1px solid #1a1a1a; }
        .bias-result.correct { border-color: #e65c00; background: rgba(230,92,0,0.05); }
        .bias-result.incorrect { border-color: #333; background: rgba(51,51,51,0.1); }
        .bias-result.pending { border-color: #444; background: rgba(68,68,68,0.1); }
        .price-display { display: flex; gap: 12px; margin: 10px 0; flex-wrap: wrap; }
        .price-box { padding: 10px; background: #050505; border: 1px solid #1a1a1a; text-align: center; min-width: 80px; }
        .price-label { font-size: 8px; color: #444; margin-bottom: 4px; letter-spacing: 0.1em; }
        .price-value { font-size: 13px; font-weight: 500; color: #e0e0e0; }
        .bias-summary-box { background: #0a0a0a; border: 1px solid #1a1a1a; padding: 12px; margin-bottom: 12px; }
        .bias-summary-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 8px; }
        .bias-week-card { background: #0f0f0f; border: 1px solid #1a1a1a; padding: 10px; font-size: 10px; }
        .bias-week-card.correct { border-left: 2px solid #e65c00; }
        .bias-week-card.incorrect { border-left: 2px solid #333; }
        .bias-week-card.pending { border-left: 2px solid #444; }

        @media (max-width: 800px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .landing-nav-item { padding: 10px 30px; font-size: 12px; }
        }
    </style>
</head>
<body>
    <!-- AUTH PAGE - HIDDEN (auth removed for personal use) -->
    <div class="auth-page hidden" id="authPage">
        <div class="auth-box">
            <div class="auth-title">AUTIST TERMINAL</div>
            <div class="auth-subtitle">TRADING JOURNAL</div>
            <div class="auth-error" id="authError"></div>

            <!-- Login Form -->
            <div id="loginForm">
                <input type="email" class="auth-input" id="loginEmail" placeholder="EMAIL">
                <input type="password" class="auth-input" id="loginPassword" placeholder="PASSWORD">
                <button class="auth-btn" onclick="handleLogin()">SIGN IN</button>
                <div class="auth-switch">
                    DON'T HAVE AN ACCOUNT? <span onclick="showSignup()">SIGN UP</span>
                </div>
            </div>

            <!-- Signup Form -->
            <div id="signupForm" style="display:none;">
                <input type="email" class="auth-input" id="signupEmail" placeholder="EMAIL">
                <input type="password" class="auth-input" id="signupPassword" placeholder="PASSWORD (MIN 6 CHARS)">
                <input type="password" class="auth-input" id="signupConfirm" placeholder="CONFIRM PASSWORD">
                <button class="auth-btn" onclick="handleSignup()">CREATE ACCOUNT</button>
                <div class="auth-switch">
                    ALREADY HAVE AN ACCOUNT? <span onclick="showLogin()">SIGN IN</span>
                </div>
            </div>
        </div>
    </div>

    <!-- LANDING PAGE -->
    <div class="landing-page" id="landingPage">
        <svg class="landing-curve" id="landingCurveSvg" viewBox="0 0 1920 1080" preserveAspectRatio="none">
            <defs>
                <filter id="glow" x="-100%" y="-100%" width="300%" height="300%">
                    <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
                    <feMerge>
                        <feMergeNode in="coloredBlur"/>
                        <feMergeNode in="SourceGraphic"/>
                    </feMerge>
                </filter>
            </defs>
            <path id="pnlCurve" fill="none" stroke="#e65c00" stroke-width="1.5" opacity="0.45" stroke-linejoin="round" stroke-linecap="round" d="" />
            <circle id="pnlDot" cx="0" cy="0" r="4" fill="#e65c00" filter="url(#glow)">
                <animate attributeName="opacity" values="0.6;1;0.6" dur="2s" repeatCount="indefinite"/>
                <animate attributeName="r" values="3;6;3" dur="2s" repeatCount="indefinite"/>
            </circle>
        </svg>
        <script>
        (function generateBTCCurve() {
            // BTC price data Jan 2022 - Jan 2025 with more granular swings
            const btcData = [
                47000, 44000, 37000, 42000, 39000, 46000, 41000, 35000, 40000, 32000, 29000, 24000, 20000, 17500, 21000, 19000, 24000, 22000, 19500, 17000, 16500, // 2022 crash
                17500, 19000, 21000, 23500, 21000, 24000, 28000, 26000, 30000, 27000, 25000, 27500, 26000, 29000, 27000, 25500, 28000, 31000, 29000, 34000, 32000, 37000, 42000, // 2023 recovery
                44000, 48000, 43000, 52000, 49000, 58000, 62000, 68000, 73000, 67000, 61000, 58000, 64000, 69000, 63000, 58000, 54000, 59000, 64000, 61000, 67000, 72000, 69000, 78000, 85000, 80000, 92000, 97000, // 2024 bull
                103000, 98000, 108000, 102000, 110000 // 2025 ATH
            ];

            const width = 1920, height = 1080;
            const padding = 80;
            const maxPrice = 115000;
            const minPrice = 15000;
            const priceRange = maxPrice - minPrice;

            // More points for jagged look
            const numPoints = 800;
            const points = [];

            for (let i = 0; i < numPoints; i++) {
                const progress = i / (numPoints - 1);
                const dataIndex = progress * (btcData.length - 1);
                const lowIndex = Math.floor(dataIndex);
                const highIndex = Math.min(lowIndex + 1, btcData.length - 1);
                const t = dataIndex - lowIndex;

                // Interpolate between data points
                let price = btcData[lowIndex] + (btcData[highIndex] - btcData[lowIndex]) * t;

                // Add jagged noise - more volatile
                const volatility = 2500 + (progress * 4000); // More volatile as price goes up
                price += (Math.random() - 0.5) * volatility;

                // Occasional sharp spikes
                if (Math.random() < 0.03) {
                    price += (Math.random() - 0.5) * 8000;
                }

                const x = padding + (i / (numPoints - 1)) * (width - padding * 2);
                const y = height - padding - ((price - minPrice) / priceRange) * (height - padding * 2);

                points.push({ x, y });
            }

            // Very light smoothing to keep jagged look
            const smoothed = [];
            for (let i = 0; i < points.length; i++) {
                if (i < 1 || i > points.length - 2) {
                    smoothed.push(points[i]);
                } else {
                    smoothed.push({
                        x: points[i].x,
                        y: (points[i-1].y * 0.15 + points[i].y * 0.7 + points[i+1].y * 0.15)
                    });
                }
            }

            // Build path
            let d = `M${smoothed[0].x.toFixed(1)},${smoothed[0].y.toFixed(1)}`;
            for (let i = 1; i < smoothed.length; i++) {
                d += ` L${smoothed[i].x.toFixed(1)},${smoothed[i].y.toFixed(1)}`;
            }

            document.getElementById('pnlCurve').setAttribute('d', d);

            // Position dot at end
            const lastPoint = smoothed[smoothed.length - 1];
            document.getElementById('pnlDot').setAttribute('cx', lastPoint.x);
            document.getElementById('pnlDot').setAttribute('cy', lastPoint.y);
        })();
        </script>
        <div class="landing-title">AUTIST TERMINAL</div>
        <nav class="landing-nav">
            <div class="landing-nav-item" onclick="enterApp('dashboard')">DASHBOARD</div>
            <div class="landing-nav-item" onclick="enterApp('trades')">TRADES</div>
            <div class="landing-nav-item" onclick="enterApp('weekly')">OUTLOOK</div>
            <div class="landing-nav-item" onclick="enterApp('missed')">MISSED OPP</div>
            <div class="landing-nav-item" onclick="enterApp('analytics')">ANALYTICS</div>
        </nav>
        <div class="landing-footer">TRADING JOURNAL</div>
    </div>

    <!-- MAIN APP CONTAINER -->
    <div class="app-container" id="appContainer">
        <div class="header">
            <div class="menu-icon" onclick="toggleMenu()"><span></span><span></span><span></span></div>
            <span class="header-title" onclick="goToLanding()" style="cursor:pointer;">AUTIST TERMINAL</span>
            <div style="margin-left: auto; display: flex; gap: 15px; align-items: center;">
                <select id="accountSelector" onchange="switchAccount()" style="background:#050505;color:#999;border:1px solid #1a1a1a;padding:8px 12px;font-family:inherit;font-size:10px;letter-spacing:0.1em;">
                    <option value="default">ACCOUNT 1</option>
                </select>
                <button onclick="showAccountModal()" class="btn-secondary">MANAGE</button>
                <button onclick="showExchangeSettings()" class="btn-secondary" style="color:#e65c00;">API</button>
                <span id="userEmail" class="user-email" style="display:none;"></span>
                <button id="logoutBtn" onclick="handleLogout()" class="btn-secondary" style="display:none;">LOGOUT</button>
            </div>
        </div>

        <div class="sidebar" id="sidebar">
            <div class="nav-item active" onclick="showPage('dashboard', this)">DASHBOARD</div>
            <div class="nav-item" onclick="showPage('trades', this)">TRADES</div>
            <div class="nav-item" onclick="showPage('weekly', this)">OUTLOOK</div>
            <div class="nav-item" onclick="showPage('missed', this)">MISSED OPP</div>
            <div class="nav-item" onclick="showPage('analytics', this)">ANALYTICS</div>
        </div>

    <div id="accountModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ACCOUNT MANAGEMENT</h2>
                <button onclick="closeAccountModal()">CLOSE</button>
            </div>
            <div style="margin-bottom: 20px;">
                <label>CREATE NEW ACCOUNT</label>
                <div style="display:flex;gap:10px;margin-top:5px;">
                    <input type="text" id="newAccountName" placeholder="Account Name" style="flex:1;">
                    <input type="number" id="newAccountBalance" placeholder="Balance" style="width:120px;">
                    <button type="button" onclick="createAccount()">CREATE</button>
                </div>
            </div>
            <div style="margin-bottom: 20px;">
                <label>UPDATE CURRENT ACCOUNT BALANCE</label>
                <div style="display:flex;gap:10px;margin-top:5px;">
                    <input type="number" id="updateBalance" placeholder="New Balance" style="flex:1;">
                    <button type="button" onclick="updateAccountBalance()">UPDATE</button>
                </div>
            </div>
            <div id="accountList"></div>
        </div>
    </div>

    <!-- MISSED TRADE MODAL -->
    <div id="missedModal" class="modal">
        <div class="modal-content" style="max-width:500px;max-height:85vh;overflow-y:auto;">
            <div class="modal-header">
                <h2>LOG MISSED TRADE</h2>
                <button onclick="closeMissedModal()">CLOSE</button>
            </div>
            <div class="form-box" style="border:none;padding:0;">
                <div style="display:grid;gap:15px;">
                    <input type="hidden" id="editMissedId">
                    <div>
                        <label>DATE</label>
                        <input type="date" id="missedDate" style="width:100%;">
                    </div>
                    <div>
                        <label>TICKER</label>
                        <input type="text" id="missedTicker" placeholder="BTC, ETH, SOL..." style="width:100%;">
                    </div>
                    <div>
                        <label>DIRECTION</label>
                        <select id="missedDirection" style="width:100%;">
                            <option value="">-- SELECT --</option>
                            <option value="LONG">LONG</option>
                            <option value="SHORT">SHORT</option>
                        </select>
                    </div>
                    <div>
                        <label>POTENTIAL P/L ($)</label>
                        <input type="number" id="missedPnl" placeholder="Estimated profit/loss" style="width:100%;">
                    </div>
                    <div>
                        <label>SCREENSHOTS (click to add multiple)</label>
                        <input type="file" id="missedFile" accept="image/*" multiple style="width:100%;padding:10px;background:#0f0f0f;border:1px solid #1a1a1a;" onchange="previewMissedImages(this)">
                        <div id="missedFilePreview" style="margin-top:10px;display:flex;flex-wrap:wrap;gap:10px;"></div>
                    </div>
                    <div>
                        <label>NOTES</label>
                        <textarea id="missedNote" placeholder="Why did you miss this trade? What was the setup?" style="width:100%;min-height:100px;"></textarea>
                    </div>
                    <div style="display:flex;gap:10px;margin-top:10px;">
                        <button onclick="saveMissedTrade()" style="flex:1;">SAVE</button>
                        <button onclick="closeMissedModal()" class="btn-secondary" style="flex:1;">CANCEL</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- IMAGE VIEWER LIGHTBOX -->
    <div id="imageViewer" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.98);z-index:3000;padding:20px;overflow:auto;">
        <div style="position:absolute;top:20px;right:30px;display:flex;gap:12px;">
            <button onclick="viewPrevImage()" class="btn-secondary" style="padding:10px 20px;">&lt; PREV</button>
            <span id="imageCounter" style="color:#666;padding:10px;"></span>
            <button onclick="viewNextImage()" class="btn-secondary" style="padding:10px 20px;">NEXT &gt;</button>
            <button onclick="closeImageViewer()" style="padding:10px 20px;">CLOSE</button>
        </div>
        <div style="display:flex;justify-content:center;align-items:center;min-height:calc(100vh - 100px);margin-top:50px;">
            <img id="viewerImage" src="" style="max-width:95%;max-height:85vh;object-fit:contain;border:1px solid #1a1a1a;">
        </div>
    </div>

    <!-- EXCHANGE SETTINGS MODAL -->
    <div class="exchange-settings-modal" id="exchangeSettingsModal">
        <div class="exchange-settings-box">
            <div class="exchange-settings-title">
                <span>CONNECT EXCHANGE</span>
                <button class="exchange-btn" onclick="closeExchangeSettings()">CLOSE</button>
            </div>

            <!-- Exchange List (click to expand) -->
            <div class="exchange-list">
                <div class="exchange-item" id="bybitItem" onclick="toggleExchangeConfig('bybit')">
                    <span class="exchange-name">BYBIT</span>
                    <span class="exchange-status disconnected" id="bybitStatus">NOT CONNECTED</span>
                </div>
                <div class="exchange-config" id="bybitConfig">
                    <input type="text" class="exchange-input" id="bybitApiKey" placeholder="API KEY (READ-ONLY)">
                    <input type="password" class="exchange-input" id="bybitApiSecret" placeholder="API SECRET">
                    <div class="exchange-actions">
                        <button class="exchange-btn primary" onclick="connectExchange('bybit')">CONNECT</button>
                        <button class="exchange-btn danger" onclick="disconnectExchange('bybit')" style="display:none;" id="bybitDisconnect">DISCONNECT</button>
                        <button class="exchange-btn" onclick="syncExchange('bybit')" style="display:none;" id="bybitSync">SYNC</button>
                    </div>
                    <div class="sync-status" id="bybitSyncStatus" style="display:none;">
                        <span class="sync-indicator" id="bybitSyncIndicator"></span>
                        <span id="bybitLastSync">Never synced</span>
                    </div>
                </div>

                <div class="exchange-item" id="binanceItem" onclick="toggleExchangeConfig('binance')">
                    <span class="exchange-name">BINANCE FUTURES</span>
                    <span class="exchange-status disconnected" id="binanceStatus">NOT CONNECTED</span>
                </div>
                <div class="exchange-config" id="binanceConfig">
                    <input type="text" class="exchange-input" id="binanceApiKey" placeholder="API KEY (READ-ONLY)">
                    <input type="password" class="exchange-input" id="binanceApiSecret" placeholder="API SECRET">
                    <div class="exchange-actions">
                        <button class="exchange-btn primary" onclick="connectExchange('binance')">CONNECT</button>
                        <button class="exchange-btn danger" onclick="disconnectExchange('binance')" style="display:none;" id="binanceDisconnect">DISCONNECT</button>
                        <button class="exchange-btn" onclick="syncExchange('binance')" style="display:none;" id="binanceSync">SYNC</button>
                    </div>
                    <div class="sync-status" id="binanceSyncStatus" style="display:none;">
                        <span class="sync-indicator" id="binanceSyncIndicator"></span>
                        <span id="binanceLastSync">Never synced</span>
                    </div>
                </div>

                <div class="exchange-item" id="hyperliquidItem" onclick="toggleExchangeConfig('hyperliquid')">
                    <span class="exchange-name">HYPERLIQUID</span>
                    <span class="exchange-status disconnected" id="hyperliquidStatus">NOT CONNECTED</span>
                </div>
                <div class="exchange-config" id="hyperliquidConfig">
                    <input type="text" class="exchange-input" id="hyperliquidWallet" placeholder="WALLET ADDRESS (0x...)">
                    <div class="exchange-actions">
                        <button class="exchange-btn primary" onclick="connectExchange('hyperliquid')">CONNECT</button>
                        <button class="exchange-btn danger" onclick="disconnectExchange('hyperliquid')" style="display:none;" id="hyperliquidDisconnect">DISCONNECT</button>
                        <button class="exchange-btn" onclick="syncExchange('hyperliquid')" style="display:none;" id="hyperliquidSync">SYNC</button>
                    </div>
                    <div class="sync-status" id="hyperliquidSyncStatus" style="display:none;">
                        <span class="sync-indicator" id="hyperliquidSyncIndicator"></span>
                        <span id="hyperliquidLastSync">Never synced</span>
                    </div>
                </div>
            </div>

            <div class="exchange-info" style="margin-top:15px;">
                Use READ-ONLY API keys only. Keys stored locally.
            </div>
        </div>
    </div>

    <div class="main">
        <!-- DASHBOARD -->
        <div id="dashboard" class="page active">
            <!-- Live Stats Bar (shows when exchange connected) -->
            <div class="live-stats-bar" id="liveStatsBar">
                <div class="live-stat">
                    <span class="live-stat-label">EXCHANGE</span>
                    <span class="live-stat-value" id="liveExchange">--</span>
                </div>
                <div class="live-stat">
                    <span class="live-stat-label">BALANCE</span>
                    <span class="live-stat-value" id="liveBalance">--</span>
                </div>
                <div class="live-stat">
                    <span class="live-stat-label">UNREALIZED PNL</span>
                    <span class="live-stat-value" id="liveUnrealizedPnl">--</span>
                </div>
                <div class="live-stat">
                    <span class="live-stat-label">TODAY PNL</span>
                    <span class="live-stat-value" id="liveTodayPnl">--</span>
                </div>
                <div class="live-stat">
                    <span class="live-stat-label">OPEN POSITIONS</span>
                    <span class="live-stat-value" id="livePositions">--</span>
                </div>
                <div style="display:flex;gap:8px;align-items:center;">
                    <span class="sync-indicator" id="liveSyncIndicator"></span>
                    <span style="font-size:9px;color:#444;" id="liveLastUpdate">--</span>
                    <button class="exchange-btn" onclick="refreshLiveStats()" style="padding:5px 10px;">REFRESH</button>
                </div>
            </div>
            <div class="time-filter">
                <button class="filter-btn active" onclick="setFilter('all', this)">OVERALL</button>
                <button class="filter-btn" onclick="setFilter('quarter', this)">QUARTER</button>
                <button class="filter-btn" onclick="setFilter('month', this)">MONTH</button>
                <button class="filter-btn" onclick="setFilter('week', this)">WEEK</button>
            </div>
            <div class="stats-grid" id="statsGrid"></div>
            <div class="chart-box">
                <div class="chart-title">EQUITY CURVE</div>
                <div id="chartContainer"><canvas id="equityChart"></canvas><div class="chart-tooltip" id="chartTooltip"></div></div>
            </div>
            <div class="chart-box">
                <div class="chart-title">SYSTEM ANALYSIS</div>
                <div id="insightsContainer"></div>
            </div>
            <div class="chart-box">
                <div class="chart-title">OUTLOOK BIAS TRACKER</div>
                <div id="biasSummaryContainer"></div>
            </div>
            <div class="chart-box">
                <div class="chart-title">TICKER PERFORMANCE</div>
                <div id="tickerGrid" class="ticker-grid"></div>
            </div>
            <div class="chart-box">
                <div class="chart-title">EXECUTION TRACKER</div>
                <div id="executionTrackerContainer"></div>
            </div>
        </div>

        <!-- TRADES -->
        <div id="trades" class="page">
            <div style="display:flex;justify-content:space-between;margin-bottom:15px;">
                <h2>TRADE JOURNAL</h2>
                <button onclick="showTradeForm()">+ NEW TRADE</button>
            </div>

            <div id="tradeForm" class="form-box" style="display:none;">
                <h3 style="margin-bottom:15px;">NEW TRADE ENTRY</h3>
                <input type="hidden" id="editTradeId">

                <div class="form-section">
                    <div class="section-title">TRADE DETAILS</div>
                    <div class="form-row">
                        <div class="form-field small"><label>ACCOUNT</label><select id="tradeAccount"></select></div>
                        <div class="form-field small"><label>PAIR</label><input type="text" id="pair" placeholder="BTC/USD"></div>
                        <div class="form-field small"><label>DIRECTION</label><select id="direction"><option>LONG</option><option>SHORT</option></select></div>
                        <div class="form-field small"><label>ENTRY TIME</label><input type="date" id="entryTime"></div>
                        <div class="form-field small"><label>EXIT TIME</label><input type="date" id="exitTime"></div>
                        <div class="form-field small"><label>OUTCOME</label><select id="outcome" onchange="updateMAEMFEDisplay()"><option value="">--</option><option>WIN</option><option>LOSS</option><option>BREAKEVEN</option></select></div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="section-title">RISK & RETURNS</div>
                    <div class="form-row">
                        <div class="form-field small"><label>RISK USD</label><input type="number" id="riskAmount" placeholder="100" oninput="calcReturns()"></div>
                        <div class="form-field small"><label>INITIAL RR</label><input type="text" id="initialRR" placeholder="3:1"></div>
                        <div class="form-field small"><label>ACTUAL R</label><input type="number" step="0.01" id="actualR" placeholder="1.5" oninput="calcFromR()"></div>
                        <div class="form-field small"><label>PNL USD</label><input type="number" id="pnlDollar" placeholder="150" oninput="calcFromPnl()"></div>
                        <div class="form-field small"><label>PNL %</label><input type="text" id="pnlPercent" readonly style="background:#111;"></div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="section-title">SETUP</div>
                    <div class="form-row">
                        <div class="form-field small"><label>GRADE</label><select id="setupGrade"><option>A</option><option>B</option><option>C</option><option>D</option><option>F</option></select></div>
                        <div class="form-field medium"><label>CHART IMAGES</label><input type="file" id="chartImage" accept="image/*" multiple onchange="previewTradeImages(this)"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-field full">
                            <div id="tradeImagePreview" style="display:flex;flex-wrap:wrap;gap:10px;margin-top:5px;"></div>
                        </div>
                    </div>
                    <div class="form-field full"><label>REASONING</label><textarea id="reasoning" placeholder="Why did you take this trade?"></textarea></div>
                </div>

                <div class="form-section">
                    <div class="section-title">MAE / MFE</div>
                    <div class="form-row">
                        <div class="form-field small"><label>ENTRY PRICE</label><input type="number" step="0.01" id="entryPrice" oninput="calcMAE()"></div>
                        <div class="form-field small"><label>STOP PRICE</label><input type="number" step="0.01" id="stopPrice" oninput="calcMAE()"></div>
                        <div class="form-field small" id="worstPriceField"><label>WORST PRICE</label><input type="number" step="0.01" id="worstPrice" oninput="calcMAE()"></div>
                        <div class="form-field small" id="bestPriceField"><label>BEST PRICE</label><input type="number" step="0.01" id="bestPrice" oninput="calcMAE()"></div>
                    </div>
                    <div style="display:flex;gap:15px;margin-top:12px;">
                        <div id="maeDisplay" style="flex:1;padding:15px;background:#0f0f0f;border:1px solid #1a1a1a;text-align:center;">
                            <div style="font-size:9px;color:#444;margin-bottom:6px;letter-spacing:0.1em;">MAE (Max Adverse)</div>
                            <div id="maeValue" style="font-size:18px;font-weight:500;color:#e0e0e0;">--</div>
                        </div>
                        <div id="mfeDisplay" style="flex:1;padding:15px;background:#0f0f0f;border:1px solid #1a1a1a;text-align:center;">
                            <div style="font-size:9px;color:#444;margin-bottom:6px;letter-spacing:0.1em;">MFE (Max Favorable)</div>
                            <div id="mfeValue" style="font-size:18px;font-weight:500;color:#e0e0e0;">--</div>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="section-title">IF DID NOTHING</div>
                    <div class="form-field full"><label>OUTCOME IF HELD</label><textarea id="didNothing" placeholder="What would have happened if you didn't exit?"></textarea></div>
                </div>

                <div class="form-section">
                    <div class="section-title">DEMON FINDER</div>
                    <div class="tags" id="demonTags">
                        <div class="tag" onclick="toggleTag(this)">BET TOO SMALL</div>
                        <div class="tag" onclick="toggleTag(this)">ENTERED TOO SOON</div>
                        <div class="tag" onclick="toggleTag(this)">ENTERED TOO LATE</div>
                        <div class="tag" onclick="toggleTag(this)">EXITED TOO LATE</div>
                        <div class="tag" onclick="toggleTag(this)">BET TOO LARGE</div>
                        <div class="tag" onclick="toggleTag(this)">EXITED TOO SOON</div>
                        <div class="tag" onclick="toggleTag(this)">WRONG BIAS</div>
                        <div class="tag" onclick="toggleTag(this)">NOT IN SYSTEM</div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="section-title">EXIT PLAN PRE-ENTRY</div>
                    <div class="form-field full"><label>STRATEGY</label><textarea id="exitPlan" placeholder="What was your exit plan before entering?"></textarea></div>
                </div>

                <div class="form-section">
                    <div class="section-title">PROCESS</div>
                    <div class="form-field medium">
                        <label>SCORE 1-10</label>
                        <input type="range" min="1" max="10" value="5" id="processScore" oninput="updateSlider(this, 'processVal')">
                        <div class="range-display" id="processVal">5</div>
                    </div>
                    <div class="form-row">
                        <div class="form-field small"><label>FOLLOWED PLAN</label><select id="followedPlan"><option>YES</option><option>PARTIAL</option><option>NO</option></select></div>
                    </div>
                    <div class="form-field full"><label>WHAT WENT WRONG</label><textarea id="wrongAction"></textarea></div>
                    <div class="form-field full"><label>CAUSE OF NEGATIVE</label><textarea id="negCause"></textarea></div>
                    <div class="form-field full"><label>IMPROVEMENT</label><textarea id="improvement"></textarea></div>
                </div>

                <div class="form-section">
                    <div class="section-title">CONVICTION JOURNAL</div>
                    <div class="form-field medium">
                        <label>SCORE 1-5</label>
                        <input type="range" min="1" max="5" value="3" id="convictionScore" oninput="updateSlider(this, 'convictionVal')">
                        <div class="range-display" id="convictionVal">3</div>
                    </div>
                    <div class="form-field full"><label>TRUST FACTORS</label><textarea id="trustFactors" placeholder="What made you trust this setup?"></textarea></div>
                    <div class="form-field medium"><label>EMOTIONS PRESENT</label><input type="text" id="emotionsPresent"></div>
                </div>

                <div class="form-section">
                    <div class="section-title">EMOTIONS</div>
                    <div class="form-field full">
                        <label>BEFORE</label>
                        <div class="tags" id="emotionsBefore">
                            <div class="tag" onclick="toggleTag(this)">CALM</div>
                            <div class="tag" onclick="toggleTag(this)">CONFIDENT</div>
                            <div class="tag" onclick="toggleTag(this)">FOMO</div>
                            <div class="tag" onclick="toggleTag(this)">FEAR</div>
                            <div class="tag" onclick="toggleTag(this)">GREED</div>
                            <div class="tag" onclick="toggleTag(this)">UNCERTAIN</div>
                        </div>
                    </div>
                    <div class="form-field full">
                        <label>DURING</label>
                        <div class="tags" id="emotionsDuring">
                            <div class="tag" onclick="toggleTag(this)">CALM</div>
                            <div class="tag" onclick="toggleTag(this)">ANXIOUS</div>
                            <div class="tag" onclick="toggleTag(this)">GREEDY</div>
                            <div class="tag" onclick="toggleTag(this)">FEARFUL</div>
                            <div class="tag" onclick="toggleTag(this)">CONFIDENT</div>
                        </div>
                    </div>
                    <div class="form-field full">
                        <label>AFTER</label>
                        <div class="tags" id="emotionsAfter">
                            <div class="tag" onclick="toggleTag(this)">SATISFIED</div>
                            <div class="tag" onclick="toggleTag(this)">REGRET</div>
                            <div class="tag" onclick="toggleTag(this)">RELIEF</div>
                            <div class="tag" onclick="toggleTag(this)">FRUSTRATED</div>
                            <div class="tag" onclick="toggleTag(this)">PROUD</div>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="section-title">POST TRADE</div>
                    <div class="form-field full"><label>AFTER EXIT</label><textarea id="afterExit" placeholder="What happened after you exited?"></textarea></div>
                    <div class="form-row">
                        <div class="form-field small"><label>EXIT LOGICAL</label><select id="exitLogical"><option>YES</option><option>NO</option></select></div>
                    </div>
                    <div class="form-field full"><label>MANAGE DIFFERENT</label><textarea id="manageDifferent" placeholder="How would you manage this trade differently?"></textarea></div>
                </div>

                <div style="display:flex;gap:8px;margin-top:15px;">
                    <button type="button" onclick="saveTrade(false)">SAVE</button>
                    <button type="button" class="btn-draft" onclick="saveTrade(true)">SAVE DRAFT</button>
                    <button type="button" class="btn-secondary" onclick="hideTradeForm()">CANCEL</button>
                </div>
            </div>

            <div id="tradeList"></div>
        </div>

        <!-- OUTLOOK -->
        <div id="weekly" class="page">
            <div style="display:flex;justify-content:space-between;margin-bottom:15px;">
                <h2>OUTLOOK</h2>
                <button onclick="addWeekEntry()">+ NEW WEEK</button>
            </div>
            <div id="weeklyList"></div>
        </div>

        <!-- MISSED OPPORTUNITIES -->
        <div id="missed" class="page">
            <div style="display:flex;justify-content:space-between;margin-bottom:15px;">
                <h2>MISSED OPPORTUNITIES</h2>
                <button onclick="showMissedModal()">+ LOG MISSED TRADE</button>
            </div>
            <div id="missedList"></div>
        </div>

        <!-- ANALYTICS -->
        <div id="analytics" class="page">
            <h2>ANALYTICS</h2>
            <div class="chart-box">
                <div class="chart-title">USEFUL SITES</div>
                <div style="display:flex;flex-wrap:wrap;gap:10px;padding:10px;">
                    <a href="https://tradingview.com" target="_blank" style="background:#111;border:1px solid #fff;padding:12px 20px;color:#fff;text-decoration:none;font-size:11px;font-weight:bold;display:inline-block;">TRADINGVIEW</a>
                    <a href="https://velodata.app" target="_blank" style="background:#111;border:1px solid #fff;padding:12px 20px;color:#fff;text-decoration:none;font-size:11px;font-weight:bold;display:inline-block;">VELO</a>
                    <a href="https://aggr.trade/rifebtc-full" target="_blank" style="background:#111;border:1px solid #fff;padding:12px 20px;color:#fff;text-decoration:none;font-size:11px;font-weight:bold;display:inline-block;">AGGR.TRADE</a>
                    <a href="https://perpsmoney.com/perps" target="_blank" style="background:#111;border:1px solid #fff;padding:12px 20px;color:#fff;text-decoration:none;font-size:11px;font-weight:bold;display:inline-block;">PERPSMONEY</a>
                    <a href="https://farside.co.uk/btc/" target="_blank" style="background:#111;border:1px solid #fff;padding:12px 20px;color:#fff;text-decoration:none;font-size:11px;font-weight:bold;display:inline-block;">FARSIDE.CO</a>
                </div>
            </div>
            <div class="chart-box">
                <div class="chart-title">COMING SOON</div>
                <p style="color:#555;padding:20px;">Advanced analytics will be added here.</p>
            </div>
        </div>
    </div>
    </div><!-- END APP CONTAINER -->

<script>
// ========== LANDING PAGE ==========
function enterApp(page) {
    document.getElementById('landingPage').classList.add('hidden');
    document.getElementById('appContainer').classList.add('active');

    // Show the requested page
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

    const targetPage = document.getElementById(page);
    if (targetPage) targetPage.classList.add('active');

    const navItems = document.querySelectorAll('.nav-item');
    navItems.forEach(n => {
        if (n.textContent.toLowerCase() === page.toLowerCase()) {
            n.classList.add('active');
        }
    });
}

function goToLanding() {
    document.getElementById('landingPage').classList.remove('hidden');
    document.getElementById('appContainer').classList.remove('active');
    document.getElementById('sidebar').classList.remove('open');
}

// ========== SUPABASE CONFIG ==========
const SUPABASE_URL = 'https://pfxjzrngtxeztljnerzz.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBmeGp6cm5ndHhlenRsam5lcnp6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5OTYxNjMsImV4cCI6MjA4MzU3MjE2M30.v-Wxh6sH_wc8KUVuBzneLx0bKkvq1QTrdd7Bs7JU7XM';

let supabaseClient = null;
let useSupabase = false;
let currentUser = null;

// Try to initialize Supabase
try {
    if (window.supabase && window.supabase.createClient) {
        supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        useSupabase = true;
        console.log('Supabase client initialized');
    }
} catch (e) {
    console.warn('Supabase init failed, using localStorage only:', e);
    useSupabase = false;
}

// ========== AUTH BYPASSED - EFI'S PERSONAL TERMINAL ==========
// Auth removed - this is a single-user app for Efi
const EFI_USER_ID = 'efi-personal';

function showAuthError(msg) { console.log('Auth bypassed:', msg); }
function hideAuthError() {}
function showLogin() {}
function showSignup() {}
async function handleLogin() { await init(); }
async function handleSignup() { await init(); }
async function handleLogout() {
    // Just go back to landing, no actual logout
    document.getElementById('landingPage').classList.remove('hidden');
    document.getElementById('appContainer').classList.remove('active');
}

async function checkAuthState() {
    // Always skip auth page and go directly to app
    document.getElementById('authPage').classList.add('hidden');
    await init();
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', checkAuthState);

// ========== EXCHANGE API INTEGRATION ==========
let exchangeConfigs = {};
let syncIntervals = {};
let liveStats = { balance: 0, unrealizedPnl: 0, todayPnl: 0, positions: 0 };

// Load saved exchange configs from localStorage
function loadExchangeConfigs() {
    try {
        const saved = localStorage.getItem('exchange_configs');
        if (saved) {
            exchangeConfigs = JSON.parse(saved);
            // Update UI for connected exchanges
            Object.keys(exchangeConfigs).forEach(exchange => {
                if (exchangeConfigs[exchange]?.connected) {
                    updateExchangeUI(exchange, true);
                }
            });
        }
    } catch (e) {
        console.error('Error loading exchange configs:', e);
    }
}

function saveExchangeConfigs() {
    try {
        localStorage.setItem('exchange_configs', JSON.stringify(exchangeConfigs));
    } catch (e) {
        console.error('Error saving exchange configs:', e);
    }
}

function showExchangeSettings() {
    loadExchangeConfigs();
    // Close all configs first
    document.querySelectorAll('.exchange-config').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('.exchange-item').forEach(i => i.classList.remove('active'));
    // Populate saved keys (masked)
    Object.keys(exchangeConfigs).forEach(exchange => {
        const config = exchangeConfigs[exchange];
        if (config?.connected) {
            if (exchange === 'hyperliquid') {
                document.getElementById('hyperliquidWallet').value = config.wallet || '';
            } else {
                document.getElementById(`${exchange}ApiKey`).value = config.apiKey ? '' + config.apiKey.slice(-4) : '';
            }
            updateExchangeUI(exchange, true);
        }
    });
    document.getElementById('exchangeSettingsModal').classList.add('active');
}

function closeExchangeSettings() {
    document.getElementById('exchangeSettingsModal').classList.remove('active');
}

function toggleExchangeConfig(exchange) {
    const item = document.getElementById(`${exchange}Item`);
    const config = document.getElementById(`${exchange}Config`);
    const isActive = config.classList.contains('active');

    // Close all others
    document.querySelectorAll('.exchange-config').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('.exchange-item').forEach(i => i.classList.remove('active'));

    // Toggle this one
    if (!isActive) {
        config.classList.add('active');
        item.classList.add('active');
    }
}

function updateExchangeUI(exchange, connected) {
    const item = document.getElementById(`${exchange}Item`);
    const status = document.getElementById(`${exchange}Status`);
    const disconnectBtn = document.getElementById(`${exchange}Disconnect`);
    const syncBtn = document.getElementById(`${exchange}Sync`);
    const syncStatus = document.getElementById(`${exchange}SyncStatus`);

    if (connected) {
        item.classList.add('connected');
        status.textContent = 'CONNECTED';
        status.className = 'exchange-status connected';
        disconnectBtn.style.display = 'inline-block';
        syncBtn.style.display = 'inline-block';
        syncStatus.style.display = 'flex';
    } else {
        item.classList.remove('connected');
        status.textContent = 'NOT CONNECTED';
        status.className = 'exchange-status disconnected';
        disconnectBtn.style.display = 'none';
        syncBtn.style.display = 'none';
        syncStatus.style.display = 'none';
    }
}

async function connectExchange(exchange) {
    let config = {};

    if (exchange === 'hyperliquid') {
        const wallet = document.getElementById('hyperliquidWallet').value.trim();
        if (!wallet || !wallet.startsWith('0x')) {
            alert('Please enter a valid wallet address');
            return;
        }
        config = { wallet, connected: true };
    } else {
        const apiKey = document.getElementById(`${exchange}ApiKey`).value.trim();
        const apiSecret = document.getElementById(`${exchange}ApiSecret`).value.trim();
        if (!apiKey || !apiSecret || apiKey.includes('')) {
            alert('Please enter valid API credentials');
            return;
        }
        config = { apiKey, apiSecret, connected: true };
    }

    // Test connection
    try {
        const testResult = await testExchangeConnection(exchange, config);
        if (testResult.success) {
            exchangeConfigs[exchange] = config;
            exchangeConfigs[exchange].lastSync = null;
            saveExchangeConfigs();
            updateExchangeUI(exchange, true);

            // Start auto-sync
            startAutoSync(exchange);

            // Initial sync
            await syncExchange(exchange);

            alert(`${exchange.toUpperCase()} connected successfully!`);
        } else {
            alert(`Connection failed: ${testResult.error}`);
        }
    } catch (e) {
        alert(`Connection error: ${e.message}`);
    }
}

async function disconnectExchange(exchange) {
    if (!confirm(`Disconnect ${exchange.toUpperCase()}?`)) return;

    // Stop auto-sync
    if (syncIntervals[exchange]) {
        clearInterval(syncIntervals[exchange]);
        delete syncIntervals[exchange];
    }

    delete exchangeConfigs[exchange];
    saveExchangeConfigs();
    updateExchangeUI(exchange, false);

    // Clear input fields
    if (exchange === 'hyperliquid') {
        document.getElementById('hyperliquidWallet').value = '';
    } else {
        document.getElementById(`${exchange}ApiKey`).value = '';
        document.getElementById(`${exchange}ApiSecret`).value = '';
    }

    updateLiveStatsBar();
}

async function testExchangeConnection(exchange, config) {
    try {
        if (exchange === 'bybit') {
            return await testBybitConnection(config);
        } else if (exchange === 'binance') {
            return await testBinanceConnection(config);
        } else if (exchange === 'hyperliquid') {
            return await testHyperliquidConnection(config);
        }
        return { success: false, error: 'Unknown exchange' };
    } catch (e) {
        return { success: false, error: e.message };
    }
}

// BYBIT API
async function testBybitConnection(config) {
    // Note: Due to CORS, we'd need a proxy server in production
    // For now, we simulate the connection test
    // In production, this would be a call to your backend that proxies to Bybit
    console.log('Testing Bybit connection...');
    // Simulate API validation
    if (config.apiKey && config.apiSecret) {
        return { success: true };
    }
    return { success: false, error: 'Invalid credentials' };
}

async function fetchBybitTrades(config, startTime) {
    // In production, this would call your backend API that proxies to Bybit
    // The backend signs requests with the API secret
    console.log('Fetching Bybit trades since', startTime);

    // Simulated response structure - replace with actual API call
    // API endpoint: GET /v5/position/closed-pnl
    return {
        trades: [],
        balance: 0,
        unrealizedPnl: 0,
        positions: []
    };
}

// BINANCE API
async function testBinanceConnection(config) {
    console.log('Testing Binance connection...');
    if (config.apiKey && config.apiSecret) {
        return { success: true };
    }
    return { success: false, error: 'Invalid credentials' };
}

async function fetchBinanceTrades(config, startTime) {
    console.log('Fetching Binance trades since', startTime);

    // API endpoint: GET /fapi/v1/userTrades
    return {
        trades: [],
        balance: 0,
        unrealizedPnl: 0,
        positions: []
    };
}

// HYPERLIQUID API (public, no auth needed)
async function testHyperliquidConnection(config) {
    try {
        const response = await fetch('https://api.hyperliquid.xyz/info', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                type: 'clearinghouseState',
                user: config.wallet
            })
        });

        if (response.ok) {
            const data = await response.json();
            return { success: true, data };
        }
        return { success: false, error: 'API request failed' };
    } catch (e) {
        // CORS might block this - in production use a proxy
        console.log('Hyperliquid direct API failed (likely CORS), simulating success');
        return { success: true };
    }
}

async function fetchHyperliquidData(config) {
    try {
        const response = await fetch('https://api.hyperliquid.xyz/info', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                type: 'clearinghouseState',
                user: config.wallet
            })
        });

        if (response.ok) {
            const data = await response.json();
            return {
                balance: parseFloat(data.marginSummary?.accountValue || 0),
                unrealizedPnl: parseFloat(data.marginSummary?.totalUnrealizedPnl || 0),
                positions: data.assetPositions?.filter(p => parseFloat(p.position?.szi || 0) !== 0) || []
            };
        }
    } catch (e) {
        console.error('Hyperliquid fetch error:', e);
    }
    return { balance: 0, unrealizedPnl: 0, positions: [] };
}

async function fetchHyperliquidTrades(config, startTime) {
    try {
        const response = await fetch('https://api.hyperliquid.xyz/info', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                type: 'userFills',
                user: config.wallet,
                startTime: startTime
            })
        });

        if (response.ok) {
            const fills = await response.json();
            return { trades: fills || [] };
        }
    } catch (e) {
        console.error('Hyperliquid trades fetch error:', e);
    }
    return { trades: [] };
}

async function syncExchange(exchange) {
    const config = exchangeConfigs[exchange];
    if (!config?.connected) return;

    const syncIndicator = document.getElementById(`${exchange}SyncIndicator`);
    const lastSyncEl = document.getElementById(`${exchange}LastSync`);

    syncIndicator.classList.add('syncing');

    try {
        const lastSync = config.lastSync || Date.now() - (30 * 24 * 60 * 60 * 1000); // Last 30 days if first sync

        let data;
        if (exchange === 'bybit') {
            data = await fetchBybitTrades(config, lastSync);
        } else if (exchange === 'binance') {
            data = await fetchBinanceTrades(config, lastSync);
        } else if (exchange === 'hyperliquid') {
            data = await fetchHyperliquidData(config);
            const tradesData = await fetchHyperliquidTrades(config, lastSync);
            data.trades = tradesData.trades;
        }

        // Update live stats
        if (data) {
            liveStats = {
                exchange: exchange.toUpperCase(),
                balance: data.balance || 0,
                unrealizedPnl: data.unrealizedPnl || 0,
                todayPnl: calculateTodayPnl(data.trades || []),
                positions: data.positions?.length || 0
            };
            updateLiveStatsBar();

            // Import new trades (auto-creates trade entries)
            if (data.trades && data.trades.length > 0) {
                await importExchangeTrades(data.trades, exchange);
            }
        }

        // Update last sync time
        exchangeConfigs[exchange].lastSync = Date.now();
        saveExchangeConfigs();

        const now = new Date();
        lastSyncEl.textContent = `Last sync: ${now.toLocaleTimeString()}`;
        syncIndicator.classList.remove('syncing');
        syncIndicator.classList.add('active');

    } catch (e) {
        console.error(`Sync error for ${exchange}:`, e);
        syncIndicator.classList.remove('syncing');
        lastSyncEl.textContent = 'Sync failed';
    }
}

function calculateTodayPnl(trades) {
    const today = new Date().toDateString();
    return trades
        .filter(t => new Date(t.time || t.timestamp).toDateString() === today)
        .reduce((sum, t) => sum + (parseFloat(t.closedPnl || t.realizedPnl || t.pnl) || 0), 0);
}

async function importExchangeTrades(exchangeTrades, exchange) {
    // Convert exchange trades to our trade format
    // Note: This creates basic entries - user fills in subjective fields manually

    for (const t of exchangeTrades) {
        // Check if trade already exists (by matching exchange trade ID or timestamp)
        const existingTrade = trades.find(existing =>
            existing.exchangeTradeId === t.tid ||
            existing.exchangeTradeId === t.id
        );

        if (existingTrade) continue; // Skip already imported trades

        const trade = {
            id: Date.now() + Math.random(),
            exchangeTradeId: t.tid || t.id,
            exchangeSource: exchange,
            account: currentAccount,
            isDraft: true, // Mark as draft so user completes subjective fields
            pair: (t.coin || t.symbol || '').toUpperCase() + '/USD',
            direction: t.dir === 'Open Long' || t.side === 'Buy' ? 'LONG' : 'SHORT',
            entryTime: new Date(t.time || t.timestamp).toISOString().split('T')[0],
            exitTime: t.closedTime ? new Date(t.closedTime).toISOString().split('T')[0] : null,
            outcome: t.closedPnl > 0 ? 'WIN' : t.closedPnl < 0 ? 'LOSS' : 'BREAKEVEN',
            pnlDollar: parseFloat(t.closedPnl || t.realizedPnl || 0),
            entryPrice: parseFloat(t.px || t.price || 0),
            riskAmount: 0, // User fills in
            actualR: 0, // User fills in
            processScore: 5,
            convictionScore: 3,
            setupGrade: 'B',
            // Subjective fields left empty for user to fill
            reasoning: '',
            exitPlan: '',
            demonTags: [],
            emotionsBefore: [],
            emotionsDuring: [],
            emotionsAfter: [],
            images: []
        };

        // Add to trades
        if (!accounts[currentAccount]) {
            accounts[currentAccount] = { name: 'Account', balance: 10000, trades: [] };
        }
        accounts[currentAccount].trades.push(trade);

        // Save to Supabase
        await saveTradeToDb(trade);
    }

    // Refresh UI
    trades = accounts[currentAccount].trades;
    saveData();
    renderTrades();
    updateDashboard();
}

function startAutoSync(exchange) {
    // Sync every 5 minutes
    if (syncIntervals[exchange]) {
        clearInterval(syncIntervals[exchange]);
    }

    syncIntervals[exchange] = setInterval(() => {
        syncExchange(exchange);
    }, 5 * 60 * 1000);
}

function updateLiveStatsBar() {
    const bar = document.getElementById('liveStatsBar');
    const hasConnected = Object.values(exchangeConfigs).some(c => c?.connected);

    if (hasConnected && liveStats.exchange) {
        bar.classList.add('active');
        document.getElementById('liveExchange').textContent = liveStats.exchange;
        document.getElementById('liveBalance').textContent = '$' + liveStats.balance.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});

        const unrealizedEl = document.getElementById('liveUnrealizedPnl');
        unrealizedEl.textContent = (liveStats.unrealizedPnl >= 0 ? '+' : '') + '$' + liveStats.unrealizedPnl.toFixed(2);
        unrealizedEl.className = 'live-stat-value ' + (liveStats.unrealizedPnl >= 0 ? 'positive' : 'negative');

        const todayEl = document.getElementById('liveTodayPnl');
        todayEl.textContent = (liveStats.todayPnl >= 0 ? '+' : '') + '$' + liveStats.todayPnl.toFixed(2);
        todayEl.className = 'live-stat-value ' + (liveStats.todayPnl >= 0 ? 'positive' : 'negative');

        document.getElementById('livePositions').textContent = liveStats.positions;
        document.getElementById('liveLastUpdate').textContent = new Date().toLocaleTimeString();
    } else {
        bar.classList.remove('active');
    }
}

async function refreshLiveStats() {
    for (const exchange of Object.keys(exchangeConfigs)) {
        if (exchangeConfigs[exchange]?.connected) {
            await syncExchange(exchange);
        }
    }
}

// Initialize exchange configs on load
document.addEventListener('DOMContentLoaded', () => {
    loadExchangeConfigs();
    // Start auto-sync for connected exchanges
    Object.keys(exchangeConfigs).forEach(exchange => {
        if (exchangeConfigs[exchange]?.connected) {
            startAutoSync(exchange);
        }
    });
});

// ========== DATA ==========
let accounts = {};
let currentAccount = 'default';
let trades = [];
let allWeeklyEntries = []; // All weekly entries (filtered by account when rendering)
let allMissedTrades = []; // All missed trades (filtered by account when rendering)
let currentFilter = 'all';
let chartPoints = [];
let isLoading = false;
let isSavingTrade = false;
let imageViewerCache = {}; // Cache for image arrays to avoid escaping issues

// Get weekly entries for current account
function getWeeklyEntries() {
    return allWeeklyEntries;
}

// Get missed trades for current account
function getMissedTrades() {
    return allMissedTrades;
}

// ========== INIT ==========
async function init() {
    try {
        showLoadingOverlay('LOADING DATA...');
        await loadData();
    } catch (e) {
        console.error('Init error:', e);
        loadFromLocalStorage();
    } finally {
        updateAccountSelector();
        updateTradeAccountSelector();
        updateDashboard();
        renderTrades();
        renderWeekly();
        renderMissedList();
        updateExecutionTracker();
        updateUserDisplay();
        hideLoadingOverlay();
        console.log('Terminal initialized');
    }
}

function updateUserDisplay() {
    // Auth removed - just show EFI
    const emailEl = document.getElementById('userEmail');
    const logoutBtn = document.getElementById('logoutBtn');
    emailEl.textContent = 'EFI';
    emailEl.style.display = 'inline';
    logoutBtn.style.display = 'none'; // No logout needed
}

function showLoadingOverlay(msg) {
    let overlay = document.getElementById('loadingOverlay');
    if (!overlay) {
        overlay = document.createElement('div');
        overlay.id = 'loadingOverlay';
        overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.95);z-index:9999;display:flex;align-items:center;justify-content:center;font-size:14px;color:#fff;';
        document.body.appendChild(overlay);
    }
    overlay.innerHTML = msg || 'LOADING...';
    overlay.style.display = 'flex';
}

function hideLoadingOverlay() {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) overlay.style.display = 'none';
}

async function loadData() {
    // If Supabase isn't available, use localStorage
    if (!useSupabase || !supabaseClient) {
        console.log('Using localStorage (Supabase not available)');
        loadFromLocalStorage();
        return;
    }

    try {
        // Load accounts
        const { data: accountsData, error: accErr } = await supabaseClient
            .from('accounts')
            .select('*');

        if (accErr) throw accErr;

        accounts = {};
        if (accountsData && accountsData.length > 0) {
            accountsData.forEach(acc => {
                accounts[acc.id] = { name: acc.name, balance: parseFloat(acc.balance), trades: [] };
            });
        } else {
            // Create default account if none exists
            accounts = { 'default': { name: 'ACCOUNT 1', balance: 10000, trades: [] } };
            const defaultAcc = { id: 'default', name: 'ACCOUNT 1', balance: 10000 };
            await supabaseClient.from('accounts').insert(defaultAcc);
        }

        // Load trades
        const { data: tradesData, error: trErr } = await supabaseClient
            .from('trades')
            .select('*');

        if (trErr) throw trErr;

        if (tradesData) {
            tradesData.forEach(t => {
                const trade = dbToTrade(t);
                if (accounts[trade.account]) {
                    accounts[trade.account].trades.push(trade);
                }
            });
        }

        // Load ALL weekly entries (will filter by account when rendering)
        const { data: weeklyData, error: wkErr } = await supabaseClient
            .from('weekly_entries')
            .select('*')
            .order('week_of', { ascending: false });

        if (wkErr) throw wkErr;
        allWeeklyEntries = weeklyData ? weeklyData.map(row => ({
            ...dbToWeekly(row),
            accountId: row.account_id || 'default'
        })) : [];

        // Load ALL missed trades (will filter by account when rendering)
        try {
            const { data: missedData, error: missedErr } = await supabaseClient
                .from('missed_trades')
                .select('*')
                .order('date', { ascending: false });

            if (!missedErr && missedData) {
                allMissedTrades = missedData.map(row => ({
                    id: row.id,
                    accountId: row.account_id || 'default',
                    date: row.date,
                    ticker: row.ticker,
                    direction: row.direction,
                    potentialPnl: parseFloat(row.potential_pnl) || 0,
                    note: row.note,
                    images: row.images || [],
                    createdAt: row.created_at
                }));
            }
        } catch (missedLoadErr) {
            console.warn('Could not load missed trades (table may not exist):', missedLoadErr);
            allMissedTrades = [];
        }

        // Load current account preference
        const { data: prefData } = await supabaseClient
            .from('user_preferences')
            .select('current_account')
            .eq('id', 1)
            .maybeSingle();

        if (!prefData) {
            // seed default preference row if missing
            await supabaseClient.from('user_preferences').upsert({ id: 1, current_account: 'default' });
            currentAccount = 'default';
        } else {
            currentAccount = prefData.current_account || 'default';
        }
        if (!accounts[currentAccount]) currentAccount = 'default';

        trades = accounts[currentAccount]?.trades || [];

        // Merge images from localStorage (in case Supabase images column is missing/empty)
        mergeImagesFromLocalStorage();

    } catch (e) {
        // Supabase failed (likely RLS issue) - silently fall back to localStorage
        // This is expected if RLS policies haven't been updated
        loadFromLocalStorage();
    }
}

// Merge images from localStorage backup into Supabase-loaded data
function mergeImagesFromLocalStorage() {
    try {
        const saved = localStorage.getItem('terminal_data');
        if (!saved) return;

        const localData = JSON.parse(saved);
        const localAccounts = localData.accounts || {};
        const localMissed = localData.missedTrades || [];

        // Merge trade images
        Object.keys(accounts).forEach(accId => {
            const localAcc = localAccounts[accId];
            if (!localAcc || !localAcc.trades) return;

            accounts[accId].trades.forEach(trade => {
                // If trade has no images but localStorage has them, use localStorage images
                if ((!trade.images || trade.images.length === 0)) {
                    const localTrade = localAcc.trades.find(t => t.id === trade.id);
                    if (localTrade && localTrade.images && localTrade.images.length > 0) {
                        trade.images = localTrade.images;
                        console.log('Restored images for trade', trade.id, 'from localStorage');
                    }
                }
            });
        });

        // Merge missed trade images
        allMissedTrades.forEach(missed => {
            if ((!missed.images || missed.images.length === 0)) {
                const localMissed2 = localMissed.find(m => m.id === missed.id);
                if (localMissed2 && localMissed2.images && localMissed2.images.length > 0) {
                    missed.images = localMissed2.images;
                    console.log('Restored images for missed trade', missed.id, 'from localStorage');
                }
            }
        });

        // Update trades reference if needed
        trades = accounts[currentAccount]?.trades || [];

    } catch (e) {
        console.error('Error merging images from localStorage:', e);
    }
}

function loadFromLocalStorage() {
    try {
        const saved = localStorage.getItem('terminal_data');
        if (saved) {
            const data = JSON.parse(saved);
            accounts = data.accounts || { 'default': { name: 'ACCOUNT 1', balance: 10000, trades: [] } };
            allWeeklyEntries = data.weeklyEntries || [];
            allMissedTrades = data.missedTrades || [];
            currentAccount = data.currentAccount || 'default';
        } else {
            accounts = { 'default': { name: 'ACCOUNT 1', balance: 10000, trades: [] } };
            allMissedTrades = [];
            allWeeklyEntries = [];
        }
        trades = accounts[currentAccount]?.trades || [];
    } catch (e) {
        console.error('localStorage load error:', e);
        accounts = { 'default': { name: 'ACCOUNT 1', balance: 10000, trades: [] } };
        trades = [];
        allMissedTrades = [];
        allWeeklyEntries = [];
    }
}

// Convert database row to trade object
function dbToTrade(row) {
    return {
        id: row.id,
        account: row.account_id,
        isDraft: row.is_draft,
        pair: row.pair,
        direction: row.direction,
        entryTime: row.entry_time,
        exitTime: row.exit_time,
        outcome: row.outcome,
        riskAmount: parseFloat(row.risk_amount) || 0,
        initialRR: row.initial_rr,
        actualR: parseFloat(row.actual_r) || 0,
        pnlDollar: parseFloat(row.pnl_dollar) || 0,
        pnlPercent: row.pnl_percent,
        setupGrade: row.setup_grade,
        reasoning: row.reasoning,
        entryPrice: parseFloat(row.entry_price) || 0,
        stopPrice: parseFloat(row.stop_price) || 0,
        worstPrice: row.worst_price,
        bestPrice: row.best_price,
        didNothing: row.did_nothing,
        demonTags: row.demon_tags || [],
        exitPlan: row.exit_plan,
        processScore: row.process_score,
        followedPlan: row.followed_plan,
        wrongAction: row.wrong_action,
        negCause: row.neg_cause,
        improvement: row.improvement,
        convictionScore: row.conviction_score,
        trustFactors: row.trust_factors,
        emotionsPresent: row.emotions_present,
        emotionsBefore: row.emotions_before || [],
        emotionsDuring: row.emotions_during || [],
        emotionsAfter: row.emotions_after || [],
        afterExit: row.after_exit,
        exitLogical: row.exit_logical,
        manageDifferent: row.manage_different,
        images: row.images || []
    };
}

function toNumOrNull(v) {
    if (v === undefined || v === null) return null;
    if (typeof v === 'number') return Number.isFinite(v) ? v : null;
    const s = String(v).trim();
    if (s === '' || s.toLowerCase() === 'na' || s === '--') return null;
    const n = Number(s);
    return Number.isFinite(n) ? n : null;
}

// Convert trade object to database row
function tradeToDb(trade) {
    const row = {
        id: trade.id,
        account_id: trade.account,
        is_draft: trade.isDraft,
        pair: trade.pair,
        direction: trade.direction,
        entry_time: trade.entryTime || null,
        exit_time: trade.exitTime || null,
        outcome: trade.outcome,
        risk_amount: toNumOrNull(trade.riskAmount),
        initial_rr: trade.initialRR,
        actual_r: toNumOrNull(trade.actualR),
        pnl_dollar: toNumOrNull(trade.pnlDollar),
        pnl_percent: trade.pnlPercent,
        setup_grade: trade.setupGrade,
        reasoning: trade.reasoning,
        entry_price: toNumOrNull(trade.entryPrice),
        stop_price: toNumOrNull(trade.stopPrice),
        worst_price: toNumOrNull(trade.worstPrice),
        best_price: toNumOrNull(trade.bestPrice),
        did_nothing: trade.didNothing,
        demon_tags: trade.demonTags || [],
        exit_plan: trade.exitPlan,
        process_score: trade.processScore,
        followed_plan: trade.followedPlan,
        wrong_action: trade.wrongAction,
        neg_cause: trade.negCause,
        improvement: trade.improvement,
        conviction_score: trade.convictionScore,
        trust_factors: trade.trustFactors,
        emotions_present: trade.emotionsPresent,
        emotions_before: trade.emotionsBefore || [],
        emotions_during: trade.emotionsDuring || [],
        emotions_after: trade.emotionsAfter || [],
        after_exit: trade.afterExit,
        exit_logical: trade.exitLogical,
        manage_different: trade.manageDifferent,
        images: trade.images || []
    };
    return row;
}

// Convert database row to weekly entry
function dbToWeekly(row) {
    return {
        id: row.id,
        weekOf: row.week_of,
        days: row.days || {},
        bias: row.bias || {}
    };
}

// Convert weekly entry to database row
function weeklyToDb(entry) {
    return {
        id: entry.id,
        week_of: entry.weekOf,
        days: entry.days,
        bias: entry.bias || {}
    };
}

async function saveData() {
    try {
        // Always save to localStorage as backup
        accounts[currentAccount].trades = trades;
        localStorage.setItem('terminal_data', JSON.stringify({
            accounts, weeklyEntries: allWeeklyEntries, missedTrades: allMissedTrades, currentAccount
        }));

        // Save current account preference to Supabase if available
        if (useSupabase && supabaseClient) {
            await supabaseClient
                .from('user_preferences')
                .upsert({ id: 1, current_account: currentAccount });
        }
    } catch (e) {
        console.error('Save error:', e);
    }
}

async function saveTradeToDb(trade) {
    if (!useSupabase || !supabaseClient) return;
    try {
        const { error } = await supabaseClient
            .from('trades')
            .upsert(tradeToDb(trade));
        // Silently ignore errors - localStorage is backup
    } catch (e) {
        // RLS may block this - that's fine, localStorage has the data
    }
}

async function deleteTradeFromDb(tradeId) {
    if (!useSupabase || !supabaseClient) return;
    try {
        await supabaseClient
            .from('trades')
            .delete()
            .eq('id', tradeId);
    } catch (e) {
        // RLS may block this - that's fine
    }
}

async function saveAccountToDb(id, account) {
    if (!useSupabase || !supabaseClient) return;
    try {
        const row = { id, name: account.name, balance: account.balance };
        await supabaseClient
            .from('accounts')
            .upsert(row);
    } catch (e) {
        // RLS may block this - that's fine
    }
}

async function deleteAccountFromDb(id) {
    if (!useSupabase || !supabaseClient) return;
    try {
        await supabaseClient
            .from('accounts')
            .delete()
            .eq('id', id);
    } catch (e) {
        // RLS may block this - that's fine
    }
}

async function saveWeeklyToDb(entry) {
    if (!useSupabase || !supabaseClient) return;
    try {
        await supabaseClient
            .from('weekly_entries')
            .upsert(weeklyToDb(entry));
    } catch (e) {
        // RLS may block this - that's fine
    }
}

async function deleteWeeklyFromDb(id) {
    if (!useSupabase || !supabaseClient) return;
    try {
        await supabaseClient
            .from('weekly_entries')
            .delete()
            .eq('id', id);
    } catch (e) {
        // RLS may block this - that's fine
    }
}

// ========== NAV ==========
function toggleMenu() { document.getElementById('sidebar').classList.toggle('open'); }

function showPage(id, el) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    if (el) el.classList.add('active');
    document.getElementById('sidebar').classList.remove('open');
    if (id === 'dashboard') updateDashboard();
    if (id === 'trades') renderTrades();
    if (id === 'weekly') renderWeekly();
    if (id === 'missed') renderMissedList();
}

// ========== ACCOUNTS ==========
function showAccountModal() { document.getElementById('accountModal').classList.add('active'); renderAccountList(); }
function closeAccountModal() { document.getElementById('accountModal').classList.remove('active'); }

function updateAccountSelector() {
    const sel = document.getElementById('accountSelector');
    sel.innerHTML = Object.entries(accounts).map(([id, acc]) =>
        `<option value="${id}" ${id === currentAccount ? 'selected' : ''}>${acc.name}</option>`
    ).join('');
}

function updateTradeAccountSelector() {
    const sel = document.getElementById('tradeAccount');
    if (sel) {
        sel.innerHTML = Object.entries(accounts).map(([id, acc]) =>
            `<option value="${id}" ${id === currentAccount ? 'selected' : ''}>${acc.name}</option>`
        ).join('');
    }
}

function switchAccount() {
    currentAccount = document.getElementById('accountSelector').value;
    trades = accounts[currentAccount]?.trades || [];
    saveData();
    updateTradeAccountSelector();
    updateDashboard();
    renderTrades();
    renderWeekly();
    renderMissedList();
}

async function createAccount() {
    const name = document.getElementById('newAccountName').value.trim();
    const balance = parseFloat(document.getElementById('newAccountBalance').value) || 10000;
    if (!name) { alert('Enter account name'); return; }
    const id = 'acc_' + Date.now();
    accounts[id] = { name, balance, trades: [] };
    await saveAccountToDb(id, accounts[id]);
    saveData();
    updateAccountSelector();
    updateTradeAccountSelector();
    renderAccountList();
    document.getElementById('newAccountName').value = '';
    document.getElementById('newAccountBalance').value = '';
    alert('Account created: ' + name);
}

async function updateAccountBalance() {
    const balance = parseFloat(document.getElementById('updateBalance').value);
    if (!balance || balance <= 0) { alert('Enter valid balance'); return; }
    accounts[currentAccount].balance = balance;
    await saveAccountToDb(currentAccount, accounts[currentAccount]);
    saveData();
    updateDashboard();
    renderAccountList();
    document.getElementById('updateBalance').value = '';
    alert('Balance updated to $' + balance);
}

async function deleteAccount(id) {
    if (id === 'default') { alert('Cannot delete default account'); return; }
    if (!confirm('Delete this account?')) return;
    await deleteAccountFromDb(id);
    delete accounts[id];
    if (currentAccount === id) { currentAccount = 'default'; trades = accounts[currentAccount].trades; }
    saveData();
    updateAccountSelector();
    updateTradeAccountSelector();
    renderAccountList();
    updateDashboard();
}

function renderAccountList() {
    document.getElementById('accountList').innerHTML = '<h3 style="margin-bottom:10px;">ACCOUNTS</h3>' +
        Object.entries(accounts).map(([id, acc]) => `
            <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;border:1px solid #333;margin-bottom:5px;">
                <span><strong>${acc.name}</strong> - $${acc.balance.toLocaleString()} - ${acc.trades.length} trades</span>
                ${id !== 'default' ? `<button class="btn-danger" onclick="deleteAccount('${id}')">DELETE</button>` : ''}
            </div>
        `).join('');
}

// ========== TRADES ==========
function showTradeForm() {
    document.getElementById('tradeForm').style.display = 'block';
    clearTradeForm();
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function hideTradeForm() { document.getElementById('tradeForm').style.display = 'none'; }

function clearTradeForm() {
    document.getElementById('editTradeId').value = '';
    ['pair','entryTime','exitTime','riskAmount','initialRR','actualR','pnlDollar','pnlPercent',
     'reasoning','entryPrice','stopPrice','worstPrice','bestPrice','didNothing','exitPlan',
     'wrongAction','negCause','improvement','trustFactors','emotionsPresent','afterExit','manageDifferent'
    ].forEach(id => { const el = document.getElementById(id); if(el) el.value = ''; });
    document.getElementById('direction').value = 'LONG';
    document.getElementById('outcome').value = '';
    document.getElementById('setupGrade').value = 'A';
    // Clear pending images
    pendingTradeImages = [];
    const preview = document.getElementById('tradeImagePreview');
    if (preview) preview.innerHTML = '';
    document.getElementById('followedPlan').value = 'YES';
    document.getElementById('exitLogical').value = 'YES';
    document.getElementById('processScore').value = 5;
    document.getElementById('processVal').innerText = '5';
    document.getElementById('convictionScore').value = 3;
    document.getElementById('convictionVal').innerText = '3';
    document.getElementById('maeValue').innerHTML = '--';
    document.getElementById('mfeValue').innerHTML = '--';
    document.getElementById('worstPriceField').style.opacity = '1';
    document.getElementById('bestPriceField').style.opacity = '1';
    document.getElementById('worstPrice').disabled = false;
    document.getElementById('bestPrice').disabled = false;
    document.querySelectorAll('.tag.selected').forEach(t => t.classList.remove('selected'));
    updateTradeAccountSelector();
}

function toggleTag(el) { el.classList.toggle('selected'); }
function getSelectedTags(id) { return Array.from(document.querySelectorAll(`#${id} .tag.selected`)).map(t => t.textContent); }
function updateSlider(el, valId) { document.getElementById(valId).innerText = el.value; }

function drawRatioRing(pct, label) {
    const circumference = 2 * Math.PI * 18;
    const offset = circumference - (pct / 100) * circumference;
    return `
        <div class="ratio-ring">
            <svg width="50" height="50">
                <circle cx="25" cy="25" r="18" fill="none" stroke="#333" stroke-width="5"/>
                <circle cx="25" cy="25" r="18" fill="none" stroke="#888" stroke-width="5"
                    stroke-dasharray="${circumference}" stroke-dashoffset="${offset}"/>
            </svg>
            <div class="ratio-ring-text">${pct}%<span style="font-size:9px;">${label}</span></div>
        </div>
    `;
}

function showFactorRateModal() {
    const trades = window.currentFilteredTrades || [];
    if (trades.length === 0) {
        alert('No trades to display. Add some trades first.');
        return;
    }

    const sorted = [...trades].sort((a, b) => (b.actualR || 0) - (a.actualR || 0));

    let html = `
        <div class="modal active" id="factorRateModal" onclick="if(event.target===this)closeFactorRateModal()">
            <div class="modal-content" style="max-width:600px;">
                <div class="modal-header">
                    <h2>FACTOR RATE BREAKDOWN</h2>
                    <button onclick="closeFactorRateModal()">CLOSE</button>
                </div>
                <div style="max-height:60vh;overflow-y:auto;">
                    <table style="width:100%;border-collapse:collapse;font-size:11px;">
                        <thead>
                            <tr style="border-bottom:1px solid #fff;text-align:left;">
                                <th style="padding:8px;">DATE</th>
                                <th style="padding:8px;">TICKER</th>
                                <th style="padding:8px;">DIR</th>
                                <th style="padding:8px;">R</th>
                                <th style="padding:8px;">P/L</th>
                                <th style="padding:8px;">OUTCOME</th>
                            </tr>
                        </thead>
                        <tbody>
    `;

    sorted.forEach(t => {
        const date = t.exitTime || t.entryTime || '--';
        const ticker = (t.pair || '').split('/')[0] || '--';
        const r = t.actualR || 0;
        const rColor = r >= 0 ? '#0f0' : '#f00';
        const outcomeColor = t.outcome === 'WIN' ? '#0f0' : t.outcome === 'LOSS' ? '#f00' : '#888';
        html += `
            <tr style="border-bottom:1px solid #333;">
                <td style="padding:8px;">${date}</td>
                <td style="padding:8px;font-weight:bold;">${ticker}</td>
                <td style="padding:8px;">${t.direction || '--'}</td>
                <td style="padding:8px;color:${rColor};font-weight:bold;">${r >= 0 ? '+' : ''}${r.toFixed(2)}R</td>
                <td style="padding:8px;color:${rColor};">${(t.pnlDollar || 0) >= 0 ? '+' : ''}$${(t.pnlDollar || 0).toFixed(0)}</td>
                <td style="padding:8px;color:${outcomeColor};">${t.outcome || '--'}</td>
            </tr>
        `;
    });

    const avgR = (sorted.reduce((s, t) => s + (t.actualR || 0), 0) / sorted.length).toFixed(2);
    const totalR = sorted.reduce((s, t) => s + (t.actualR || 0), 0).toFixed(2);

    html += `
                        </tbody>
                    </table>
                </div>
                <div style="margin-top:15px;padding-top:15px;border-top:1px solid #fff;display:flex;gap:30px;">
                    <div><span style="color:#888;">AVG R:</span> <strong>${avgR}R</strong></div>
                    <div><span style="color:#888;">TOTAL R:</span> <strong>${totalR}R</strong></div>
                    <div><span style="color:#888;">TRADES:</span> <strong>${sorted.length}</strong></div>
                </div>
            </div>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', html);
}

function closeFactorRateModal() {
    const modal = document.getElementById('factorRateModal');
    if (modal) modal.remove();
}

function showStatBreakdown(type) {
    const trades = window.currentFilteredTrades || [];
    if (trades.length === 0) return;

    let title = '';
    let content = '';

    const wins = trades.filter(t => t.outcome === 'WIN');
    const losses = trades.filter(t => t.outcome === 'LOSS');

    switch(type) {
        case 'winrate':
            title = 'WIN RATE BREAKDOWN';
            const byGrade = {};
            trades.forEach(t => {
                const g = t.setupGrade || 'N/A';
                if (!byGrade[g]) byGrade[g] = { wins: 0, total: 0 };
                byGrade[g].total++;
                if (t.outcome === 'WIN') byGrade[g].wins++;
            });
            content = Object.entries(byGrade).map(([grade, data]) =>
                `<div class="breakdown-row"><span class="breakdown-label">GRADE ${grade}</span><span class="breakdown-value">${((data.wins/data.total)*100).toFixed(0)}% (${data.wins}/${data.total})</span></div>`
            ).join('');
            content += `<div class="breakdown-row" style="margin-top:10px;border-top:1px solid #333;padding-top:10px;"><span class="breakdown-label">TOTAL WINS</span><span class="breakdown-value" style="color:#e65c00">${wins.length}</span></div>`;
            content += `<div class="breakdown-row"><span class="breakdown-label">TOTAL LOSSES</span><span class="breakdown-value" style="color:#555">${losses.length}</span></div>`;
            break;

        case 'profitfactor':
            title = 'PROFIT FACTOR BREAKDOWN';
            const grossWins = wins.reduce((s, t) => s + (t.pnlDollar || 0), 0);
            const grossLosses = Math.abs(losses.reduce((s, t) => s + (t.pnlDollar || 0), 0));
            content = `<div class="breakdown-row"><span class="breakdown-label">GROSS WINS</span><span class="breakdown-value" style="color:#e65c00">+$${grossWins.toFixed(0)}</span></div>`;
            content += `<div class="breakdown-row"><span class="breakdown-label">GROSS LOSSES</span><span class="breakdown-value" style="color:#555">-$${grossLosses.toFixed(0)}</span></div>`;
            content += `<div class="breakdown-row"><span class="breakdown-label">PROFIT FACTOR</span><span class="breakdown-value">${grossLosses > 0 ? (grossWins/grossLosses).toFixed(2) : ''}</span></div>`;
            content += `<div style="margin-top:15px;font-size:9px;color:#444;">Profit Factor = Gross Wins / Gross Losses<br>Above 1.5 is good, above 2.0 is excellent</div>`;
            break;

        case 'pnl':
            title = 'P&L BREAKDOWN';
            const byMonth = {};
            trades.forEach(t => {
                const date = t.exitTime || t.entryTime;
                if (!date) return;
                const month = date.substring(0, 7);
                if (!byMonth[month]) byMonth[month] = 0;
                byMonth[month] += t.pnlDollar || 0;
            });
            content = Object.entries(byMonth).sort().reverse().slice(0, 6).map(([month, pnl]) =>
                `<div class="breakdown-row"><span class="breakdown-label">${month}</span><span class="breakdown-value" style="color:${pnl >= 0 ? '#e65c00' : '#555'}">${pnl >= 0 ? '+' : ''}$${pnl.toFixed(0)}</span></div>`
            ).join('');
            break;

        case 'drawdown':
            title = 'DRAWDOWN ANALYSIS';
            let maxDD = 0, peak = 0, running = 0, ddStart = '', ddEnd = '';
            const sorted = [...trades].sort((a, b) => new Date(a.exitTime || a.entryTime) - new Date(b.exitTime || b.entryTime));
            sorted.forEach(t => {
                running += t.pnlDollar || 0;
                if (running > peak) peak = running;
                const dd = peak - running;
                if (dd > maxDD) { maxDD = dd; ddEnd = t.exitTime || t.entryTime; }
            });
            content = `<div class="breakdown-row"><span class="breakdown-label">MAX DRAWDOWN</span><span class="breakdown-value" style="color:#555">-$${maxDD.toFixed(0)}</span></div>`;
            content += `<div class="breakdown-row"><span class="breakdown-label">PEAK EQUITY</span><span class="breakdown-value">$${peak.toFixed(0)}</span></div>`;
            content += `<div class="breakdown-row"><span class="breakdown-label">DD DATE</span><span class="breakdown-value">${ddEnd || '--'}</span></div>`;
            break;

        case 'avgwin':
            title = 'WINNING TRADES';
            const sortedWins = [...wins].sort((a, b) => (b.pnlDollar || 0) - (a.pnlDollar || 0));
            content = sortedWins.slice(0, 8).map(t =>
                `<div class="breakdown-row"><span class="breakdown-label">${t.pair?.split('/')[0] || '--'} (${t.exitTime || '--'})</span><span class="breakdown-value" style="color:#e65c00">+$${(t.pnlDollar || 0).toFixed(0)}</span></div>`
            ).join('');
            break;

        case 'avgloss':
            title = 'LOSING TRADES';
            const sortedLosses = [...losses].sort((a, b) => (a.pnlDollar || 0) - (b.pnlDollar || 0));
            content = sortedLosses.slice(0, 8).map(t =>
                `<div class="breakdown-row"><span class="breakdown-label">${t.pair?.split('/')[0] || '--'} (${t.exitTime || '--'})</span><span class="breakdown-value" style="color:#555">$${(t.pnlDollar || 0).toFixed(0)}</span></div>`
            ).join('');
            break;

        case 'sharpe':
            title = 'SHARPE RATIO';
            const returns = trades.map(t => t.actualR || 0);
            const avgR = returns.reduce((a, b) => a + b, 0) / returns.length;
            const stdDev = Math.sqrt(returns.map(r => Math.pow(r - avgR, 2)).reduce((a, b) => a + b, 0) / returns.length);
            content = `<div class="breakdown-row"><span class="breakdown-label">AVG RETURN (R)</span><span class="breakdown-value">${avgR.toFixed(2)}R</span></div>`;
            content += `<div class="breakdown-row"><span class="breakdown-label">STD DEVIATION</span><span class="breakdown-value">${stdDev.toFixed(2)}</span></div>`;
            content += `<div class="breakdown-row"><span class="breakdown-label">SHARPE RATIO</span><span class="breakdown-value">${stdDev > 0 ? (avgR/stdDev).toFixed(2) : '--'}</span></div>`;
            content += `<div style="margin-top:15px;font-size:9px;color:#444;">Sharpe = Avg Return / Std Deviation<br>Higher = better risk-adjusted returns</div>`;
            break;

        case 'streaks':
            title = 'STREAK ANALYSIS';
            let currentStreak = 0, maxWin = 0, maxLoss = 0, lastOutcome = null;
            const streakTrades = [...trades].sort((a, b) => new Date(a.exitTime || a.entryTime) - new Date(b.exitTime || b.entryTime));
            streakTrades.forEach(t => {
                if (t.outcome === lastOutcome) currentStreak++;
                else { currentStreak = 1; lastOutcome = t.outcome; }
                if (t.outcome === 'WIN' && currentStreak > maxWin) maxWin = currentStreak;
                if (t.outcome === 'LOSS' && currentStreak > maxLoss) maxLoss = currentStreak;
            });
            content = `<div class="breakdown-row"><span class="breakdown-label">BEST WIN STREAK</span><span class="breakdown-value" style="color:#e65c00">${maxWin}</span></div>`;
            content += `<div class="breakdown-row"><span class="breakdown-label">WORST LOSS STREAK</span><span class="breakdown-value" style="color:#555">${maxLoss}</span></div>`;
            content += `<div class="breakdown-row"><span class="breakdown-label">CURRENT STREAK</span><span class="breakdown-value">${currentStreak} ${lastOutcome || '--'}</span></div>`;
            break;

        case 'process':
            title = 'PROCESS SCORE BREAKDOWN';
            const byProcess = { high: trades.filter(t => t.processScore >= 8), mid: trades.filter(t => t.processScore >= 5 && t.processScore < 8), low: trades.filter(t => t.processScore < 5) };
            content = `<div class="breakdown-row"><span class="breakdown-label">HIGH (8-10)</span><span class="breakdown-value">${byProcess.high.length} trades | ${byProcess.high.length > 0 ? ((byProcess.high.filter(t => t.outcome === 'WIN').length / byProcess.high.length) * 100).toFixed(0) : 0}% WR</span></div>`;
            content += `<div class="breakdown-row"><span class="breakdown-label">MID (5-7)</span><span class="breakdown-value">${byProcess.mid.length} trades | ${byProcess.mid.length > 0 ? ((byProcess.mid.filter(t => t.outcome === 'WIN').length / byProcess.mid.length) * 100).toFixed(0) : 0}% WR</span></div>`;
            content += `<div class="breakdown-row"><span class="breakdown-label">LOW (1-4)</span><span class="breakdown-value">${byProcess.low.length} trades | ${byProcess.low.length > 0 ? ((byProcess.low.filter(t => t.outcome === 'WIN').length / byProcess.low.length) * 100).toFixed(0) : 0}% WR</span></div>`;
            break;

        case 'conviction':
            title = 'CONVICTION BREAKDOWN';
            const byConv = { high: trades.filter(t => t.convictionScore >= 4), mid: trades.filter(t => t.convictionScore === 3), low: trades.filter(t => t.convictionScore <= 2) };
            content = `<div class="breakdown-row"><span class="breakdown-label">HIGH (4-5)</span><span class="breakdown-value">${byConv.high.length} trades | ${byConv.high.length > 0 ? ((byConv.high.filter(t => t.outcome === 'WIN').length / byConv.high.length) * 100).toFixed(0) : 0}% WR</span></div>`;
            content += `<div class="breakdown-row"><span class="breakdown-label">MID (3)</span><span class="breakdown-value">${byConv.mid.length} trades | ${byConv.mid.length > 0 ? ((byConv.mid.filter(t => t.outcome === 'WIN').length / byConv.mid.length) * 100).toFixed(0) : 0}% WR</span></div>`;
            content += `<div class="breakdown-row"><span class="breakdown-label">LOW (1-2)</span><span class="breakdown-value">${byConv.low.length} trades | ${byConv.low.length > 0 ? ((byConv.low.filter(t => t.outcome === 'WIN').length / byConv.low.length) * 100).toFixed(0) : 0}% WR</span></div>`;
            break;

        case 'trades':
            title = 'TRADE SUMMARY';
            content = `<div class="breakdown-row"><span class="breakdown-label">TOTAL TRADES</span><span class="breakdown-value">${trades.length}</span></div>`;
            content += `<div class="breakdown-row"><span class="breakdown-label">WINS</span><span class="breakdown-value" style="color:#e65c00">${wins.length}</span></div>`;
            content += `<div class="breakdown-row"><span class="breakdown-label">LOSSES</span><span class="breakdown-value" style="color:#555">${losses.length}</span></div>`;
            content += `<div class="breakdown-row"><span class="breakdown-label">BREAKEVEN</span><span class="breakdown-value">${trades.filter(t => t.outcome === 'BREAKEVEN').length}</span></div>`;
            content += `<div class="breakdown-row"><span class="breakdown-label">DRAFTS</span><span class="breakdown-value">${trades.filter(t => t.isDraft).length}</span></div>`;
            break;

        case 'direction':
            title = 'DIRECTION BREAKDOWN';
            const longs = trades.filter(t => t.direction === 'LONG');
            const shorts = trades.filter(t => t.direction === 'SHORT');
            const longWR = longs.length > 0 ? ((longs.filter(t => t.outcome === 'WIN').length / longs.length) * 100).toFixed(0) : 0;
            const shortWR = shorts.length > 0 ? ((shorts.filter(t => t.outcome === 'WIN').length / shorts.length) * 100).toFixed(0) : 0;
            const longPnl = longs.reduce((s, t) => s + (t.pnlDollar || 0), 0);
            const shortPnl = shorts.reduce((s, t) => s + (t.pnlDollar || 0), 0);
            content = `<div class="breakdown-row"><span class="breakdown-label">LONG TRADES</span><span class="breakdown-value">${longs.length}</span></div>`;
            content += `<div class="breakdown-row"><span class="breakdown-label">LONG WIN RATE</span><span class="breakdown-value">${longWR}%</span></div>`;
            content += `<div class="breakdown-row"><span class="breakdown-label">LONG P&L</span><span class="breakdown-value" style="color:${longPnl >= 0 ? '#e65c00' : '#555'}">${longPnl >= 0 ? '+' : ''}$${longPnl.toFixed(0)}</span></div>`;
            content += `<div class="breakdown-row" style="margin-top:10px;"><span class="breakdown-label">SHORT TRADES</span><span class="breakdown-value">${shorts.length}</span></div>`;
            content += `<div class="breakdown-row"><span class="breakdown-label">SHORT WIN RATE</span><span class="breakdown-value">${shortWR}%</span></div>`;
            content += `<div class="breakdown-row"><span class="breakdown-label">SHORT P&L</span><span class="breakdown-value" style="color:${shortPnl >= 0 ? '#e65c00' : '#555'}">${shortPnl >= 0 ? '+' : ''}$${shortPnl.toFixed(0)}</span></div>`;
            break;

        case 'holdtime':
            title = 'HOLD TIME BREAKDOWN';
            const holdTimes = [];
            trades.forEach(t => {
                if (t.entryTime && t.exitTime) {
                    const entry = new Date(t.entryTime);
                    const exit = new Date(t.exitTime);
                    if (!isNaN(entry) && !isNaN(exit)) {
                        const hours = (exit - entry) / (1000 * 60 * 60);
                        holdTimes.push({ trade: t, hours });
                    }
                }
            });
            if (holdTimes.length === 0) {
                content = '<div style="color:#444;">No trades with both entry and exit times</div>';
            } else {
                const avgHours = holdTimes.reduce((s, h) => s + h.hours, 0) / holdTimes.length;
                const minHold = Math.min(...holdTimes.map(h => h.hours));
                const maxHold = Math.max(...holdTimes.map(h => h.hours));
                const formatHold = (h) => h < 24 ? h.toFixed(1) + 'h' : (h / 24).toFixed(1) + 'd';
                content = `<div class="breakdown-row"><span class="breakdown-label">AVG HOLD TIME</span><span class="breakdown-value">${formatHold(avgHours)}</span></div>`;
                content += `<div class="breakdown-row"><span class="breakdown-label">SHORTEST HOLD</span><span class="breakdown-value">${formatHold(minHold)}</span></div>`;
                content += `<div class="breakdown-row"><span class="breakdown-label">LONGEST HOLD</span><span class="breakdown-value">${formatHold(maxHold)}</span></div>`;
                content += `<div class="breakdown-row"><span class="breakdown-label">TRADES WITH DATA</span><span class="breakdown-value">${holdTimes.length}/${trades.length}</span></div>`;
                // Win vs Loss hold time comparison
                const winHolds = holdTimes.filter(h => h.trade.outcome === 'WIN');
                const lossHolds = holdTimes.filter(h => h.trade.outcome === 'LOSS');
                if (winHolds.length > 0 && lossHolds.length > 0) {
                    const avgWinHold = winHolds.reduce((s, h) => s + h.hours, 0) / winHolds.length;
                    const avgLossHold = lossHolds.reduce((s, h) => s + h.hours, 0) / lossHolds.length;
                    content += `<div class="breakdown-row" style="margin-top:10px;border-top:1px solid #333;padding-top:10px;"><span class="breakdown-label">AVG WIN HOLD</span><span class="breakdown-value" style="color:#e65c00">${formatHold(avgWinHold)}</span></div>`;
                    content += `<div class="breakdown-row"><span class="breakdown-label">AVG LOSS HOLD</span><span class="breakdown-value" style="color:#555">${formatHold(avgLossHold)}</span></div>`;
                }
            }
            break;
    }

    // Remove existing modal if any
    const existing = document.getElementById('statBreakdownModal');
    if (existing) existing.remove();

    const html = `
        <div class="stat-breakdown-modal active" id="statBreakdownModal" onclick="if(event.target===this)closeStatBreakdown()">
            <div class="stat-breakdown-box">
                <div class="stat-breakdown-title">
                    <span>${title}</span>
                    <button class="exchange-btn" onclick="closeStatBreakdown()">CLOSE</button>
                </div>
                ${content}
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', html);
}

function closeStatBreakdown() {
    const modal = document.getElementById('statBreakdownModal');
    if (modal) modal.remove();
}

function calcFromR() {
    const risk = parseFloat(document.getElementById('riskAmount').value) || 0;
    const r = parseFloat(document.getElementById('actualR').value) || 0;
    if (risk > 0) {
        const pnl = (risk * r).toFixed(2);
        document.getElementById('pnlDollar').value = pnl;
        const bal = accounts[currentAccount]?.balance || 10000;
        document.getElementById('pnlPercent').value = ((pnl / bal) * 100).toFixed(2) + '%';
    }
}

function calcFromPnl() {
    const risk = parseFloat(document.getElementById('riskAmount').value) || 0;
    const pnl = parseFloat(document.getElementById('pnlDollar').value) || 0;
    if (risk > 0) {
        document.getElementById('actualR').value = (pnl / risk).toFixed(2);
        const bal = accounts[currentAccount]?.balance || 10000;
        document.getElementById('pnlPercent').value = ((pnl / bal) * 100).toFixed(2) + '%';
    }
}

function calcReturns() { calcFromR(); }

function updateMAEMFEDisplay() {
    const outcome = document.getElementById('outcome').value;
    const maeValue = document.getElementById('maeValue');
    const mfeValue = document.getElementById('mfeValue');
    const worstField = document.getElementById('worstPriceField');
    const bestField = document.getElementById('bestPriceField');

    // LOSS = MAE shows NA (you hit your stop, no adverse excursion to measure)
    // WIN = MFE shows NA (you captured the move, no unrealized favorable to measure)
    if (outcome === 'LOSS') {
        maeValue.innerHTML = '<span style="color:#666;">NA</span>';
        maeValue.title = 'Not applicable for losing trades - stop was hit';
        worstField.style.opacity = '0.4';
        document.getElementById('worstPrice').disabled = true;
        // Enable MFE for losses
        bestField.style.opacity = '1';
        document.getElementById('bestPrice').disabled = false;
    } else if (outcome === 'WIN') {
        mfeValue.innerHTML = '<span style="color:#666;">NA</span>';
        mfeValue.title = 'Not applicable for winning trades - move was captured';
        bestField.style.opacity = '0.4';
        document.getElementById('bestPrice').disabled = true;
        // Enable MAE for wins
        worstField.style.opacity = '1';
        document.getElementById('worstPrice').disabled = false;
    } else {
        // BREAKEVEN or unset - enable both
        worstField.style.opacity = '1';
        bestField.style.opacity = '1';
        document.getElementById('worstPrice').disabled = false;
        document.getElementById('bestPrice').disabled = false;
        maeValue.innerHTML = '--';
        mfeValue.innerHTML = '--';
    }

    calcMAE(); // Recalculate with new outcome
}

function calcMAE() {
    const entry = parseFloat(document.getElementById('entryPrice').value);
    const stop = parseFloat(document.getElementById('stopPrice').value);
    const worst = parseFloat(document.getElementById('worstPrice').value);
    const best = parseFloat(document.getElementById('bestPrice').value);
    const dir = document.getElementById('direction').value;
    const outcome = document.getElementById('outcome').value;

    const maeValue = document.getElementById('maeValue');
    const mfeValue = document.getElementById('mfeValue');

    // MAE calculation - only for WIN/BREAKEVEN (not LOSS)
    if (outcome === 'LOSS') {
        maeValue.innerHTML = '<span style="color:#666;">NA</span>';
    } else if (entry && stop && worst) {
        const stopDist = Math.abs(entry - stop);
        let worstDist = dir === 'LONG' ? entry - worst : worst - entry;
        if (stopDist > 0) {
            const mae = ((worstDist / stopDist) * 100).toFixed(1);
            const color = mae > 80 ? '#555' : mae > 50 ? '#666' : '#e65c00';
            maeValue.innerHTML = `<span style="color:${color};">${mae}%</span>`;
        }
    } else {
        maeValue.innerHTML = '--';
    }

    // MFE calculation - only for LOSS/BREAKEVEN (not WIN)
    if (outcome === 'WIN') {
        mfeValue.innerHTML = '<span style="color:#666;">NA</span>';
    } else if (entry && stop && best) {
        const stopDist = Math.abs(entry - stop);
        let bestDist = dir === 'LONG' ? best - entry : entry - best;
        if (stopDist > 0) {
            const mfe = ((bestDist / stopDist) * 100).toFixed(1);
            const color = mfe > 200 ? '#e65c00' : mfe > 100 ? '#999' : '#555';
            mfeValue.innerHTML = `<span style="color:${color};">${mfe}%</span>`;
        }
    } else if (outcome !== 'WIN') {
        mfeValue.innerHTML = '--';
    }
}

async function saveTrade(isDraft) {
    if (isSavingTrade) return;
    isSavingTrade = true;
    try {
    const pair = document.getElementById('pair').value.trim();
    if (!pair) { alert('Enter trading pair'); return; }

    const editId = document.getElementById('editTradeId').value;
    const selectedAccount = document.getElementById('tradeAccount').value;

    // Handle existing images if editing
    const existingTrade = editId ? accounts[selectedAccount].trades.find(t => t.id === parseInt(editId)) : null;
    const existingImages = existingTrade?.images || [];

    // Merge existing with new pending images
    const allImages = [...existingImages, ...pendingTradeImages];

    const trade = {
        id: editId ? parseInt(editId) : Date.now(),
        isDraft: isDraft,
        account: selectedAccount,
        pair: pair,
        direction: document.getElementById('direction').value,
        entryTime: document.getElementById('entryTime').value,
        exitTime: document.getElementById('exitTime').value,
        outcome: document.getElementById('outcome').value,
        riskAmount: parseFloat(document.getElementById('riskAmount').value) || 0,
        initialRR: document.getElementById('initialRR').value,
        actualR: parseFloat(document.getElementById('actualR').value) || 0,
        pnlDollar: parseFloat(document.getElementById('pnlDollar').value) || 0,
        pnlPercent: document.getElementById('pnlPercent').value,
        setupGrade: document.getElementById('setupGrade').value,
        reasoning: document.getElementById('reasoning').value,
        entryPrice: parseFloat(document.getElementById('entryPrice').value) || 0,
        stopPrice: parseFloat(document.getElementById('stopPrice').value) || 0,
        worstPrice: document.getElementById('worstPrice').value,
        bestPrice: document.getElementById('bestPrice').value,
        didNothing: document.getElementById('didNothing').value,
        demonTags: getSelectedTags('demonTags'),
        exitPlan: document.getElementById('exitPlan').value,
        processScore: parseInt(document.getElementById('processScore').value),
        followedPlan: document.getElementById('followedPlan').value,
        wrongAction: document.getElementById('wrongAction').value,
        negCause: document.getElementById('negCause').value,
        improvement: document.getElementById('improvement').value,
        convictionScore: parseInt(document.getElementById('convictionScore').value),
        trustFactors: document.getElementById('trustFactors').value,
        emotionsPresent: document.getElementById('emotionsPresent').value,
        emotionsBefore: getSelectedTags('emotionsBefore'),
        emotionsDuring: getSelectedTags('emotionsDuring'),
        emotionsAfter: getSelectedTags('emotionsAfter'),
        afterExit: document.getElementById('afterExit').value,
        exitLogical: document.getElementById('exitLogical').value,
        manageDifferent: document.getElementById('manageDifferent').value,
        images: allImages
    };

    // Save to the selected account
    if (!accounts[selectedAccount]) accounts[selectedAccount] = { name: 'Unknown', balance: 10000, trades: [] };

    if (editId) {
        const idx = accounts[selectedAccount].trades.findIndex(t => t.id === parseInt(editId));
        if (idx !== -1) accounts[selectedAccount].trades[idx] = trade;
        else accounts[selectedAccount].trades.push(trade);
    } else {
        accounts[selectedAccount].trades.push(trade);
    }

    if (selectedAccount === currentAccount) trades = accounts[currentAccount].trades;

    // Save to Supabase
    await saveTradeToDb(trade);
    saveData();
    hideTradeForm();
    renderTrades();
    updateDashboard();
    console.log('Trade saved:', trade.id);    } finally {
        isSavingTrade = false;
    }

}

function editTrade(id) {
    const trade = trades.find(t => t.id === id);
    if (!trade) return;

    document.getElementById('editTradeId').value = trade.id;
    document.getElementById('pair').value = trade.pair || '';
    document.getElementById('direction').value = trade.direction || 'LONG';
    document.getElementById('entryTime').value = trade.entryTime || '';
    document.getElementById('exitTime').value = trade.exitTime || '';
    document.getElementById('outcome').value = trade.outcome || '';
    document.getElementById('riskAmount').value = trade.riskAmount || '';
    document.getElementById('initialRR').value = trade.initialRR || '';
    document.getElementById('actualR').value = trade.actualR || '';
    document.getElementById('pnlDollar').value = trade.pnlDollar || '';
    document.getElementById('pnlPercent').value = trade.pnlPercent || '';
    document.getElementById('setupGrade').value = trade.setupGrade || 'A';
    document.getElementById('reasoning').value = trade.reasoning || '';
    document.getElementById('entryPrice').value = trade.entryPrice || '';
    document.getElementById('stopPrice').value = trade.stopPrice || '';
    document.getElementById('worstPrice').value = trade.worstPrice || '';
    document.getElementById('bestPrice').value = trade.bestPrice || '';
    document.getElementById('didNothing').value = trade.didNothing || '';
    document.getElementById('exitPlan').value = trade.exitPlan || '';
    document.getElementById('processScore').value = trade.processScore || 5;
    document.getElementById('processVal').innerText = trade.processScore || 5;
    document.getElementById('followedPlan').value = trade.followedPlan || 'YES';
    document.getElementById('wrongAction').value = trade.wrongAction || '';
    document.getElementById('negCause').value = trade.negCause || '';
    document.getElementById('improvement').value = trade.improvement || '';
    document.getElementById('convictionScore').value = trade.convictionScore || 3;
    document.getElementById('convictionVal').innerText = trade.convictionScore || 3;
    document.getElementById('trustFactors').value = trade.trustFactors || '';
    document.getElementById('emotionsPresent').value = trade.emotionsPresent || '';
    document.getElementById('afterExit').value = trade.afterExit || '';
    document.getElementById('exitLogical').value = trade.exitLogical || 'YES';
    document.getElementById('manageDifferent').value = trade.manageDifferent || '';

    document.querySelectorAll('.tag.selected').forEach(t => t.classList.remove('selected'));
    (trade.demonTags || []).forEach(tag => {
        const el = Array.from(document.querySelectorAll('#demonTags .tag')).find(t => t.textContent === tag);
        if (el) el.classList.add('selected');
    });
    (trade.emotionsBefore || []).forEach(tag => {
        const el = Array.from(document.querySelectorAll('#emotionsBefore .tag')).find(t => t.textContent === tag);
        if (el) el.classList.add('selected');
    });
    (trade.emotionsDuring || []).forEach(tag => {
        const el = Array.from(document.querySelectorAll('#emotionsDuring .tag')).find(t => t.textContent === tag);
        if (el) el.classList.add('selected');
    });
    (trade.emotionsAfter || []).forEach(tag => {
        const el = Array.from(document.querySelectorAll('#emotionsAfter .tag')).find(t => t.textContent === tag);
        if (el) el.classList.add('selected');
    });

    // Load existing images
    pendingTradeImages = [];
    const preview = document.getElementById('tradeImagePreview');
    if (preview) {
        const images = trade.images || [];
        if (images.length > 0) {
            const cacheKey = 'edit_' + trade.id;
            imageViewerCache[cacheKey] = images;
            preview.innerHTML = images.map((img, idx) => `
                <div style="position:relative;display:inline-block;">
                    <img src="${img}" style="width:80px;height:80px;object-fit:cover;border:1px solid #333;cursor:pointer;" onclick="openImageViewer(imageViewerCache['${cacheKey}'], ${idx})">
                    <button onclick="removeExistingTradeImage(${trade.id}, ${idx})" style="position:absolute;top:2px;right:2px;width:16px;height:16px;border-radius:50%;background:rgba(0,0,0,0.6);color:#888;border:none;cursor:pointer;font-size:10px;padding:0;line-height:16px;"></button>
                </div>
            `).join('');
        } else {
            preview.innerHTML = '';
        }
    }

    calcMAE();
    document.getElementById('tradeForm').style.display = 'block';
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function removeExistingTradeImage(tradeId, imgIdx) {
    const trade = trades.find(t => t.id === tradeId);
    if (trade && trade.images) {
        trade.images.splice(imgIdx, 1);
        // Re-render the preview
        const preview = document.getElementById('tradeImagePreview');
        if (preview && trade.images.length > 0) {
            const cacheKey = 'edit_' + trade.id;
            imageViewerCache[cacheKey] = trade.images;
            preview.innerHTML = trade.images.map((img, idx) => `
                <div style="position:relative;display:inline-block;">
                    <img src="${img}" style="width:80px;height:80px;object-fit:cover;border:1px solid #333;cursor:pointer;" onclick="openImageViewer(imageViewerCache['${cacheKey}'], ${idx})">
                    <button onclick="removeExistingTradeImage(${trade.id}, ${idx})" style="position:absolute;top:2px;right:2px;width:16px;height:16px;border-radius:50%;background:rgba(0,0,0,0.6);color:#888;border:none;cursor:pointer;font-size:10px;padding:0;line-height:16px;"></button>
                </div>
            `).join('');
        } else if (preview) {
            preview.innerHTML = '';
        }
    }
}

async function deleteTrade(id) {
    if (!confirm('Delete this trade?')) return;
    await deleteTradeFromDb(id);
    trades = trades.filter(t => t.id !== id);
    accounts[currentAccount].trades = trades;
    saveData();
    renderTrades();
    updateDashboard();
}

function showTradeDetail(id) {
    if (!id) return;
    // Navigate to trades page
    showPage('trades', document.querySelector('.nav-item:nth-child(2)'));
    // Wait for render then find and expand the trade card
    setTimeout(() => {
        const cards = document.querySelectorAll('.trade-card');
        cards.forEach(card => {
            if (card.onclick && card.innerHTML.includes(`editTrade(${id})`)) {
                card.classList.add('expanded');
                card.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        });
    }, 100);
}

function getWeekStart(dateStr) {
    const date = new Date(dateStr);
    const day = date.getDay();
    const diff = date.getDate() - day + (day === 0 ? -6 : 1); // Adjust to Monday
    const monday = new Date(date.setDate(diff));
    return monday.toISOString().split('T')[0];
}

function formatWeekRange(mondayStr) {
    const monday = new Date(mondayStr);
    const sunday = new Date(monday);
    sunday.setDate(monday.getDate() + 6);

    const options = { month: 'short', day: 'numeric' };
    const startStr = monday.toLocaleDateString('en-US', options);
    const endStr = sunday.toLocaleDateString('en-US', options);

    return `WEEK OF ${startStr.toUpperCase()} - ${endStr.toUpperCase()}`;
}

function renderTrades() {
    const list = document.getElementById('tradeList');
    if (trades.length === 0) {
        list.innerHTML = '<div style="text-align:center;color:#444;padding:40px;">NO TRADES</div>';
        return;
    }

    // Group by week (Monday start)
    const grouped = {};
    trades.forEach(t => {
        const date = t.exitTime || t.entryTime || new Date().toISOString().split('T')[0];
        const weekStart = getWeekStart(date);
        if (!grouped[weekStart]) grouped[weekStart] = [];
        grouped[weekStart].push(t);
    });

    let html = '';
    Object.keys(grouped).sort().reverse().forEach(weekStart => {
        const weekLabel = formatWeekRange(weekStart);
        html += `<div class="period-header">${weekLabel}</div>`;
        grouped[weekStart].reverse().forEach(t => {
            const outcomeClass = t.isDraft ? 'draft' : (t.outcome ? t.outcome.toLowerCase() : '');
            const outcomeLabel = t.isDraft ? 'DRAFT' : (t.outcome === 'WIN' ? 'W' : t.outcome === 'LOSS' ? 'L' : 'BE');
            html += `
                <div class="trade-card ${outcomeClass}" onclick="this.classList.toggle('expanded')">
                    <div class="trade-header">
                        <span class="trade-ticker">${t.pair ? t.pair.split('/')[0] : 'NO PAIR'} - ${outcomeLabel}</span>
                        <span style="color:${t.pnlDollar >= 0 ? '#e65c00' : '#555'}">
                            ${t.pnlDollar >= 0 ? '+' : ''}$${t.pnlDollar || 0} (${t.actualR || 0}R)
                        </span>
                    </div>
                    <div class="trade-meta">
                        <span>${t.direction}</span>
                        <span>PROC:${t.processScore || '-'}</span>
                        <span>CONV:${t.convictionScore || '-'}</span>
                        <span>GRADE:${t.setupGrade || '-'}</span>
                    </div>
                    <div class="trade-details">
                        <div class="detail-row"><span class="detail-label">ENTRY:</span> <span class="detail-value">${t.entryTime || '-'}</span></div>
                        <div class="detail-row"><span class="detail-label">EXIT:</span> <span class="detail-value">${t.exitTime || '-'}</span></div>
                        <div class="detail-row"><span class="detail-label">RISK:</span> <span class="detail-value">$${t.riskAmount || 0}</span></div>
                        <div class="detail-row"><span class="detail-label">REASONING:</span> <span class="detail-value">${t.reasoning || '-'}</span></div>
                        <div class="detail-row"><span class="detail-label">EXIT PLAN:</span> <span class="detail-value">${t.exitPlan || '-'}</span></div>
                        <div class="detail-row"><span class="detail-label">DEMONS:</span> <span class="detail-value">${(t.demonTags || []).join(', ') || '-'}</span></div>
                        <div class="detail-row"><span class="detail-label">FOLLOWED PLAN:</span> <span class="detail-value">${t.followedPlan || '-'}</span></div>
                        <div class="detail-row"><span class="detail-label">WHAT WRONG:</span> <span class="detail-value">${t.wrongAction || '-'}</span></div>
                        <div class="detail-row"><span class="detail-label">IMPROVEMENT:</span> <span class="detail-value">${t.improvement || '-'}</span></div>
                        <div class="detail-row"><span class="detail-label">TRUST FACTORS:</span> <span class="detail-value">${t.trustFactors || '-'}</span></div>
                        <div class="detail-row"><span class="detail-label">AFTER EXIT:</span> <span class="detail-value">${t.afterExit || '-'}</span></div>
                        ${(t.images && t.images.length > 0) ? (() => {
                            const cacheKey = 'trade_' + t.id;
                            imageViewerCache[cacheKey] = t.images;
                            return `
                            <div class="detail-row" style="margin-top:10px;">
                                <span class="detail-label">CHART IMAGES:</span>
                                <div style="display:flex;flex-wrap:wrap;gap:10px;margin-top:5px;">
                                    ${t.images.map((img, idx) => `
                                        <img src="${img}" style="width:80px;height:80px;object-fit:cover;border:1px solid #1a1a1a;cursor:pointer;" onclick="event.stopPropagation();openImageViewer(imageViewerCache['${cacheKey}'], ${idx})">
                                    `).join('')}
                                </div>
                            </div>
                        `;})() : ''}
                        <div style="margin-top:10px;display:flex;gap:10px;">
                            <button onclick="event.stopPropagation();editTrade(${t.id})">EDIT</button>
                            <button class="btn-danger" onclick="event.stopPropagation();deleteTrade(${t.id})">DELETE</button>
                        </div>
                    </div>
                </div>
            `;
        });
    });
    list.innerHTML = html;
}

// ========== DASHBOARD ==========
function setFilter(filter, btn) {
    currentFilter = filter;
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    updateDashboard();
}

function filterTrades() {
    const now = new Date();
    return trades.filter(t => {
        if (t.isDraft) return false;
        const date = new Date(t.exitTime || t.entryTime);
        if (isNaN(date)) return currentFilter === 'all';
        if (currentFilter === 'week') return date >= new Date(now - 7*24*60*60*1000);
        if (currentFilter === 'month') return date >= new Date(now - 30*24*60*60*1000);
        if (currentFilter === 'quarter') return date >= new Date(now - 90*24*60*60*1000);
        return true;
    });
}

function updateDashboard() {
    const filtered = filterTrades();
    const balance = accounts[currentAccount]?.balance || 10000;

    if (filtered.length === 0) {
        document.getElementById('statsGrid').innerHTML = `
            <div class="stat-box"><div class="stat-label">WIN RATE</div><div class="stat-value">--</div></div>
            <div class="stat-box"><div class="stat-label">PROFIT FACTOR</div><div class="stat-value">--</div></div>
            <div class="stat-box"><div class="stat-label">TOTAL PNL</div><div class="stat-value">--</div></div>
            <div class="stat-box"><div class="stat-label">MAX DRAWDOWN</div><div class="stat-value">--</div></div>
            <div class="stat-box"><div class="stat-label">AVG WIN</div><div class="stat-value">--</div></div>
            <div class="stat-box"><div class="stat-label">AVG LOSS</div><div class="stat-value">--</div></div>
            <div class="stat-box"><div class="stat-label">BEST TRADE</div><div class="stat-value">--</div></div>
            <div class="stat-box"><div class="stat-label">WORST TRADE</div><div class="stat-value">--</div></div>
            <div class="stat-box"><div class="stat-label">FACTOR RATE</div><div class="stat-value">--</div></div>
            <div class="stat-box"><div class="stat-label">SHARPE</div><div class="stat-value">--</div></div>
            <div class="stat-box"><div class="stat-label">WIN STREAK</div><div class="stat-value">--</div></div>
            <div class="stat-box"><div class="stat-label">LOSS STREAK</div><div class="stat-value">--</div></div>
            <div class="stat-box"><div class="stat-label">PROCESS</div><div class="stat-value">--</div></div>
            <div class="stat-box"><div class="stat-label">CONVICTION</div><div class="stat-value">--</div></div>
            <div class="stat-box"><div class="stat-label">TRADES</div><div class="stat-value">0</div></div>
            <div class="stat-box"><div class="stat-label">LONG/SHORT</div><div class="stat-value">--</div></div>
        `;
        document.getElementById('insightsContainer').innerHTML = '<div style="color:#444;padding:15px;">ADD 3+ TRADES FOR INSIGHTS</div>';
        document.getElementById('tickerGrid').innerHTML = '<div style="color:#444;">NO DATA</div>';
        drawChart([]);
        return;
    }

    const winTrades = filtered.filter(t => t.outcome === 'WIN');
    const lossTrades = filtered.filter(t => t.outcome === 'LOSS');
    const wins = winTrades.length;
    const losses = lossTrades.length;
    const wr = ((wins / filtered.length) * 100).toFixed(1);
    const avgR = (filtered.reduce((s, t) => s + (t.actualR || 0), 0) / filtered.length).toFixed(2);
    const totalPnl = filtered.reduce((s, t) => s + (t.pnlDollar || 0), 0);
    const pnlPct = ((totalPnl / balance) * 100).toFixed(2);

    // Profit Factor (gross wins / gross losses)
    const grossWins = winTrades.reduce((s, t) => s + (t.pnlDollar || 0), 0);
    const grossLosses = Math.abs(lossTrades.reduce((s, t) => s + (t.pnlDollar || 0), 0));
    const profitFactor = grossLosses > 0 ? (grossWins / grossLosses).toFixed(2) : grossWins > 0 ? '' : '0';

    // Avg Win / Avg Loss
    const avgWin = wins > 0 ? (grossWins / wins).toFixed(0) : 0;
    const avgLoss = losses > 0 ? (grossLosses / losses).toFixed(0) : 0;

    // Best / Worst Trade
    const sortedByPnl = [...filtered].sort((a, b) => (b.pnlDollar || 0) - (a.pnlDollar || 0));
    const bestTrade = sortedByPnl[0];
    const worstTrade = sortedByPnl[sortedByPnl.length - 1];

    // Max Drawdown (peak to trough)
    let maxDrawdown = 0;
    let peak = 0;
    let runningPnl = 0;
    const sortedByDate = [...filtered].sort((a, b) => new Date(a.exitTime || a.entryTime) - new Date(b.exitTime || b.entryTime));
    sortedByDate.forEach(t => {
        runningPnl += (t.pnlDollar || 0);
        if (runningPnl > peak) peak = runningPnl;
        const drawdown = peak - runningPnl;
        if (drawdown > maxDrawdown) maxDrawdown = drawdown;
    });

    // Win/Loss Streaks
    let currentStreak = 0;
    let maxWinStreak = 0;
    let maxLossStreak = 0;
    let lastOutcome = null;
    sortedByDate.forEach(t => {
        if (t.outcome === lastOutcome) {
            currentStreak++;
        } else {
            currentStreak = 1;
            lastOutcome = t.outcome;
        }
        if (t.outcome === 'WIN' && currentStreak > maxWinStreak) maxWinStreak = currentStreak;
        if (t.outcome === 'LOSS' && currentStreak > maxLossStreak) maxLossStreak = currentStreak;
    });

    const returns = filtered.map(t => t.actualR || 0);
    const avgReturn = returns.reduce((a, b) => a + b, 0) / returns.length;
    const stdDev = Math.sqrt(returns.map(r => Math.pow(r - avgReturn, 2)).reduce((a, b) => a + b, 0) / returns.length);
    const sharpe = stdDev > 0 ? (avgReturn / stdDev).toFixed(2) : 0;

    const avgProcess = (filtered.reduce((s, t) => s + (t.processScore || 0), 0) / filtered.length).toFixed(1);
    const avgConviction = (filtered.reduce((s, t) => s + (t.convictionScore || 0), 0) / filtered.length).toFixed(1);

    const longs = filtered.filter(t => t.direction === 'LONG').length;
    const shorts = filtered.length - longs;
    const longPct = ((longs / filtered.length) * 100).toFixed(0);

    const largerPct = Math.max(longPct, 100 - longPct);
    const largerLabel = longPct >= 50 ? 'L' : 'S';

    // Avg Hold Time (in days/hours)
    let totalHoldMs = 0;
    let holdCount = 0;
    filtered.forEach(t => {
        if (t.entryTime && t.exitTime) {
            const entry = new Date(t.entryTime);
            const exit = new Date(t.exitTime);
            if (!isNaN(entry) && !isNaN(exit)) {
                totalHoldMs += exit - entry;
                holdCount++;
            }
        }
    });
    let avgHoldTime = '--';
    if (holdCount > 0) {
        const avgMs = totalHoldMs / holdCount;
        const hours = avgMs / (1000 * 60 * 60);
        if (hours < 24) {
            avgHoldTime = hours.toFixed(1) + 'h';
        } else {
            avgHoldTime = (hours / 24).toFixed(1) + 'd';
        }
    }

    document.getElementById('statsGrid').innerHTML = `
        <div class="stat-box clickable" onclick="showStatBreakdown('winrate')"><div class="stat-label">WIN RATE</div><div class="stat-value">${wr}%</div><div class="stat-meta">${wins}W / ${losses}L</div></div>
        <div class="stat-box clickable" onclick="showStatBreakdown('profitfactor')"><div class="stat-label">PROFIT FACTOR</div><div class="stat-value" style="color:${profitFactor >= 1.5 ? '#e65c00' : profitFactor >= 1 ? '#888' : '#555'}">${profitFactor}</div><div class="stat-meta">WIN$ / LOSS$</div></div>
        <div class="stat-box clickable" onclick="showStatBreakdown('pnl')"><div class="stat-label">TOTAL PNL</div><div class="stat-value" style="color:${totalPnl>=0?'#e65c00':'#555'}">${totalPnl>=0?'+':''}$${totalPnl.toFixed(0)}</div><div class="stat-meta">${pnlPct}%</div></div>
        <div class="stat-box clickable" onclick="showStatBreakdown('drawdown')"><div class="stat-label">MAX DRAWDOWN</div><div class="stat-value" style="color:#555">-$${maxDrawdown.toFixed(0)}</div><div class="stat-meta">PEAK TO TROUGH</div></div>
        <div class="stat-box clickable" onclick="showStatBreakdown('avgwin')"><div class="stat-label">AVG WIN</div><div class="stat-value" style="color:#e65c00">+$${avgWin}</div></div>
        <div class="stat-box clickable" onclick="showStatBreakdown('avgloss')"><div class="stat-label">AVG LOSS</div><div class="stat-value" style="color:#555">-$${avgLoss}</div></div>
        <div class="stat-box clickable" onclick="showTradeDetail(${bestTrade?.id})"><div class="stat-label">BEST TRADE</div><div class="stat-value" style="color:#e65c00">+$${(bestTrade?.pnlDollar || 0).toFixed(0)}</div><div class="stat-meta">${bestTrade?.pair?.split('/')[0] || '--'}</div></div>
        <div class="stat-box clickable" onclick="showTradeDetail(${worstTrade?.id})"><div class="stat-label">WORST TRADE</div><div class="stat-value" style="color:#555">${(worstTrade?.pnlDollar || 0) >= 0 ? '+' : ''}$${(worstTrade?.pnlDollar || 0).toFixed(0)}</div><div class="stat-meta">${worstTrade?.pair?.split('/')[0] || '--'}</div></div>
        <div class="stat-box clickable" onclick="showFactorRateModal()"><div class="stat-label">FACTOR RATE</div><div class="stat-value">${avgR}R</div><div class="stat-meta">AVG R MULTIPLE</div></div>
        <div class="stat-box clickable" onclick="showStatBreakdown('holdtime')"><div class="stat-label">AVG HOLD</div><div class="stat-value">${avgHoldTime}</div><div class="stat-meta">ENTRY TO EXIT</div></div>
        <div class="stat-box clickable" onclick="showStatBreakdown('streaks')"><div class="stat-label">WIN STREAK</div><div class="stat-value" style="color:#e65c00">${maxWinStreak}</div><div class="stat-meta">BEST RUN</div></div>
        <div class="stat-box clickable" onclick="showStatBreakdown('streaks')"><div class="stat-label">LOSS STREAK</div><div class="stat-value" style="color:#555">${maxLossStreak}</div><div class="stat-meta">WORST RUN</div></div>
        <div class="stat-box clickable" onclick="showStatBreakdown('process')"><div class="stat-label">PROCESS</div><div class="stat-value">${avgProcess}</div></div>
        <div class="stat-box clickable" onclick="showStatBreakdown('conviction')"><div class="stat-label">CONVICTION</div><div class="stat-value">${avgConviction}</div></div>
        <div class="stat-box clickable" onclick="showStatBreakdown('trades')"><div class="stat-label">TRADES</div><div class="stat-value">${filtered.length}</div></div>
        <div class="stat-box clickable" onclick="showStatBreakdown('direction')"><div class="stat-label">LONG/SHORT</div>${drawRatioRing(largerPct, largerLabel)}<div class="stat-meta">${longs}L / ${shorts}S</div></div>
    `;

    // Store filtered trades for modal access
    window.currentFilteredTrades = filtered;

    generateInsights(filtered);
    generateTickerGrid(filtered);
    drawChart(filtered);
    updateBiasSummary();
}

function generateInsights(filtered) {
    let html = '';
    const wins = filtered.filter(t => t.outcome === 'WIN');
    const losses = filtered.filter(t => t.outcome === 'LOSS');
    const overallWR = filtered.length > 0 ? (wins.length / filtered.length * 100).toFixed(0) : 0;

    // === EDGE DETECTION ===
    html += '<div style="margin-bottom:15px;font-size:10px;color:#e65c00;border-bottom:1px solid #1a1a1a;padding-bottom:8px;letter-spacing:0.15em;">EDGE ANALYSIS</div>';

    // Grade A Analysis
    const gradeA = filtered.filter(t => t.setupGrade === 'A');
    if (gradeA.length >= 2) {
        const wr = ((gradeA.filter(t => t.outcome === 'WIN').length / gradeA.length) * 100).toFixed(0);
        const avgR = (gradeA.reduce((s, t) => s + (t.actualR || 0), 0) / gradeA.length).toFixed(2);
        const isEdge = wr > overallWR;
        html += `<div class="insight" style="border-left-color:${isEdge ? '#e65c00' : '#333'}"><div class="insight-title">${isEdge ? '[EDGE]' : ''} GRADE A SETUPS</div><div class="insight-text">${wr}% WR | ${avgR}R avg | ${gradeA.length} trades</div></div>`;
    }

    // High Conviction Analysis
    const highConv = filtered.filter(t => t.convictionScore >= 4);
    const lowConv = filtered.filter(t => t.convictionScore <= 2);
    if (highConv.length >= 2) {
        const highWR = ((highConv.filter(t => t.outcome === 'WIN').length / highConv.length) * 100).toFixed(0);
        const highAvgR = (highConv.reduce((s, t) => s + (t.actualR || 0), 0) / highConv.length).toFixed(2);
        const isEdge = highWR > overallWR;
        html += `<div class="insight" style="border-left-color:${isEdge ? '#e65c00' : '#333'}"><div class="insight-title">${isEdge ? '[EDGE]' : ''} HIGH CONVICTION (4-5)</div><div class="insight-text">${highWR}% WR | ${highAvgR}R avg | ${highConv.length} trades</div></div>`;
    }

    // High Process Analysis
    const highProc = filtered.filter(t => t.processScore >= 8);
    if (highProc.length >= 2) {
        const wr = ((highProc.filter(t => t.outcome === 'WIN').length / highProc.length) * 100).toFixed(0);
        const avgR = (highProc.reduce((s, t) => s + (t.actualR || 0), 0) / highProc.length).toFixed(2);
        const isEdge = wr > overallWR;
        html += `<div class="insight" style="border-left-color:${isEdge ? '#e65c00' : '#333'}"><div class="insight-title">${isEdge ? '[EDGE]' : ''} HIGH PROCESS (8-10)</div><div class="insight-text">${wr}% WR | ${avgR}R avg | ${highProc.length} trades</div></div>`;
    }

    // Direction Analysis
    const longs = filtered.filter(t => t.direction === 'LONG');
    const shorts = filtered.filter(t => t.direction === 'SHORT');
    if (longs.length >= 2 && shorts.length >= 2) {
        const longWR = ((longs.filter(t => t.outcome === 'WIN').length / longs.length) * 100).toFixed(0);
        const shortWR = ((shorts.filter(t => t.outcome === 'WIN').length / shorts.length) * 100).toFixed(0);
        const betterDir = longWR > shortWR ? 'LONG' : 'SHORT';
        const diff = Math.abs(longWR - shortWR);
        if (diff >= 10) {
            html += `<div class="insight" style="border-left-color:#e65c00"><div class="insight-title">[EDGE] ${betterDir} BIAS</div><div class="insight-text">LONG: ${longWR}% WR | SHORT: ${shortWR}% WR | ${diff}% difference</div></div>`;
        }
    }

    // === LEAK DETECTION ===
    html += '<div style="margin:20px 0 15px 0;font-size:10px;color:#555;border-bottom:1px solid #1a1a1a;padding-bottom:8px;letter-spacing:0.15em;">LEAK ANALYSIS</div>';

    // Demon Analysis - Find costly demons
    const demonPnL = {};
    filtered.forEach(t => {
        (t.demonTags || []).forEach(d => {
            if (!demonPnL[d]) demonPnL[d] = { count: 0, pnl: 0, losses: 0 };
            demonPnL[d].count++;
            demonPnL[d].pnl += t.pnlDollar || 0;
            if (t.outcome === 'LOSS') demonPnL[d].losses++;
        });
    });

    const worstDemons = Object.entries(demonPnL).sort((a, b) => a[1].pnl - b[1].pnl);
    if (worstDemons.length > 0 && worstDemons[0][1].pnl < 0) {
        const [demon, data] = worstDemons[0];
        html += `<div class="insight" style="border-left-color:#555"><div class="insight-title">[LEAK] ${demon}</div><div class="insight-text">${data.count} trades | $${data.pnl.toFixed(0)} P/L | ${data.losses} losses</div></div>`;
    }

    // Conviction Inverse Warning
    if (highConv.length >= 2 && lowConv.length >= 2) {
        const highWR = (highConv.filter(t => t.outcome === 'WIN').length / highConv.length * 100);
        const lowWR = (lowConv.filter(t => t.outcome === 'WIN').length / lowConv.length * 100);
        if (lowWR > highWR + 10) {
            html += `<div class="insight" style="border-left-color:#555"><div class="insight-title">[LEAK] CONVICTION INVERSE</div><div class="insight-text">Low conviction (${lowWR.toFixed(0)}% WR) outperforms high conviction (${highWR.toFixed(0)}% WR)</div></div>`;
        }
    }

    // Low Process Analysis
    const lowProc = filtered.filter(t => t.processScore <= 4);
    if (lowProc.length >= 2) {
        const wr = ((lowProc.filter(t => t.outcome === 'WIN').length / lowProc.length) * 100).toFixed(0);
        const totalLoss = lowProc.reduce((s, t) => s + (t.pnlDollar < 0 ? t.pnlDollar : 0), 0);
        if (wr < overallWR) {
            html += `<div class="insight" style="border-left-color:#555"><div class="insight-title">[LEAK] LOW PROCESS (1-4)</div><div class="insight-text">${wr}% WR | $${totalLoss.toFixed(0)} lost | ${lowProc.length} trades</div></div>`;
        }
    }

    // Followed Plan Analysis
    const notFollowed = filtered.filter(t => t.followedPlan === 'NO');
    if (notFollowed.length >= 2) {
        const wr = ((notFollowed.filter(t => t.outcome === 'WIN').length / notFollowed.length) * 100).toFixed(0);
        const totalLoss = notFollowed.reduce((s, t) => s + (t.pnlDollar || 0), 0);
        html += `<div class="insight" style="border-left-color:#444"><div class="insight-title">[WARNING] PLAN DEVIATION</div><div class="insight-text">${notFollowed.length} trades didn't follow plan | ${wr}% WR | $${totalLoss.toFixed(0)}</div></div>`;
    }

    // Grade F/D Analysis
    const lowGrade = filtered.filter(t => t.setupGrade === 'D' || t.setupGrade === 'F');
    if (lowGrade.length >= 2) {
        const wr = ((lowGrade.filter(t => t.outcome === 'WIN').length / lowGrade.length) * 100).toFixed(0);
        const totalPnl = lowGrade.reduce((s, t) => s + (t.pnlDollar || 0), 0);
        html += `<div class="insight" style="border-left-color:#555"><div class="insight-title">[LEAK] LOW GRADE SETUPS (D/F)</div><div class="insight-text">${wr}% WR | $${totalPnl.toFixed(0)} P/L | ${lowGrade.length} trades</div></div>`;
    }

    // Time of Day Analysis (if enough data)
    const morningTrades = filtered.filter(t => {
        const h = new Date(t.entryTime).getHours();
        return h >= 9 && h < 12;
    });
    const afternoonTrades = filtered.filter(t => {
        const h = new Date(t.entryTime).getHours();
        return h >= 12 && h < 16;
    });

    document.getElementById('insightsContainer').innerHTML = html || '<div style="color:#444;padding:15px;">Add 3+ trades for AI analysis</div>';
}

function generateTickerGrid(filtered) {
    const tickers = {};
    filtered.forEach(t => {
        const ticker = (t.pair || '').split('/')[0] || 'UNKNOWN';
        if (!tickers[ticker]) tickers[ticker] = { wins: 0, losses: 0, pnl: 0, r: 0, long: 0, short: 0 };
        if (t.outcome === 'WIN') tickers[ticker].wins++;
        if (t.outcome === 'LOSS') tickers[ticker].losses++;
        tickers[ticker].pnl += t.pnlDollar || 0;
        tickers[ticker].r += t.actualR || 0;
        if (t.direction === 'LONG') tickers[ticker].long++;
        if (t.direction === 'SHORT') tickers[ticker].short++;
    });

    document.getElementById('tickerGrid').innerHTML = Object.entries(tickers)
        .sort((a, b) => b[1].pnl - a[1].pnl)
        .map(([ticker, data]) => {
            const total = data.wins + data.losses;
            const wr = total > 0 ? ((data.wins / total) * 100).toFixed(0) : 0;
            const avgR = total > 0 ? (data.r / total).toFixed(1) : 0;
            const longPct = total > 0 ? ((data.long / total) * 100).toFixed(0) : 0;
            const shortPct = 100 - longPct;
            return `
                <div class="ticker-box ${data.pnl >= 0 ? 'positive' : 'negative'}" onclick="toggleTickerDetails('${ticker}')" id="ticker-${ticker}">
                    <div class="ticker-main">${ticker}<br><span style="font-size:10px;">${data.pnl>=0?'+':''}$${data.pnl.toFixed(0)}</span></div>
                    <div class="ticker-details">
                        <div>WR: ${wr}% (${data.wins}W-${data.losses}L)</div>
                        <div>AVG R: ${avgR}</div>
                        <div>PNL: ${data.pnl >= 0 ? '+' : ''}$${data.pnl.toFixed(0)}</div>
                        <div>LONG: ${longPct}% | SHORT: ${shortPct}%</div>
                    </div>
                </div>
            `;
        }).join('') || '<div style="color:#444;">NO DATA</div>';
}

function toggleTickerDetails(ticker) {
    const box = document.getElementById(`ticker-${ticker}`);
    if (box) box.classList.toggle('expanded');
}

function drawChart(filtered) {
    const canvas = document.getElementById('equityChart');
    const ctx = canvas.getContext('2d');
    const container = document.getElementById('chartContainer');

    // High DPI support for crisp rendering
    const dpr = window.devicePixelRatio || 1;
    const width = container.offsetWidth;
    const height = 280;

    canvas.width = width * dpr;
    canvas.height = height * dpr;
    canvas.style.width = width + 'px';
    canvas.style.height = height + 'px';
    ctx.scale(dpr, dpr);

    ctx.fillStyle = '#0a0a0a';
    ctx.fillRect(0, 0, width, height);

    const balance = accounts[currentAccount]?.balance || 10000;
    const padding = 70;
    const rightPadding = 120;

    if (filtered.length === 0) {
        ctx.strokeStyle = '#1a1a1a';
        ctx.beginPath();
        ctx.moveTo(padding, height/2);
        ctx.lineTo(width-20, height/2);
        ctx.stroke();
        ctx.fillStyle = '#666';
        ctx.font = '12px SF Mono, Consolas, monospace';
        ctx.fillText('$' + balance.toLocaleString(), 10, height/2 + 4);
        chartPoints = [];
        return;
    }

    const sorted = [...filtered].sort((a, b) => new Date(a.exitTime || a.entryTime) - new Date(b.exitTime || b.entryTime));

    let equity = 0;
    chartPoints = [{ x: padding, y: height/2, bal: balance, pnl: 0, date: 'START' }];
    sorted.forEach((t, i) => {
        equity += t.pnlDollar || 0;
        chartPoints.push({
            x: padding + ((i+1) / sorted.length) * (width - padding - rightPadding),
            bal: balance + equity,
            pnl: equity,
            date: t.exitTime || t.entryTime,
            trade: t
        });
    });

    const allBals = chartPoints.map(p => p.bal);
    const maxBal = Math.max(...allBals);
    const minBal = Math.min(...allBals);
    const range = maxBal - minBal || balance * 0.1;

    chartPoints.forEach(p => { p.y = height - 30 - ((p.bal - minBal) / range) * (height - 60); });

    // Grid and Y-axis labels
    ctx.strokeStyle = '#1a1a1a';
    ctx.lineWidth = 1;
    ctx.fillStyle = '#666';
    ctx.font = '12px SF Mono, Consolas, monospace';
    ctx.textAlign = 'right';
    for (let i = 0; i <= 5; i++) {
        const val = minBal + (i * range / 5);
        const y = height - 30 - (i * (height - 60) / 5);
        ctx.beginPath();
        ctx.moveTo(padding, y);
        ctx.lineTo(width - rightPadding, y);
        ctx.stroke();
        ctx.fillText('$' + val.toLocaleString(undefined, {maximumFractionDigits: 0}), padding - 8, y + 4);
    }

    // Baseline
    const baseY = height - 30 - ((balance - minBal) / range) * (height - 60);
    ctx.strokeStyle = '#444';
    ctx.lineWidth = 1.5;
    ctx.setLineDash([8, 6]);
    ctx.beginPath();
    ctx.moveTo(padding, baseY);
    ctx.lineTo(width - rightPadding, baseY);
    ctx.stroke();
    ctx.setLineDash([]);

    // Curve with color per segment - thicker line
    ctx.lineWidth = 2.5;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    for (let i = 0; i < chartPoints.length - 1; i++) {
        const p1 = chartPoints[i];
        const p2 = chartPoints[i + 1];
        ctx.strokeStyle = p2.pnl >= 0 ? '#e65c00' : '#555';
        ctx.beginPath();
        ctx.moveTo(p1.x, p1.y);
        ctx.lineTo(p2.x, p2.y);
        ctx.stroke();
    }

    // Draw points on the line
    chartPoints.forEach((p, i) => {
        if (i > 0) {
            ctx.fillStyle = p.pnl >= 0 ? '#e65c00' : '#555';
            ctx.beginPath();
            ctx.arc(p.x, p.y, 3, 0, Math.PI * 2);
            ctx.fill();
        }
    });

    // Final PNL label - positioned in right padding area
    const final = chartPoints[chartPoints.length - 1];
    const pnlPct = ((final.pnl / balance) * 100).toFixed(1);
    ctx.fillStyle = equity >= 0 ? '#e65c00' : '#555';
    ctx.font = 'bold 14px SF Mono, Consolas, monospace';
    ctx.textAlign = 'left';
    const pnlText = `${equity>=0?'+':''}$${equity.toLocaleString(undefined, {maximumFractionDigits: 0})}`;
    const pctText = `(${pnlPct>=0?'+':''}${pnlPct}%)`;
    ctx.fillText(pnlText, final.x + 12, final.y - 4);
    ctx.font = '11px SF Mono, Consolas, monospace';
    ctx.fillStyle = '#666';
    ctx.fillText(pctText, final.x + 12, final.y + 12);

    // X-axis date labels
    ctx.fillStyle = '#888';
    ctx.font = '11px SF Mono, Consolas, monospace';
    ctx.textAlign = 'center';

    if (chartPoints.length > 1) {
        let datePoints = [];
        const numLabels = currentFilter === 'week' ? 7 : currentFilter === 'month' ? 10 : 8;
        const step = Math.max(1, Math.floor((chartPoints.length - 1) / numLabels));
        datePoints = chartPoints.filter((p, i) => i > 0 && i % step === 0);

        if (!datePoints.includes(chartPoints[chartPoints.length - 1])) {
            datePoints.push(chartPoints[chartPoints.length - 1]);
        }

        datePoints.forEach(p => {
            if (p.date && p.date !== 'START') {
                const date = new Date(p.date);
                if (!isNaN(date)) {
                    const m = date.getMonth() + 1;
                    const d = date.getDate();
                    const dateStr = `${m}/${d}`;
                    ctx.fillText(dateStr, p.x, height - 5);

                    // Tick mark
                    ctx.strokeStyle = '#444';
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.moveTo(p.x, height - 32);
                    ctx.lineTo(p.x, height - 20);
                    ctx.stroke();
                }
            }
        });
    }
}

// Chart hover tooltip
document.addEventListener('DOMContentLoaded', function() {
    const chart = document.getElementById('equityChart');
    const tooltip = document.getElementById('chartTooltip');

    chart.addEventListener('mousemove', function(e) {
        const rect = this.getBoundingClientRect();
        const x = e.clientX - rect.left;

        if (chartPoints.length < 2) {
            tooltip.style.display = 'none';
            return;
        }

        let closest = chartPoints[0];
        let minDist = Math.abs(x - closest.x);

        for (let p of chartPoints) {
            const dist = Math.abs(x - p.x);
            if (dist < minDist) {
                minDist = dist;
                closest = p;
            }
        }

        if (minDist < 30) {
            const balance = accounts[currentAccount]?.balance || 10000;
            const pnlPct = ((closest.pnl / balance) * 100).toFixed(1);
            let dateStr = closest.date;
            if (closest.date && closest.date !== 'START') {
                const d = new Date(closest.date);
                if (!isNaN(d)) {
                    dateStr = d.toLocaleDateString();
                }
            }
            tooltip.innerHTML = `
                <div><strong>${dateStr}</strong></div>
                <div>BAL: $${closest.bal.toFixed(0)}</div>
                <div>P/L: ${closest.pnl >= 0 ? '+' : ''}$${closest.pnl.toFixed(0)} (${pnlPct}%)</div>
            `;
            tooltip.style.left = (closest.x - 50) + 'px';
            tooltip.style.top = (closest.y - 60) + 'px';
            tooltip.style.display = 'block';
        } else {
            tooltip.style.display = 'none';
        }
    });

    chart.addEventListener('mouseleave', function() {
        tooltip.style.display = 'none';
    });
});

// ========== COINGECKO API ==========
async function fetchBTCPrice(date) {
    // CoinGecko API - fetch historical price for a specific date
    // Date format: DD-MM-YYYY
    const formattedDate = formatDateForCoinGecko(date);
    const url = `https://api.coingecko.com/api/v3/coins/bitcoin/history?date=${formattedDate}&localization=false`;

    try {
        const response = await fetch(url);
        if (!response.ok) throw new Error('API request failed');
        const data = await response.json();
        return data.market_data?.current_price?.usd || null;
    } catch (e) {
        console.error('CoinGecko API error:', e);
        return null;
    }
}

function formatDateForCoinGecko(dateStr) {
    // Convert YYYY-MM-DD to DD-MM-YYYY (parse manually to avoid timezone issues)
    const [year, month, day] = dateStr.split('-');
    return `${day}-${month}-${year}`;
}

async function fetchWeekPrices(startDate, endDate) {
    // Check if week has ended (end date has passed)
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    // Parse end date manually to avoid timezone issues
    const [year, month, day] = endDate.split('-').map(Number);
    const endDateObj = new Date(year, month - 1, day);
    const weekEnded = endDateObj < today;

    if (!weekEnded) {
        return { weekEnded: false, startPrice: null, endPrice: null };
    }

    const startPrice = await fetchBTCPrice(startDate);
    const endPrice = await fetchBTCPrice(endDate);

    return { weekEnded: true, startPrice, endPrice, startDate, endDate };
}

async function analyzeBias(weekId) {
    const entry = allWeeklyEntries.find(e => e.id === weekId);
    const defaultDayOrder = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];

    // Use entry's activeDays or fallback
    const dayOrder = entry?.activeDays || Object.keys(entry?.days || {}).filter(d => defaultDayOrder.includes(d)).sort((a, b) => defaultDayOrder.indexOf(a) - defaultDayOrder.indexOf(b));

    // Check if any daily bias is set
    const hasDailyBias = dayOrder.some(day => entry?.bias?.[day]?.direction);
    if (!entry || !hasDailyBias) {
        alert('Please set at least one daily bias first');
        return;
    }

    const analyzeBtn = document.getElementById(`analyze-btn-${weekId}`);
    if (analyzeBtn) {
        analyzeBtn.disabled = true;
        analyzeBtn.textContent = 'ANALYZING...';
    }

    try {
        // Get actual start and end dates from entry's days
        const firstDay = dayOrder[0];
        const lastDay = dayOrder[dayOrder.length - 1];
        const startDate = entry.days[firstDay]?.date || entry.weekOf;
        const endDate = entry.days[lastDay]?.date || entry.weekOf;

        const { weekEnded, startPrice, endPrice } = await fetchWeekPrices(startDate, endDate);

        if (!weekEnded) {
            alert('Week has not ended yet. Analysis available after the last day passes.');
            return;
        }

        if (!startPrice || !endPrice) {
            alert('Could not fetch price data. Please try again later.');
            return;
        }

        // Store start/end day names for display
        entry.bias.startDay = firstDay.toUpperCase();
        entry.bias.endDay = lastDay.toUpperCase();

        // Perform text analysis on all journal entries and reasoning
        const textAnalysis = analyzeWeekText(entry, dayOrder);

        // STEP 1: Calculate structured bias score (direction + confidence)
        let structuredScore = 0;
        let structuredWeight = 0;
        const dailyResults = [];

        dayOrder.forEach(day => {
            const dayBias = entry.bias[day];
            if (dayBias?.direction) {
                const confidence = parseInt(dayBias.confidence) || 3;
                let dirScore = 0;
                if (dayBias.direction === 'BULLISH') dirScore = 1;
                else if (dayBias.direction === 'BEARISH') dirScore = -1;
                // NEUTRAL = 0

                structuredScore += dirScore * confidence;
                structuredWeight += confidence;
                dailyResults.push(`${day.slice(0,3).toUpperCase()}:${dayBias.direction.slice(0,4)}`);
            }
        });

        // STEP 2: Calculate text sentiment score
        const textSentiment = textAnalysis.overall.sentiment; // -1 to +1
        const textUncertainty = textAnalysis.overall.uncertainty; // 0 to ~1

        // STEP 3: Combine scores
        // Text sentiment adds/subtracts from base score (weighted at 30% influence)
        // Uncertainty is a soft modifier (max 15% reduction) - informational, not punitive
        const textInfluence = 0.3;
        const uncertaintyPenalty = 1 - (textUncertainty * 0.15); // High uncertainty reduces score by up to 15%

        let combinedScore = 0;
        if (structuredWeight > 0) {
            const normalizedStructured = structuredScore / structuredWeight; // -1 to +1
            // Blend structured bias with text sentiment
            combinedScore = (normalizedStructured * (1 - textInfluence) + textSentiment * textInfluence) * uncertaintyPenalty;
        }

        // STEP 4: Determine aggregate bias from combined score
        let aggregateBias = 'NEUTRAL';
        if (combinedScore > 0.15) aggregateBias = 'BULLISH';
        else if (combinedScore < -0.15) aggregateBias = 'BEARISH';

        const priceChange = ((endPrice - startPrice) / startPrice * 100).toFixed(2);
        const actualDirection = endPrice > startPrice ? 'BULLISH' : 'BEARISH';

        // Determine if bias was correct
        let biasCorrect = false;
        if (aggregateBias === 'NEUTRAL') {
            biasCorrect = null; // No verdict for neutral
        } else {
            biasCorrect = aggregateBias === actualDirection;
        }

        // Generate AI summary with text analysis insights
        let aiSummary = generateAISummary(entry, dayOrder, aggregateBias, actualDirection, biasCorrect, textAnalysis);

        // Update entry with analysis results
        entry.bias.startPrice = startPrice;
        entry.bias.endPrice = endPrice;
        entry.bias.priceChange = parseFloat(priceChange);
        entry.bias.actualDirection = actualDirection;
        entry.bias.aggregateBias = aggregateBias;
        entry.bias.biasScore = combinedScore.toFixed(2);
        entry.bias.structuredScore = (structuredScore / (structuredWeight || 1)).toFixed(2);
        entry.bias.textSentiment = textSentiment.toFixed(2);
        entry.bias.uncertaintyLevel = textUncertainty.toFixed(2);
        entry.bias.dailyBreakdown = dailyResults.join(' | ');
        entry.bias.verified = biasCorrect;
        entry.bias.aiSummary = aiSummary;
        entry.bias.analyzedAt = new Date().toISOString();

        await saveWeeklyToDb(entry);
        saveData();
        renderWeekly();
        updateBiasSummary();

    } catch (e) {
        console.error('Bias analysis error:', e);
        alert('Error analyzing bias. Please try again.');
    } finally {
        if (analyzeBtn) {
            analyzeBtn.disabled = false;
            analyzeBtn.textContent = 'ANALYZE WEEK';
        }
    }
}

// ========== TEXT ANALYSIS ==========
function analyzeTextSentiment(text) {
    if (!text) return { sentiment: 0, uncertainty: 0, conviction: 0, counterArgs: 0, keywords: [] };

    const lowerText = text.toLowerCase();
    const keywords = [];

    // Bullish keywords
    const bullishWords = ['support', 'bounce', 'breakout', 'bullish', 'long', 'buy', 'upside', 'higher', 'strength',
        'accumulation', 'demand', 'bid', 'floor', 'holding', 'recovery', 'rally', 'pump', 'moon', 'green'];
    // Bearish keywords
    const bearishWords = ['resistance', 'breakdown', 'bearish', 'short', 'sell', 'downside', 'lower', 'weakness',
        'distribution', 'reject', 'rejection', 'supply', 'ceiling', 'dump', 'crash', 'red', 'fade', 'drop'];
    // Uncertainty keywords
    const uncertainWords = ['but', 'however', 'uncertain', 'unsure', 'maybe', 'might', 'could', 'risk', 'worried',
        'concerned', 'hesitant', 'doubt', 'unclear', 'conflicting', 'mixed', 'cautious', 'careful', 'wait', 'possibly'];
    // Conviction keywords
    const convictionWords = ['confident', 'certain', 'clear', 'strong', 'definitely', 'conviction', 'sure', 'expect',
        'will', 'obvious', 'clearly', 'no doubt', 'confirmed', 'valid', 'solid', 'high probability'];
    // Counter-argument indicators
    const counterWords = ['other hand', 'alternatively', 'counter', 'against', 'flip side', 'opposite', 'unless',
        'invalidate', 'if wrong', 'stop out', 'risk is', 'bear case', 'bull case'];

    let bullishCount = 0, bearishCount = 0, uncertainCount = 0, convictionCount = 0, counterCount = 0;

    bullishWords.forEach(w => { if (lowerText.includes(w)) { bullishCount++; keywords.push('+' + w); } });
    bearishWords.forEach(w => { if (lowerText.includes(w)) { bearishCount++; keywords.push('-' + w); } });
    uncertainWords.forEach(w => { if (lowerText.includes(w)) { uncertainCount++; keywords.push('?' + w); } });
    convictionWords.forEach(w => { if (lowerText.includes(w)) { convictionCount++; keywords.push('!' + w); } });
    counterWords.forEach(w => { if (lowerText.includes(w)) { counterCount++; keywords.push('~' + w); } });

    // Calculate scores (-1 to +1 range)
    const totalSentimentWords = bullishCount + bearishCount || 1;
    const sentiment = (bullishCount - bearishCount) / totalSentimentWords; // -1 to +1

    const totalCertaintyWords = uncertainCount + convictionCount || 1;
    const uncertainty = uncertainCount / (uncertainCount + 1); // 0 to ~1
    const conviction = convictionCount / (convictionCount + 1); // 0 to ~1
    const counterArgs = counterCount / (counterCount + 1); // 0 to ~1

    return { sentiment, uncertainty, conviction, counterArgs, keywords, bullishCount, bearishCount, uncertainCount, convictionCount, counterCount };
}

function analyzeWeekText(entry, dayOrder) {
    const bias = entry.bias || {};
    const days = entry.days || {};

    let allText = '';
    let dailyAnalysis = {};

    dayOrder.forEach(day => {
        const dayBias = bias[day] || {};
        const dayData = days[day] || {};
        const journalText = typeof dayData === 'object' ? (dayData.text || '') : (dayData || '');
        const reasoningText = dayBias.reasoning || '';

        const combinedText = reasoningText + ' ' + journalText;
        allText += combinedText + ' ';

        if (combinedText.trim()) {
            dailyAnalysis[day] = analyzeTextSentiment(combinedText);
        }
    });

    const overall = analyzeTextSentiment(allText);
    return { overall, daily: dailyAnalysis };
}

function generateAISummary(entry, dayOrder, aggregateBias, actualDirection, biasCorrect, textAnalysis) {
    const bias = entry.bias;
    let bullishDays = 0, bearishDays = 0, neutralDays = 0;

    dayOrder.forEach(day => {
        const dayBias = bias[day];
        if (dayBias?.direction) {
            if (dayBias.direction === 'BULLISH') bullishDays++;
            else if (dayBias.direction === 'BEARISH') bearishDays++;
            else neutralDays++;
        }
    });

    let summary = `<strong>Weekly Pattern:</strong> ${bullishDays} bullish, ${bearishDays} bearish, ${neutralDays} neutral days. `;

    if (aggregateBias === 'NEUTRAL') {
        summary += `Your bias was mixed/neutral throughout the week. `;
    } else if (biasCorrect) {
        summary += `Your ${aggregateBias.toLowerCase()} bias aligned with the market's ${actualDirection.toLowerCase()} move. `;
    } else {
        summary += `Your ${aggregateBias.toLowerCase()} bias was opposite to the market's ${actualDirection.toLowerCase()} move. `;
    }

    // Text analysis insights
    if (textAnalysis && textAnalysis.overall) {
        const ta = textAnalysis.overall;
        summary += `<br><br><strong>Text Analysis:</strong> `;

        // Sentiment from text
        if (ta.bullishCount > 0 || ta.bearishCount > 0) {
            const textBias = ta.sentiment > 0.2 ? 'bullish' : ta.sentiment < -0.2 ? 'bearish' : 'neutral';
            summary += `Your writing leaned <span style="color:${textBias === 'bullish' ? '#0f0' : textBias === 'bearish' ? '#f00' : '#ff0'}">${textBias}</span> (${ta.bullishCount} bullish, ${ta.bearishCount} bearish keywords). `;

            // Check if text matches stated bias
            if (aggregateBias !== 'NEUTRAL') {
                const textMatchesBias = (aggregateBias === 'BULLISH' && ta.sentiment > 0) || (aggregateBias === 'BEARISH' && ta.sentiment < 0);
                if (!textMatchesBias && Math.abs(ta.sentiment) > 0.1) {
                    summary += `<span style="color:#ff0;">Your text tone didn't match your stated bias - possible internal conflict.</span> `;
                }
            }
        }

        // Uncertainty analysis
        if (ta.uncertainCount >= 2) {
            summary += `<br><span style="color:#ff0;">High uncertainty detected (${ta.uncertainCount} hedging words)</span> - you may have been less confident than your selections indicated. `;
        }

        // Counter-arguments
        if (ta.counterCount >= 1) {
            summary += `You acknowledged ${ta.counterCount} counter-argument(s) - good risk awareness. `;
        }

        // Conviction
        if (ta.convictionCount >= 2) {
            summary += `Strong conviction language detected (${ta.convictionCount} instances). `;
        }
    }

    // Check for bias shifts
    let shifts = 0;
    let lastDir = null;
    dayOrder.forEach(day => {
        const dir = bias[day]?.direction;
        if (dir && lastDir && dir !== lastDir) shifts++;
        if (dir) lastDir = dir;
    });

    if (shifts >= 3) {
        summary += `<br><strong>Note:</strong> You changed bias ${shifts} times this week - consider if you're being reactive to noise.`;
    }

    return summary;
}

async function saveDailyBias(weekId, day, field, value) {
    const entry = allWeeklyEntries.find(e => e.id === weekId);
    if (entry) {
        if (!entry.bias) entry.bias = {};
        if (!entry.bias[day]) entry.bias[day] = {};
        entry.bias[day][field] = value;
        await saveWeeklyToDb(entry);
        saveData();

        // Update bias indicator without full re-render (keeps tabs open)
        const dayBias = entry.bias[day];
        const headerEl = document.querySelector(`#day-${weekId}-${day} .day-header`);
        if (headerEl && dayBias.direction) {
            // Find or create bias indicator span
            let indicator = headerEl.querySelector('.bias-indicator');
            if (!indicator) {
                indicator = document.createElement('span');
                indicator.className = 'bias-indicator';
                indicator.style.marginLeft = '10px';
                headerEl.appendChild(indicator);
            }
            const color = dayBias.direction === 'BULLISH' ? '#0f0' : dayBias.direction === 'BEARISH' ? '#f00' : '#ff0';
            const label = dayBias.direction === 'BULLISH' ? 'BULL' : dayBias.direction === 'BEARISH' ? 'BEAR' : 'NEUT';
            indicator.innerHTML = `<span style="color:${color}">${label}</span>`;
        }
    }
}

async function saveBiasField(weekId, field, value) {
    const entry = allWeeklyEntries.find(e => e.id === weekId);
    if (entry) {
        if (!entry.bias) entry.bias = {};
        entry.bias[field] = value;
        await saveWeeklyToDb(entry);
        saveData();
    }
}

async function enableBiasEdit(weekId) {
    const entry = allWeeklyEntries.find(e => e.id === weekId);
    if (entry && entry.bias) {
        // Clear analysis results but keep daily bias data
        entry.bias.verified = undefined;
        entry.bias.startPrice = undefined;
        entry.bias.endPrice = undefined;
        entry.bias.priceChange = undefined;
        entry.bias.actualDirection = undefined;
        entry.bias.aggregateBias = undefined;
        entry.bias.biasScore = undefined;
        entry.bias.dailyBreakdown = undefined;
        entry.bias.aiSummary = undefined;
        entry.bias.analyzedAt = undefined;

        await saveWeeklyToDb(entry);
        saveData();
        renderWeekly();
        updateBiasSummary();
    }
}

function updateBiasSummary() {
    const container = document.getElementById('biasSummaryContainer');
    if (!container) return;

    const weeklyEntries = getWeeklyEntries();
    const analyzedWeeks = weeklyEntries.filter(e => e.bias?.verified !== undefined && e.bias?.verified !== null);

    if (analyzedWeeks.length === 0) {
        container.innerHTML = '<div style="color:#444;padding:15px;">No analyzed weeks yet. Set daily bias for each day and analyze after the week ends.</div>';
        return;
    }

    // Filter out neutral weeks for accuracy calculation
    const decidedWeeks = analyzedWeeks.filter(e => e.bias.aggregateBias !== 'NEUTRAL');
    const correct = decidedWeeks.filter(e => e.bias.verified === true).length;
    const incorrect = decidedWeeks.filter(e => e.bias.verified === false).length;
    const neutral = analyzedWeeks.filter(e => e.bias.aggregateBias === 'NEUTRAL').length;
    const accuracy = decidedWeeks.length > 0 ? ((correct / decidedWeeks.length) * 100).toFixed(0) : '--';

    let html = `
        <div style="display:flex;gap:20px;margin-bottom:15px;flex-wrap:wrap;">
            <div class="price-box">
                <div class="price-label">ACCURACY</div>
                <div class="price-value" style="color:${accuracy >= 50 ? '#e65c00' : '#555'}">${accuracy}%</div>
            </div>
            <div class="price-box">
                <div class="price-label">CORRECT</div>
                <div class="price-value" style="color:#e65c00">${correct}</div>
            </div>
            <div class="price-box">
                <div class="price-label">INCORRECT</div>
                <div class="price-value" style="color:#555">${incorrect}</div>
            </div>
            <div class="price-box">
                <div class="price-label">NEUTRAL</div>
                <div class="price-value" style="color:#666">${neutral}</div>
            </div>
            <div class="price-box">
                <div class="price-label">TOTAL WEEKS</div>
                <div class="price-value">${analyzedWeeks.length}</div>
            </div>
        </div>
        <div class="bias-summary-grid">
    `;

    analyzedWeeks.slice(0, 8).forEach(entry => {
        const isNeutral = entry.bias.aggregateBias === 'NEUTRAL';
        const resultClass = isNeutral ? 'pending' : (entry.bias.verified ? 'correct' : 'incorrect');
        const priceChangeColor = entry.bias.priceChange >= 0 ? '#e65c00' : '#555';
        const biasColor = entry.bias.aggregateBias === 'BULLISH' ? '#e65c00' : entry.bias.aggregateBias === 'BEARISH' ? '#555' : '#666';

        html += `
            <div class="bias-week-card ${resultClass}">
                <div style="font-weight:500;margin-bottom:8px;">WEEK OF ${entry.weekOf}</div>
                <div>YOUR BIAS: <span style="color:${biasColor};">${entry.bias.aggregateBias}</span></div>
                <div>ACTUAL: <span style="color:${priceChangeColor}">${entry.bias.actualDirection} (${entry.bias.priceChange >= 0 ? '+' : ''}${entry.bias.priceChange}%)</span></div>
                <div style="margin-top:8px;color:${isNeutral ? '#666' : (entry.bias.verified ? '#e65c00' : '#555')};font-weight:500;">
                    ${isNeutral ? 'NEUTRAL' : (entry.bias.verified ? 'CORRECT' : 'INCORRECT')}
                </div>
            </div>
        `;
    });

    html += '</div>';
    container.innerHTML = html;
}

// ========== WEEKLY ==========
function addWeekEntry() {
    // Create calendar picker overlay
    const overlay = document.createElement('div');
    overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);z-index:9998;display:flex;align-items:center;justify-content:center;';

    const picker = document.createElement('div');
    picker.style.cssText = 'background:#000;border:2px solid #fff;padding:20px;text-align:center;';
    picker.innerHTML = `
        <div style="margin-bottom:15px;font-size:14px;font-weight:bold;">SELECT WEEK START DATE</div>
        <input type="date" id="weekDatePicker" style="background:#000;border:1px solid #fff;color:#fff;padding:10px;font-size:14px;font-family:'Courier New',monospace;cursor:pointer;">
        <div style="margin-top:15px;display:flex;gap:10px;justify-content:center;">
            <button onclick="confirmWeekDate()" style="padding:8px 20px;">CREATE</button>
            <button onclick="closeWeekPicker()" class="btn-secondary" style="padding:8px 20px;">CANCEL</button>
        </div>
    `;

    overlay.id = 'weekPickerOverlay';
    overlay.appendChild(picker);
    document.body.appendChild(overlay);

    const dateInput = document.getElementById('weekDatePicker');
    dateInput.focus();
    if (dateInput.showPicker) {
        setTimeout(() => dateInput.showPicker(), 100);
    }
}

async function confirmWeekDate() {
    const dateInput = document.getElementById('weekDatePicker');
    if (!dateInput.value) {
        alert('Please select a date');
        return;
    }

    // Parse date parts to avoid timezone issues
    const [year, month, dayNum] = dateInput.value.split('-').map(Number);
    const selectedDate = new Date(year, month - 1, dayNum);

    // Find the Monday of the selected week
    const dayOfWeek = selectedDate.getDay(); // 0=Sunday, 1=Monday, etc.
    const daysFromMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // Sunday is 6 days after Monday
    const monday = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), selectedDate.getDate() - daysFromMonday);

    // Week starts on Monday
    const weekOf = `${monday.getFullYear()}-${String(monday.getMonth() + 1).padStart(2, '0')}-${String(monday.getDate()).padStart(2, '0')}`;

    // Create all 7 days Monday through Sunday
    const dayNames = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
    const days = {};
    const activeDays = [];

    for (let i = 0; i < 7; i++) {
        const d = new Date(monday.getFullYear(), monday.getMonth(), monday.getDate() + i);
        const dayName = dayNames[i];
        const dateStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
        days[dayName] = { text: '', date: dateStr };
        activeDays.push(dayName);
    }

    const entry = {
        id: Date.now(),
        accountId: currentAccount,
        weekOf: weekOf,
        days: days,
        activeDays: activeDays,
        bias: { ticker: '', direction: '', verified: null, priceChange: null }
    };

    allWeeklyEntries.unshift(entry);
    await saveWeeklyToDb(entry);
    saveData();
    renderWeekly();
    closeWeekPicker();
}

function closeWeekPicker() {
    const overlay = document.getElementById('weekPickerOverlay');
    if (overlay) overlay.remove();
}

function toggleWeeklyDay(weekId, day) {
    const el = document.getElementById(`day-${weekId}-${day}`);
    if (el) el.classList.toggle('open');
}

function toggleWeekAnalysis(weekId) {
    const el = document.getElementById(`analysis-${weekId}`);
    if (el) {
        el.style.display = el.style.display === 'none' ? 'block' : 'none';
    }
}

async function saveWeeklyDay(weekId, day, value) {
    const entry = allWeeklyEntries.find(e => e.id === weekId);
    if (entry) {
        const dayKey = `${weekId}_${day}`;
        const existingImages = pendingDayImages[dayKey] || [];
        // Handle both old format (string) and new format (object with text/date/images)
        if (typeof entry.days[day] === 'object') {
            entry.days[day].text = value;
            entry.days[day].images = existingImages;
        } else {
            entry.days[day] = { text: value, images: existingImages };
        }
        await saveWeeklyToDb(entry);
        saveData();
    }
}

async function deleteWeekEntry(id) {
    if (!confirm('Delete this week?')) return;
    await deleteWeeklyFromDb(id);
    allWeeklyEntries = allWeeklyEntries.filter(w => w.id !== id);
    saveData();
    renderWeekly();
}

function formatDayDate(dateStr) {
    if (!dateStr) return '';
    // Parse date parts manually to avoid timezone issues
    const [year, month, day] = dateStr.split('-').map(Number);
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    return `${months[month - 1]} ${day}`;
}

function renderWeekly() {
    const list = document.getElementById('weeklyList');
    const weeklyEntries = getWeeklyEntries(); // Get entries for current account
    if (weeklyEntries.length === 0) {
        list.innerHTML = '<div style="text-align:center;color:#444;padding:40px;">NO OUTLOOK ENTRIES</div>';
        return;
    }

    const defaultDayOrder = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];

    list.innerHTML = weeklyEntries.map(entry => {
        const bias = entry.bias || {};
        const hasAnalysis = bias.verified !== undefined && bias.verified !== null;
        const resultClass = hasAnalysis ? (bias.verified ? 'correct' : (bias.aggregateBias === 'NEUTRAL' ? 'pending' : 'incorrect')) : 'pending';

        // Use entry's activeDays or fallback to days that exist in entry.days
        const dayOrder = entry.activeDays || Object.keys(entry.days || {}).filter(d => defaultDayOrder.includes(d)).sort((a, b) => defaultDayOrder.indexOf(a) - defaultDayOrder.indexOf(b));

        // Check if any daily bias is set
        const hasDailyBias = dayOrder.some(day => bias[day]?.direction);

        return `
            <div class="form-box">
                <div class="week-header">
                    <h3>WEEK OF: ${entry.weekOf}</h3>
                    <div style="display:flex;gap:10px;align-items:center;">
                        ${hasAnalysis ? `<span class="analysis-icon ${resultClass}" onclick="toggleWeekAnalysis(${entry.id})" title="View Analysis">${bias.verified ? '' : bias.aggregateBias === 'NEUTRAL' ? '' : ''}</span>` : ''}
                        <button class="delete-week-btn" onclick="deleteWeekEntry(${entry.id})">X</button>
                    </div>
                </div>

                ${hasAnalysis ? `
                    <!-- ANALYSIS RESULTS (hidden by default, click icon to show) -->
                    <div class="bias-tracker week-analysis" id="analysis-${entry.id}" style="display:none;">
                        <div class="bias-header">
                            <div class="section-title">BTC BIAS ANALYSIS RESULTS</div>
                        </div>
                        <div class="bias-result ${resultClass}">
                            <div style="font-weight:bold;margin-bottom:10px;font-size:14px;">
                                ${bias.aggregateBias === 'NEUTRAL' ? 'NEUTRAL BIAS - NO VERDICT' : (bias.verified ? 'AGGREGATE BIAS CORRECT' : 'AGGREGATE BIAS INCORRECT')}
                            </div>
                            <div class="price-display">
                                <div class="price-box">
                                    <div class="price-label">START (${bias.startDay || 'MON'})</div>
                                    <div class="price-value">$${bias.startPrice?.toLocaleString() || '--'}</div>
                                </div>
                                <div class="price-box">
                                    <div class="price-label">END (${bias.endDay || 'SUN'})</div>
                                    <div class="price-value">$${bias.endPrice?.toLocaleString() || '--'}</div>
                                </div>
                                <div class="price-box">
                                    <div class="price-label">CHANGE</div>
                                    <div class="price-value" style="color:${bias.priceChange >= 0 ? '#e65c00' : '#555'}">
                                        ${bias.priceChange >= 0 ? '+' : ''}${bias.priceChange}%
                                    </div>
                                </div>
                                <div class="price-box">
                                    <div class="price-label">ACTUAL</div>
                                    <div class="price-value" style="color:${bias.priceChange >= 0 ? '#e65c00' : '#555'}">
                                        ${bias.actualDirection}
                                    </div>
                                </div>
                            </div>
                            <div style="margin-top:15px;padding-top:10px;border-top:1px solid #1a1a1a;">
                                <div style="font-size:11px;margin-bottom:8px;"><strong>YOUR AGGREGATE BIAS:</strong>
                                    <span style="color:${bias.aggregateBias === 'BULLISH' ? '#e65c00' : bias.aggregateBias === 'BEARISH' ? '#555' : '#666'}">${bias.aggregateBias}</span>
                                    (Combined Score: ${bias.biasScore > 0 ? '+' : ''}${bias.biasScore})
                                </div>
                                <div style="display:flex;gap:15px;flex-wrap:wrap;margin:10px 0;">
                                    <div class="price-box" style="min-width:80px;">
                                        <div class="price-label">SELECTION</div>
                                        <div class="price-value" style="font-size:12px;color:${bias.structuredScore > 0 ? '#e65c00' : bias.structuredScore < 0 ? '#555' : '#666'}">
                                            ${bias.structuredScore > 0 ? '+' : ''}${bias.structuredScore || '0'}
                                        </div>
                                    </div>
                                    <div class="price-box" style="min-width:80px;">
                                        <div class="price-label">TEXT TONE</div>
                                        <div class="price-value" style="font-size:12px;color:${bias.textSentiment > 0 ? '#e65c00' : bias.textSentiment < 0 ? '#555' : '#666'}">
                                            ${bias.textSentiment > 0 ? '+' : ''}${bias.textSentiment || '0'}
                                        </div>
                                    </div>
                                    <div class="price-box" style="min-width:80px;">
                                        <div class="price-label">UNCERTAINTY</div>
                                        <div class="price-value" style="font-size:12px;color:${bias.uncertaintyLevel > 0.3 ? '#555' : bias.uncertaintyLevel > 0.15 ? '#666' : '#e65c00'}">
                                            ${(bias.uncertaintyLevel * 100).toFixed(0) || '0'}%
                                        </div>
                                    </div>
                                </div>
                                <div style="font-size:9px;color:#444;margin-bottom:8px;">
                                    Combined = (70% selections + 30% text tone)  slight uncertainty adjustment
                                </div>
                                <div style="font-size:10px;color:#555;">
                                    Daily breakdown: ${bias.dailyBreakdown || '--'}
                                </div>
                            </div>
                            ${bias.aiSummary ? `
                                <div style="margin-top:10px;padding:10px;background:#050505;border:1px solid #1a1a1a;font-size:10px;">
                                    <div style="color:#555;margin-bottom:5px;">AI SUMMARY:</div>
                                    ${bias.aiSummary}
                                </div>
                            ` : ''}
                            <div style="margin-top:15px;padding-top:10px;border-top:1px solid #1a1a1a;display:flex;gap:10px;">
                                <button class="btn-secondary" onclick="enableBiasEdit(${entry.id})" style="font-size:10px;padding:5px 10px;">
                                    EDIT & RE-ANALYZE
                                </button>
                                <span style="font-size:9px;color:#444;line-height:24px;">Edit your daily bias inputs and run analysis again</span>
                            </div>
                        </div>
                    </div>
                ` : `
                    <!-- ANALYZE BUTTON -->
                    <div class="bias-tracker" style="padding:10px 15px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;">
                            <div class="section-title" style="margin:0;">BTC BIAS TRACKER</div>
                            <div>
                                <button id="analyze-btn-${entry.id}" onclick="analyzeBias(${entry.id})"
                                    ${!hasDailyBias ? 'disabled' : ''}>
                                    ANALYZE WEEK
                                </button>
                                <span style="font-size:9px;color:#444;margin-left:10px;">
                                    ${hasDailyBias ? 'Ready to analyze after Sunday' : 'Set daily bias first'}
                                </span>
                            </div>
                        </div>
                    </div>
                `}

                ${dayOrder.map(day => {
                    const dayData = entry.days[day];
                    const isObject = typeof dayData === 'object';
                    const text = isObject ? (dayData?.text || '') : (dayData || '');
                    const date = isObject ? dayData?.date : null;
                    const dayImages = isObject ? (dayData?.images || []) : [];
                    const dateLabel = date ? ` - ${formatDayDate(date)}` : '';
                    const dayBias = bias[day] || {};
                    const biasIndicator = dayBias.direction ?
                        (dayBias.direction === 'BULLISH' ? '<span style="color:#e65c00;margin-left:10px;">BULL</span>' :
                         dayBias.direction === 'BEARISH' ? '<span style="color:#555;margin-left:10px;">BEAR</span>' :
                         '<span style="color:#666;margin-left:10px;">NEUT</span>') : '';
                    const hasImages = dayImages.length > 0;
                    const imageIndicator = hasImages ? `<span style="color:#444;margin-left:10px;">${dayImages.length} img</span>` : '';

                    // Initialize pending images for this day
                    const dayKey = `${entry.id}_${day}`;
                    if (!pendingDayImages[dayKey]) pendingDayImages[dayKey] = [...dayImages];

                    return `
                        <div class="day-toggle" id="day-${entry.id}-${day}">
                            <div class="day-header" onclick="toggleWeeklyDay(${entry.id}, '${day}')">
                                ${day.toUpperCase()}<span style="color:#444;font-weight:normal;margin-left:10px;">${dateLabel}</span>${biasIndicator}${imageIndicator}
                            </div>
                            <div class="day-content">
                                <!-- Daily Bias Fields -->
                                <div style="display:flex;gap:10px;margin-bottom:10px;flex-wrap:wrap;padding:10px;background:#050505;border:1px solid #1a1a1a;">
                                    <div style="flex:0 0 100px;">
                                        <label style="font-size:8px;color:#444;">BIAS</label>
                                        <select onchange="saveDailyBias(${entry.id}, '${day}', 'direction', this.value)"
                                            style="width:100%;" ${hasAnalysis ? 'disabled' : ''}>
                                            <option value="">--</option>
                                            <option value="BULLISH" ${dayBias.direction === 'BULLISH' ? 'selected' : ''}>BULLISH</option>
                                            <option value="NEUTRAL" ${dayBias.direction === 'NEUTRAL' ? 'selected' : ''}>NEUTRAL</option>
                                            <option value="BEARISH" ${dayBias.direction === 'BEARISH' ? 'selected' : ''}>BEARISH</option>
                                        </select>
                                    </div>
                                    <div style="flex:0 0 120px;">
                                        <label style="font-size:8px;color:#444;">CONFIDENCE</label>
                                        <select onchange="saveDailyBias(${entry.id}, '${day}', 'confidence', this.value)"
                                            style="width:100%;" ${hasAnalysis ? 'disabled' : ''}>
                                            <option value="">--</option>
                                            <option value="1" ${dayBias.confidence == '1' ? 'selected' : ''}>1 - LOW</option>
                                            <option value="2" ${dayBias.confidence == '2' ? 'selected' : ''}>2</option>
                                            <option value="3" ${dayBias.confidence == '3' ? 'selected' : ''}>3 - MED</option>
                                            <option value="4" ${dayBias.confidence == '4' ? 'selected' : ''}>4</option>
                                            <option value="5" ${dayBias.confidence == '5' ? 'selected' : ''}>5 - HIGH</option>
                                        </select>
                                    </div>
                                    <div style="flex:1;min-width:200px;">
                                        <label style="font-size:8px;color:#444;">REASONING</label>
                                        <input type="text"
                                            onchange="saveDailyBias(${entry.id}, '${day}', 'reasoning', this.value)"
                                            value="${(dayBias.reasoning || '').replace(/"/g, '&quot;')}"
                                            placeholder="Why this bias today?"
                                            ${hasAnalysis ? 'disabled' : ''}>
                                    </div>
                                </div>
                                <!-- Daily Journal -->
                                <textarea style="width:100%;min-height:100px;"
                                    onchange="saveWeeklyDay(${entry.id}, '${day}', this.value)"
                                    placeholder="Write your ${day} journal entry...">${text}</textarea>
                                <!-- Chart Images -->
                                <div style="margin-top:10px;padding:10px;background:#050505;border:1px solid #1a1a1a;">
                                    <div style="display:flex;gap:10px;align-items:center;margin-bottom:8px;">
                                        <label style="font-size:8px;color:#444;margin:0;">CHART IMAGES</label>
                                        <input type="file" accept="image/*" multiple
                                            onchange="previewDayImages(${entry.id}, '${day}', this)"
                                            style="font-size:10px;max-width:200px;">
                                    </div>
                                    <div id="dayImagePreview-${entry.id}-${day}" style="display:flex;flex-wrap:wrap;gap:10px;">
                                        ${dayImages.map((img, idx) => `
                                            <div style="position:relative;display:inline-block;">
                                                <img src="${img}" style="width:80px;height:80px;object-fit:cover;border:1px solid #333;cursor:pointer;" onclick="openImageViewer(pendingDayImages['${dayKey}'], ${idx})">
                                                <button onclick="event.stopPropagation();removeDayPreview(${entry.id}, '${day}', ${idx})" style="position:absolute;top:2px;right:2px;width:16px;height:16px;border-radius:50%;background:rgba(0,0,0,0.6);color:#888;border:none;cursor:pointer;font-size:10px;padding:0;line-height:16px;"></button>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
        `;
    }).join('');
}

// ========== IMAGE VIEWER ==========
let currentViewerImages = [];
let currentViewerIndex = 0;

function openImageViewer(images, startIndex = 0) {
    if (!images || images.length === 0) return;
    currentViewerImages = Array.isArray(images) ? images : [images];
    currentViewerIndex = startIndex;
    updateViewerImage();
    document.getElementById('imageViewer').style.display = 'block';
    document.body.style.overflow = 'hidden';
}

function closeImageViewer() {
    document.getElementById('imageViewer').style.display = 'none';
    document.body.style.overflow = '';
    currentViewerImages = [];
    currentViewerIndex = 0;
}

function updateViewerImage() {
    document.getElementById('viewerImage').src = currentViewerImages[currentViewerIndex];
    document.getElementById('imageCounter').textContent = `${currentViewerIndex + 1} / ${currentViewerImages.length}`;
}

function viewNextImage() {
    if (currentViewerImages.length > 1) {
        currentViewerIndex = (currentViewerIndex + 1) % currentViewerImages.length;
        updateViewerImage();
    }
}

function viewPrevImage() {
    if (currentViewerImages.length > 1) {
        currentViewerIndex = (currentViewerIndex - 1 + currentViewerImages.length) % currentViewerImages.length;
        updateViewerImage();
    }
}

// Close viewer on Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && document.getElementById('imageViewer').style.display === 'block') {
        closeImageViewer();
    }
    if (e.key === 'ArrowRight') viewNextImage();
    if (e.key === 'ArrowLeft') viewPrevImage();
});

// ========== IMAGE PREVIEW FUNCTIONS ==========
let pendingMissedImages = [];
let pendingTradeImages = [];
let pendingDayImages = {}; // { weekId_day: [images] }

function previewMissedImages(input) {
    const preview = document.getElementById('missedFilePreview');

    if (input.files && input.files.length > 0) {
        Array.from(input.files).forEach(file => {
            const reader = new FileReader();
            reader.onload = function(e) {
                pendingMissedImages.push(e.target.result);
                renderMissedPreview();
            };
            reader.readAsDataURL(file);
        });
    }
    // Clear the input so user can add more files
    input.value = '';
}

function renderMissedPreview() {
    const preview = document.getElementById('missedFilePreview');
    preview.innerHTML = pendingMissedImages.map((img, idx) => `
        <div style="position:relative;display:inline-block;">
            <img src="${img}" style="width:80px;height:80px;object-fit:cover;border:1px solid #333;cursor:pointer;" onclick="openImageViewer(pendingMissedImages, ${idx})">
            <button onclick="removeMissedPreview(${idx})" style="position:absolute;top:2px;right:2px;width:16px;height:16px;border-radius:50%;background:rgba(0,0,0,0.6);color:#888;border:none;cursor:pointer;font-size:10px;padding:0;line-height:16px;"></button>
        </div>
    `).join('');
}

function removeMissedPreview(idx) {
    pendingMissedImages.splice(idx, 1);
    renderMissedPreview();
}

function previewTradeImages(input) {
    if (input.files && input.files.length > 0) {
        Array.from(input.files).forEach(file => {
            const reader = new FileReader();
            reader.onload = function(e) {
                pendingTradeImages.push(e.target.result);
                renderTradePreview();
            };
            reader.readAsDataURL(file);
        });
    }
    input.value = '';
}

function renderTradePreview() {
    const preview = document.getElementById('tradeImagePreview');
    if (!preview) return;
    preview.innerHTML = pendingTradeImages.map((img, idx) => `
        <div style="position:relative;display:inline-block;">
            <img src="${img}" style="width:80px;height:80px;object-fit:cover;border:1px solid #333;cursor:pointer;" onclick="openImageViewer(pendingTradeImages, ${idx})">
            <button onclick="removeTradePreview(${idx})" style="position:absolute;top:2px;right:2px;width:16px;height:16px;border-radius:50%;background:rgba(0,0,0,0.6);color:#888;border:none;cursor:pointer;font-size:10px;padding:0;line-height:16px;"></button>
        </div>
    `).join('');
}

function removeTradePreview(idx) {
    pendingTradeImages.splice(idx, 1);
    renderTradePreview();
}

// ========== DAY IMAGE FUNCTIONS ==========
function previewDayImages(weekId, day, input) {
    const key = `${weekId}_${day}`;
    if (!pendingDayImages[key]) pendingDayImages[key] = [];

    if (input.files && input.files.length > 0) {
        Array.from(input.files).forEach(file => {
            const reader = new FileReader();
            reader.onload = function(e) {
                pendingDayImages[key].push(e.target.result);
                renderDayPreview(weekId, day);
                saveDayImages(weekId, day);
            };
            reader.readAsDataURL(file);
        });
    }
    input.value = '';
}

function renderDayPreview(weekId, day) {
    const key = `${weekId}_${day}`;
    const preview = document.getElementById(`dayImagePreview-${weekId}-${day}`);
    if (!preview) return;

    const images = pendingDayImages[key] || [];
    preview.innerHTML = images.map((img, idx) => `
        <div style="position:relative;display:inline-block;">
            <img src="${img}" style="width:80px;height:80px;object-fit:cover;border:1px solid #333;cursor:pointer;" onclick="openImageViewer(pendingDayImages['${key}'], ${idx})">
            <button onclick="event.stopPropagation();removeDayPreview(${weekId}, '${day}', ${idx})" style="position:absolute;top:2px;right:2px;width:16px;height:16px;border-radius:50%;background:rgba(0,0,0,0.6);color:#888;border:none;cursor:pointer;font-size:10px;padding:0;line-height:16px;"></button>
        </div>
    `).join('');
}

function removeDayPreview(weekId, day, idx) {
    const key = `${weekId}_${day}`;
    if (pendingDayImages[key]) {
        pendingDayImages[key].splice(idx, 1);
        renderDayPreview(weekId, day);
        saveDayImages(weekId, day);
    }
}

async function saveDayImages(weekId, day) {
    const entry = allWeeklyEntries.find(e => e.id === weekId);
    if (entry) {
        const key = `${weekId}_${day}`;
        if (typeof entry.days[day] === 'object') {
            entry.days[day].images = pendingDayImages[key] || [];
        } else {
            entry.days[day] = { text: entry.days[day] || '', images: pendingDayImages[key] || [] };
        }
        await saveWeeklyToDb(entry);
        saveData();
    }
}

function loadDayImages(weekId, day, images) {
    const key = `${weekId}_${day}`;
    pendingDayImages[key] = images || [];
    renderDayPreview(weekId, day);
}

// ========== MISSED OPPORTUNITIES ==========
function showMissedModal() {
    document.getElementById('missedModal').style.display = 'flex';
    document.getElementById('missedDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('editMissedId').value = '';
    pendingMissedImages = [];
    renderMissedPreview();
}

function closeMissedModal() {
    document.getElementById('missedModal').style.display = 'none';
    document.getElementById('editMissedId').value = '';
    document.getElementById('missedDate').value = '';
    document.getElementById('missedTicker').value = '';
    document.getElementById('missedDirection').value = '';
    document.getElementById('missedPnl').value = '';
    document.getElementById('missedFile').value = '';
    document.getElementById('missedNote').value = '';
    pendingMissedImages = [];
    document.getElementById('missedFilePreview').innerHTML = '';
}

function editMissedTrade(id) {
    const missed = allMissedTrades.find(m => m.id === id);
    if (!missed) return;

    document.getElementById('editMissedId').value = missed.id;
    document.getElementById('missedDate').value = missed.date || '';
    document.getElementById('missedTicker').value = missed.ticker || '';
    document.getElementById('missedDirection').value = missed.direction || '';
    document.getElementById('missedPnl').value = missed.potentialPnl || '';
    document.getElementById('missedNote').value = missed.note || '';

    // Load existing images
    pendingMissedImages = [...(missed.images || [])];
    renderMissedPreview();

    document.getElementById('missedModal').style.display = 'flex';
}

async function saveMissedTrade() {
    const editId = document.getElementById('editMissedId').value;
    const date = document.getElementById('missedDate').value;
    const ticker = document.getElementById('missedTicker').value.toUpperCase();
    const direction = document.getElementById('missedDirection').value;
    const pnl = parseFloat(document.getElementById('missedPnl').value) || 0;
    const note = document.getElementById('missedNote').value;

    if (!date || !ticker || !direction) {
        alert('Please fill in Date, Ticker, and Direction');
        return;
    }

    if (editId) {
        // Update existing
        const idx = allMissedTrades.findIndex(m => m.id === parseInt(editId));
        if (idx !== -1) {
            allMissedTrades[idx] = {
                ...allMissedTrades[idx],
                date: date,
                ticker: ticker,
                direction: direction,
                potentialPnl: pnl,
                note: note,
                images: pendingMissedImages.length > 0 ? pendingMissedImages : []
            };
            await saveMissedToDb(allMissedTrades[idx]);
        }
    } else {
        // Create new
        const missed = {
            id: Date.now(),
            accountId: currentAccount, // Associate with current account
            date: date,
            ticker: ticker,
            direction: direction,
            potentialPnl: pnl,
            note: note,
            images: pendingMissedImages.length > 0 ? pendingMissedImages : [],
            createdAt: new Date().toISOString()
        };
        allMissedTrades.unshift(missed);
        await saveMissedToDb(missed);
    }

    saveData();
    renderMissedList();
    updateExecutionTracker();
    closeMissedModal();
}

function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });
}

async function saveMissedToDb(missed) {
    if (!useSupabase || !supabaseClient) return;
    try {
        const row = {
            id: missed.id,
            account_id: missed.accountId || currentAccount,
            date: missed.date,
            ticker: missed.ticker,
            direction: missed.direction,
            potential_pnl: missed.potentialPnl,
            note: missed.note,
            images: missed.images || [],
            created_at: missed.createdAt
        };
        await supabaseClient.from('missed_trades').upsert(row);
    } catch (e) {
        // RLS may block this - that's fine, localStorage has the data
    }
}

async function deleteMissedTrade(id) {
    if (!confirm('Delete this missed trade?')) return;

    if (useSupabase && supabaseClient) {
        try {
            await supabaseClient.from('missed_trades').delete().eq('id', id);
        } catch (e) {
            // RLS may block this - that's fine
        }
    }

    allMissedTrades = allMissedTrades.filter(m => m.id !== id);
    saveData();
    renderMissedList();
    updateExecutionTracker();
}

function renderMissedList() {
    const list = document.getElementById('missedList');
    const missedTrades = getMissedTrades(); // Get trades for current account
    if (!list) return;

    if (missedTrades.length === 0) {
        list.innerHTML = '<div style="text-align:center;color:#444;padding:40px;">NO MISSED TRADES LOGGED</div>';
        return;
    }

    list.innerHTML = `<div style="display:grid;grid-template-columns:repeat(auto-fill, minmax(300px, 1fr));gap:15px;">${missedTrades.map(m => {
        const pnlColor = m.potentialPnl >= 0 ? '#e65c00' : '#555';
        const dirColor = m.direction === 'LONG' ? '#e65c00' : '#555';

        // Handle both old format (single imageUrl) and new format (images array)
        const images = m.images || (m.imageUrl ? [m.imageUrl] : []);

        // Store in cache for safe onclick reference
        const cacheKey = 'missed_' + m.id;
        imageViewerCache[cacheKey] = images;

        return `
            <div class="trade-card" id="missed-card-${m.id}" onclick="toggleMissedCard(${m.id})" style="border-left:3px solid #444;max-width:420px;">
                <div class="trade-header">
                    <span class="trade-ticker">${m.ticker}</span>
                    <span style="color:${pnlColor};">
                        $${m.potentialPnl >= 0 ? '+' : ''}${m.potentialPnl.toFixed(0)}
                    </span>
                </div>
                <div class="trade-meta">
                    <span style="color:${dirColor};">${m.direction}</span>
                    <span>${formatDayDate(m.date)}</span>
                    ${images.length > 0 ? `<span>${images.length} img</span>` : ''}
                </div>
                <div class="trade-details">
                    ${m.note ? `<div class="detail-row"><span class="detail-label">NOTE:</span> <span class="detail-value">${m.note}</span></div>` : ''}
                    <div class="detail-row"><span class="detail-label">DATE:</span> <span class="detail-value">${m.date}</span></div>
                    <div class="detail-row"><span class="detail-label">POTENTIAL P/L:</span> <span class="detail-value" style="color:${pnlColor};">$${m.potentialPnl >= 0 ? '+' : ''}${m.potentialPnl.toFixed(0)}</span></div>
                    ${images.length > 0 ? `
                        <div class="detail-row" style="margin-top:10px;">
                            <span class="detail-label">SCREENSHOTS:</span>
                            <div style="display:flex;flex-wrap:wrap;gap:10px;margin-top:5px;">
                                ${images.map((img, idx) => `
                                    <img src="${img}" style="width:80px;height:80px;object-fit:cover;border:1px solid #1a1a1a;cursor:pointer;" onclick="event.stopPropagation();openImageViewer(imageViewerCache['${cacheKey}'], ${idx})">
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    <div style="margin-top:10px;display:flex;gap:10px;">
                        <button onclick="event.stopPropagation();editMissedTrade(${m.id})">EDIT</button>
                        <button class="btn-danger" onclick="event.stopPropagation();deleteMissedTrade(${m.id})">DELETE</button>
                    </div>
                </div>
            </div>
        `;
    }).join('')}</div>`;
}

function toggleMissedCard(id) {
    const card = document.getElementById('missed-card-' + id);
    if (card) {
        card.classList.toggle('expanded');
    }
}

function updateExecutionTracker() {
    const container = document.getElementById('executionTrackerContainer');
    if (!container) return;

    const missedTrades = getMissedTrades(); // Get trades for current account
    const totalTrades = trades.length;
    const totalMissed = missedTrades.length;
    const totalOpportunities = totalTrades + totalMissed;

    const executionRate = totalOpportunities > 0 ? ((totalTrades / totalOpportunities) * 100).toFixed(0) : '--';
    const missedPnl = missedTrades.reduce((sum, m) => sum + (m.potentialPnl || 0), 0);

    if (totalMissed === 0) {
        container.innerHTML = '<div style="color:#444;padding:15px;">No missed trades logged. Track missed opportunities to improve execution.</div>';
        return;
    }

    // Count missed by reason/ticker
    const tickerCounts = {};
    missedTrades.forEach(m => {
        tickerCounts[m.ticker] = (tickerCounts[m.ticker] || 0) + 1;
    });

    const topMissedTicker = Object.entries(tickerCounts).sort((a, b) => b[1] - a[1])[0];

    container.innerHTML = `
        <div style="display:flex;gap:20px;margin-bottom:15px;flex-wrap:wrap;">
            <div class="price-box">
                <div class="price-label">EXECUTION RATE</div>
                <div class="price-value" style="color:${executionRate >= 70 ? '#e65c00' : executionRate >= 50 ? '#666' : '#444'}">${executionRate}%</div>
            </div>
            <div class="price-box">
                <div class="price-label">TRADES TAKEN</div>
                <div class="price-value" style="color:#e65c00">${totalTrades}</div>
            </div>
            <div class="price-box">
                <div class="price-label">MISSED</div>
                <div class="price-value" style="color:#555">${totalMissed}</div>
            </div>
            <div class="price-box">
                <div class="price-label">MISSED P/L</div>
                <div class="price-value" style="color:${missedPnl >= 0 ? '#e65c00' : '#555'}">$${missedPnl >= 0 ? '+' : ''}${missedPnl.toFixed(0)}</div>
            </div>
        </div>
        ${topMissedTicker ? `<div style="font-size:11px;color:#555;">Most missed ticker: <span style="color:#e0e0e0;">${topMissedTicker[0]}</span> (${topMissedTicker[1]} times)</div>` : ''}
    `;
}

// ========== RESIZE ==========
window.addEventListener('resize', () => {
    const filtered = filterTrades();
    drawChart(filtered);
});

// ========== START ==========
// ========== START ==========
(function startTerminal(){
    function runOnce(){
        if (window.__terminal_inited) return;
        window.__terminal_inited = true;
        if (typeof init === 'function') init();
        else console.error('init() not found');
    }
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', runOnce);
    } else {
        runOnce();
    }
})();
</script>
</body>
</html>
